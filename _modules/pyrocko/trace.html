

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyrocko.trace &mdash; Pyrocko v0.2 Manual</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Pyrocko v0.2 Manual"
          href="../../_static/opensearch.xml"/>
    <link rel="top" title="Pyrocko v0.2 Manual" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Pyrocko v0.2 Manual</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <h1>Source code for pyrocko.trace</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;This module provides basic signal processing for seismic traces.</span>


<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">util</span><span class="o">,</span> <span class="nn">evalresp</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">num</span>
<span class="kn">from</span> <span class="nn">util</span> <span class="kn">import</span> <span class="n">reuse</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="kn">import</span> <span class="n">model</span>
<span class="kn">from</span> <span class="nn">nano</span> <span class="kn">import</span> <span class="n">asnano</span><span class="p">,</span> <span class="n">Nano</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;pyrocko.trace&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Trace"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace">[docs]</a><span class="k">class</span> <span class="nc">Trace</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39;Create new trace object.</span>

<span class="sd">    A ``Trace`` object represents a single continuous strip of evenly sampled</span>
<span class="sd">    time series data.  It is built from a 1D NumPy array containing the data</span>
<span class="sd">    samples and some attributes describing its beginning  and ending time, its</span>
<span class="sd">    sampling rate and four string identifiers (its network, station, location</span>
<span class="sd">    and channel code).</span>

<span class="sd">    :param network:  network code</span>
<span class="sd">    :param station:  station code</span>
<span class="sd">    :param location:  location code</span>
<span class="sd">    :param channel:  channel code</span>
<span class="sd">    :param tmin:  system time of first sample in [s]</span>
<span class="sd">    :param tmax:  system time of last sample in [s] (if set to ``None`` it is computed from length of *ydata*)</span>
<span class="sd">    :param deltat:  sampling interval in [s]</span>
<span class="sd">    :param ydata:  1D numpy array with data samples (can be ``None`` when *tmax* is not ``None``)</span>
<span class="sd">    :param mtime:  optional modification time </span>
<span class="sd">    :param meta:  additional meta information (not used, but maintained by the library)</span>

<span class="sd">    The length of the network, station, location and channel codes is not resricted by this software,</span>
<span class="sd">    but data formats like SAC, Mini-SEED or GSE have different limits on the lengths of these codes. The codes set here</span>
<span class="sd">    are silently truncated when the trace is stored</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">cached_frequencies</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="s">&#39;STA&#39;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> 
                 <span class="n">tmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">deltat</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mtime</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">deltat</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
            <span class="n">tmin</span> <span class="o">=</span> <span class="n">asnano</span><span class="p">(</span><span class="n">tmin</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">tmax</span> <span class="o">=</span> <span class="n">asnano</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>

    
        <span class="k">if</span> <span class="n">mtime</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="p">[</span><span class="n">reuse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">network</span><span class="p">,</span><span class="n">station</span><span class="p">,</span><span class="n">location</span><span class="p">,</span><span class="n">channel</span><span class="p">)]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="n">tmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">=</span> <span class="n">deltat</span>
        
        <span class="k">if</span> <span class="n">tmax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ydata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;fixme: trace must be created with tmax or ydata&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">tmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">meta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">ydata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtime</span> <span class="o">=</span> <span class="n">mtime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">)))))</span>
        
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;Trace (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nslc_id</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;  timerange: </span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">fmt</span><span class="p">),</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">fmt</span><span class="p">))</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;  delta t: </span><span class="si">%g</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;  </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">s</span>
        
<div class="viewcode-block" id="Trace.name"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.name">[docs]</a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get a short string description.&#39;&#39;&#39;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nslc_id</span> <span class="o">+</span> <span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">),</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">s</span>
        </div>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">network</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">station</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">station</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">location</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">channel</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">deltat</span> <span class="ow">and</span>
                <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">-</span><span class="n">other</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.001</span> <span class="ow">and</span>
                <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="n">other</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.001</span> <span class="ow">and</span>
                <span class="n">num</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">ydata</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="nb">round</span><span class="p">):</span>
        <span class="n">it</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">snap</span><span class="p">((</span><span class="n">t</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">clip</span><span class="p">:</span>
            <span class="n">it</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">it</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">it</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">()</span>
                       
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="n">it</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
    
<div class="viewcode-block" id="Trace.interpolate"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.interpolate">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Value of trace between supporting points through linear interpolation.</span>
<span class="sd">        </span>
<span class="sd">        :param t: time instant</span>
<span class="sd">        :param clip: whether to clip indices to trace ends</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">)</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">t1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y0</span><span class="o">+</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="Trace.index_clip"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.index_clip">[docs]</a>    <span class="k">def</span> <span class="nf">index_clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Clip index to valid range.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        </div>
<div class="viewcode-block" id="Trace.add"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add values of other trace (self += other).</span>
<span class="sd">        </span>
<span class="sd">        Add values of *other* trace to the values of *self*, where it</span>
<span class="sd">        intersects with *other*.  This method does not change the extent of</span>
<span class="sd">        *self*. If *interpolate* is ``True`` (the default), the values of</span>
<span class="sd">        *other* to be added are interpolated at sampling instants of *self*.</span>
<span class="sd">        Linear interpolation is performed. In this case the sampling rate of</span>
<span class="sd">        *other* must be equal to or lower than that of *self*.  If</span>
<span class="sd">        *interpolate* is ``False``, the sampling rates of the two traces must</span>
<span class="sd">        match.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="k">if</span> <span class="n">interpolate</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">&lt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">deltat</span> <span class="ow">or</span> <span class="n">same_sampling_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">)</span>
            <span class="n">other_xdata</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">other_xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">other_xdata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">+=</span> <span class="n">num</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">other_xdata</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">deltat</span>
            <span class="n">ibeg1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">other</span><span class="o">.</span><span class="n">tmin</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span>
            <span class="n">ibeg2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">-</span><span class="n">other</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span>
            <span class="n">iend1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">other</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">iend2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="n">other</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
            
            <span class="n">ibeg1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_clip</span><span class="p">(</span><span class="n">ibeg1</span><span class="p">)</span>
            <span class="n">iend1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_clip</span><span class="p">(</span><span class="n">iend1</span><span class="p">)</span>
            <span class="n">ibeg2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_clip</span><span class="p">(</span><span class="n">ibeg2</span><span class="p">)</span>
            <span class="n">iend2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_clip</span><span class="p">(</span><span class="n">iend2</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">ibeg1</span><span class="p">:</span><span class="n">iend1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">ibeg2</span><span class="p">:</span><span class="n">iend2</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Trace.mult"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.mult">[docs]</a>    <span class="k">def</span> <span class="nf">mult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Muliply with values of other trace (self \*= other).</span>
<span class="sd">        </span>
<span class="sd">        Multiply values of *other* trace to the values of *self*, where it</span>
<span class="sd">        intersects with *other*.  This method does not change the extent of</span>
<span class="sd">        *self*. If *interpolate* is ``True`` (the default), the values of</span>
<span class="sd">        *other* to be multiplied are interpolated at sampling instants of *self*.</span>
<span class="sd">        Linear interpolation is performed. In this case the sampling rate of</span>
<span class="sd">        *other* must be equal to or lower than that of *self*.  If</span>
<span class="sd">        *interpolate* is ``False``, the sampling rates of the two traces must</span>
<span class="sd">        match.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">interpolate</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">&lt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">deltat</span> <span class="ow">or</span> <span class="n">same_sampling_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">)</span>
            <span class="n">other_xdata</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">other_xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">other_xdata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">*=</span> <span class="n">num</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">other_xdata</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">deltat</span>
            <span class="n">ibeg1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">other</span><span class="o">.</span><span class="n">tmin</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span>
            <span class="n">ibeg2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">-</span><span class="n">other</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span>
            <span class="n">iend1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">other</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">iend2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="n">other</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
            
            <span class="n">ibeg1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_clip</span><span class="p">(</span><span class="n">ibeg1</span><span class="p">)</span>
            <span class="n">iend1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_clip</span><span class="p">(</span><span class="n">iend1</span><span class="p">)</span>
            <span class="n">ibeg2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_clip</span><span class="p">(</span><span class="n">ibeg2</span><span class="p">)</span>
            <span class="n">iend2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_clip</span><span class="p">(</span><span class="n">iend2</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">ibeg1</span><span class="p">:</span><span class="n">iend1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">other</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">ibeg2</span><span class="p">:</span><span class="n">iend2</span><span class="p">]</span>
    </div>
<div class="viewcode-block" id="Trace.max"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.max">[docs]</a>    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get time and value of data maximum.&#39;&#39;&#39;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Trace.min"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.min">[docs]</a>    <span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get time and value of data minimum.&#39;&#39;&#39;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Trace.absmax"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.absmax">[docs]</a>    <span class="k">def</span> <span class="nf">absmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get time and value of maximum of the absolute of data.&#39;&#39;&#39;</span>
        <span class="n">tmi</span><span class="p">,</span> <span class="n">mi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">tma</span><span class="p">,</span> <span class="n">ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ma</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tmi</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tma</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ma</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Trace.set_codes"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.set_codes">[docs]</a>    <span class="k">def</span> <span class="nf">set_codes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Set network, station, location, and channel codes.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">network</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">network</span>
        <span class="k">if</span> <span class="n">station</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">station</span> <span class="o">=</span> <span class="n">station</span>
        <span class="k">if</span> <span class="n">location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Trace.set_network"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.set_network">[docs]</a>    <span class="k">def</span> <span class="nf">set_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Trace.set_station"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.set_station">[docs]</a>    <span class="k">def</span> <span class="nf">set_station</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">station</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">station</span> <span class="o">=</span> <span class="n">station</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Trace.set_location"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.set_location">[docs]</a>    <span class="k">def</span> <span class="nf">set_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Trace.set_channel"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.set_channel">[docs]</a>    <span class="k">def</span> <span class="nf">set_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Trace.overlaps"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.overlaps">[docs]</a>    <span class="k">def</span> <span class="nf">overlaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Check if trace has overlap with a given time span.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="n">tmax</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">&lt;</span> <span class="n">tmin</span><span class="p">)</span>
           </div>
<div class="viewcode-block" id="Trace.is_relevant"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.is_relevant">[docs]</a>    <span class="k">def</span> <span class="nf">is_relevant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Check if trace has overlap with a given time span and matches a condition callback. (internal use)&#39;&#39;&#39;</span>
        <span class="k">return</span>  <span class="ow">not</span> <span class="p">(</span><span class="n">tmax</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">&lt;</span> <span class="n">tmin</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">selector</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">selector</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_update_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update dependent ids.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_id</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nslc_id</span> <span class="o">=</span> <span class="n">reuse</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">))</span>

<div class="viewcode-block" id="Trace.set_mtime"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.set_mtime">[docs]</a>    <span class="k">def</span> <span class="nf">set_mtime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mtime</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Set modification time of the trace.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtime</span> <span class="o">=</span> <span class="n">mtime</span>
</div>
<div class="viewcode-block" id="Trace.get_xdata"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.get_xdata">[docs]</a>    <span class="k">def</span> <span class="nf">get_xdata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create array for time axis.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">raise</span> <span class="n">NoData</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
</div>
<div class="viewcode-block" id="Trace.get_ydata"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.get_ydata">[docs]</a>    <span class="k">def</span> <span class="nf">get_ydata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get data array.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">raise</span> <span class="n">NoData</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
        </div>
<div class="viewcode-block" id="Trace.set_ydata"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.set_ydata">[docs]</a>    <span class="k">def</span> <span class="nf">set_ydata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_ydata</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Replace data array.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">new_ydata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
</div>
<div class="viewcode-block" id="Trace.data_len"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.data_len">[docs]</a>    <span class="k">def</span> <span class="nf">data_len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="Trace.drop_data"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.drop_data">[docs]</a>    <span class="k">def</span> <span class="nf">drop_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Forget data, make dataless trace.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="bp">None</span>
   </div>
<div class="viewcode-block" id="Trace.drop_growbuffer"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.drop_growbuffer">[docs]</a>    <span class="k">def</span> <span class="nf">drop_growbuffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Detach the traces grow buffer.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Trace.copy"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Make a deep copy of the trace.&#39;&#39;&#39;</span>
        <span class="n">tracecopy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">tracecopy</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tracecopy</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tracecopy</span>
    </div>
<div class="viewcode-block" id="Trace.crop_zeros"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.crop_zeros">[docs]</a>    <span class="k">def</span> <span class="nf">crop_zeros</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Remove any zeros at beginning and end.&#39;&#39;&#39;</span>
        
        <span class="n">indices</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">indices</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoData</span><span class="p">()</span>
        
        <span class="n">ibeg</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">iend</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">ibeg</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">iend</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="c"># nothing to do</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">ibeg</span><span class="p">:</span><span class="n">iend</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="n">ibeg</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
    </div>
<div class="viewcode-block" id="Trace.append"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Append data to the end of the trace.</span>
<span class="sd">        </span>
<span class="sd">        To make this method efficient when successively very few or even single samples are appended,</span>
<span class="sd">        a larger grow buffer is allocated upon first invocation. The traces data is then changed to</span>
<span class="sd">        be a view into the currently filled portion of the grow buffer array.&#39;&#39;&#39;</span>
        
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">newlen</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">newlen</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">newlen</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="p">:</span><span class="n">newlen</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span><span class="p">[:</span><span class="n">newlen</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">newlen</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        </div>
<div class="viewcode-block" id="Trace.chop"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.chop">[docs]</a>    <span class="k">def</span> <span class="nf">chop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">include_last</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="p">(</span><span class="nb">round</span><span class="p">,</span><span class="nb">round</span><span class="p">),</span> <span class="n">want_incomplete</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Cut the trace to given time span.</span>

<span class="sd">        If the *inplace* argument is True (the default) the trace is cut in</span>
<span class="sd">        place, otherwise a new trace with the cut part is returned.  By</span>
<span class="sd">        default, the indices where to start and end the trace data array are</span>
<span class="sd">        determined by rounding of *tmin* and *tmax* to sampling instances using</span>
<span class="sd">        Python&#39;s :py:func:`round` function. This behaviour can be changed with</span>
<span class="sd">        the *snap* argument, which takes a tuple of two functions (one for the</span>
<span class="sd">        lower and one for the upper end) to be used instead of</span>
<span class="sd">        :py:func:`round`.  The last sample is by default not included unless</span>
<span class="sd">        *include_last* is set to True.  If the given time span exceeds the</span>
<span class="sd">        available time span of the trace, the available part is returned,</span>
<span class="sd">        unless *want_incomplete* is set to False - in that case, a</span>
<span class="sd">        :py:exc:`NoData` exception is raised. This exception is always</span>
<span class="sd">        raised, when the requested time span does dot overlap with the trace&#39;s</span>
<span class="sd">        time span.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="k">if</span> <span class="n">want_incomplete</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tmax</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">&lt;</span> <span class="n">tmin</span><span class="p">:</span> 
                <span class="k">raise</span> <span class="n">NoData</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tmin</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">&lt;</span> <span class="n">tmax</span><span class="p">:</span> 
                <span class="k">raise</span> <span class="n">NoData</span><span class="p">()</span>
        
        <span class="n">ibeg</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t2ind</span><span class="p">(</span><span class="n">tmin</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="n">snap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">iplus</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">include_last</span><span class="p">:</span> <span class="n">iplus</span><span class="o">=</span><span class="mi">1</span>

        <span class="n">iend</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_len</span><span class="p">(),</span> <span class="n">t2ind</span><span class="p">(</span><span class="n">tmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="n">snap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">iplus</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ibeg</span> <span class="o">&gt;=</span> <span class="n">iend</span><span class="p">:</span> <span class="k">raise</span> <span class="n">NoData</span><span class="p">()</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
       
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">ibeg</span><span class="p">:</span><span class="n">iend</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="n">obj</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="n">ibeg</span><span class="o">*</span><span class="n">obj</span><span class="o">.</span><span class="n">deltat</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="p">((</span><span class="n">iend</span><span class="o">-</span><span class="n">ibeg</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">obj</span><span class="o">.</span><span class="n">deltat</span>
            
        <span class="n">obj</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
    
        
        <span class="k">return</span> <span class="n">obj</span>
    </div>
<div class="viewcode-block" id="Trace.downsample"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.downsample">[docs]</a>    <span class="k">def</span> <span class="nf">downsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndecimate</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">initials</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">demean</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Downsample trace by a given integer factor.</span>
<span class="sd">        </span>
<span class="sd">        :param ndecimate: decimation factor, avoid values larger than 8</span>
<span class="sd">        :param snap: whether to put the new sampling instances closest to multiples of the sampling rate.</span>
<span class="sd">        :param initials: ``None``, ``True``, or initial conditions for the anti-aliasing filter, obtained from a</span>
<span class="sd">            previous run. In the latter two cases the final state of the filter is returned instead of ``None``.</span>
<span class="sd">        :param demean: whether to demean the signal before filtering.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">newdeltat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="n">ndecimate</span>
        <span class="k">if</span> <span class="n">snap</span><span class="p">:</span>
            <span class="n">ilag</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">/</span> <span class="n">newdeltat</span><span class="p">)</span> <span class="o">*</span> <span class="n">newdeltat</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
            
        <span class="k">if</span> <span class="n">snap</span> <span class="ow">and</span> <span class="n">ilag</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ilag</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+=</span> <span class="n">ilag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">demean</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">-=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ndecimate</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s">&#39;fir&#39;</span><span class="p">,</span> <span class="n">zi</span><span class="o">=</span><span class="n">initials</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">initials</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">finals</span> <span class="o">=</span> <span class="n">result</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">finals</span> <span class="o">=</span> <span class="n">result</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">=</span> <span class="n">reuse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="n">ndecimate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">finals</span>
        </div>
<div class="viewcode-block" id="Trace.downsample_to"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.downsample_to">[docs]</a>    <span class="k">def</span> <span class="nf">downsample_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deltat</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">allow_upsample_max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">initials</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">demean</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Downsample to given sampling rate.</span>

<span class="sd">        Tries to downsample the trace to a target sampling interval of</span>
<span class="sd">        *deltat*. This runs the :py:meth:`Trace.downsample` one or several times. If</span>
<span class="sd">        allow_upsample_max is set to a value larger than 1, intermediate</span>
<span class="sd">        upsampling steps are allowed, in order to increase the number of</span>
<span class="sd">        possible downsampling ratios.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">ratio</span> <span class="o">=</span> <span class="n">deltat</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="n">rratio</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rratio</span> <span class="o">-</span> <span class="n">ratio</span><span class="p">)</span><span class="o">/</span><span class="n">ratio</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">allow_upsample_max</span> <span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">util</span><span class="o">.</span><span class="n">UnavailableDecimation</span><span class="p">(</span><span class="s">&#39;ratio = </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">ratio</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">deltat_inter</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">util</span><span class="o">.</span><span class="n">lcm</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span><span class="mf">1.</span><span class="o">/</span><span class="n">deltat</span><span class="p">)</span>
                <span class="n">upsratio</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">/</span><span class="n">deltat_inter</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">upsratio</span> <span class="o">&gt;</span> <span class="n">allow_upsample_max</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">util</span><span class="o">.</span><span class="n">UnavailableDecimation</span><span class="p">(</span><span class="s">&#39;ratio = </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">ratio</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">upsratio</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
                    <span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="n">upsratio</span><span class="o">-</span><span class="p">(</span><span class="n">upsratio</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">ydata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[::</span><span class="n">upsratio</span><span class="p">]</span> <span class="o">=</span> <span class="n">ydata</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">upsratio</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">upsratio</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">upsratio</span> <span class="o">*</span> <span class="n">ydata</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">upsratio</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">upsratio</span> <span class="o">*</span> <span class="n">ydata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">/</span><span class="n">upsratio</span>
                
                    <span class="n">ratio</span> <span class="o">=</span> <span class="n">deltat</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
                    <span class="n">rratio</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
            
        <span class="n">deci_seq</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">decitab</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rratio</span><span class="p">))</span>
        <span class="n">finals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ndecimate</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">deci_seq</span><span class="p">):</span>
             <span class="k">if</span> <span class="n">ndecimate</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                 <span class="n">xinitials</span> <span class="o">=</span> <span class="bp">None</span>
                 <span class="k">if</span> <span class="n">initials</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                     <span class="n">xinitials</span> <span class="o">=</span> <span class="n">initials</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                 <span class="n">finals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">ndecimate</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="n">snap</span><span class="p">,</span> <span class="n">initials</span><span class="o">=</span><span class="n">xinitials</span><span class="p">,</span> <span class="n">demean</span><span class="o">=</span><span class="n">demean</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">initials</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">finals</span>
</div>
<div class="viewcode-block" id="Trace.resample"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.resample">[docs]</a>    <span class="k">def</span> <span class="nf">resample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deltat</span><span class="p">):</span>

        <span class="n">ndata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span>
        <span class="n">ntrans</span> <span class="o">=</span> <span class="n">nextpow2</span><span class="p">(</span><span class="n">ndata</span><span class="p">)</span>
        <span class="n">fntrans2</span> <span class="o">=</span> <span class="n">ntrans</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">/</span><span class="n">deltat</span>
        <span class="n">ntrans2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">fntrans2</span><span class="p">))</span>
        <span class="n">deltat2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">ntrans</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ntrans2</span><span class="p">)</span>
        <span class="n">ndata2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">ndata</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">/</span><span class="n">deltat2</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fntrans2</span> <span class="o">-</span> <span class="n">ntrans2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-7</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;resample: requested deltat </span><span class="si">%g</span><span class="s"> could not be matched exactly: </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">deltat</span><span class="p">,</span> <span class="n">deltat2</span><span class="p">))</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
        <span class="n">data_pad</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntrans</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">data_pad</span><span class="p">[:</span><span class="n">ndata</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data</span>
        <span class="n">fdata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">data_pad</span><span class="p">)</span>
        <span class="n">fdata2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntrans2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">fdata</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="n">fdata2</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">fdata2</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdata</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        <span class="n">data2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">fdata2</span><span class="p">)</span>
        <span class="n">data2</span> <span class="o">=</span> <span class="n">data2</span><span class="p">[:</span><span class="n">ndata2</span><span class="p">]</span>
        <span class="n">data2</span> <span class="o">*=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ntrans2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ntrans</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">=</span> <span class="n">deltat2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Trace.nyquist_check"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.nyquist_check">[docs]</a>    <span class="k">def</span> <span class="nf">nyquist_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intro</span><span class="o">=</span><span class="s">&#39;Corner frequency&#39;</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Check if a given frequency is above the Nyquist frequency of the trace.</span>

<span class="sd">        :param intro: string used to introduce the warning/error message</span>
<span class="sd">        :param warn: whether to emit a warning</span>
<span class="sd">        :param raise_exception: whether to raise an :py:exc:`AboveNyquist` exception.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">frequency</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> (</span><span class="si">%g</span><span class="s"> Hz) is equal to or higher than nyquist frequency (</span><span class="si">%g</span><span class="s"> Hz). (Trace </span><span class="si">%s</span><span class="s">)&#39;</span> \
                    <span class="o">%</span> <span class="p">(</span><span class="n">intro</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">raise_exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AboveNyquist</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            </div>
<div class="viewcode-block" id="Trace.lowpass"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.lowpass">[docs]</a>    <span class="k">def</span> <span class="nf">lowpass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">corner</span><span class="p">,</span> <span class="n">nyquist_warn</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nyquist_exception</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">demean</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Apply Butterworth lowpass to the trace.</span>
<span class="sd">        </span>
<span class="sd">        :param order: order of the filter</span>
<span class="sd">        :param corner: corner frequency of the filter</span>

<span class="sd">        Mean is removed before filtering.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nyquist_check</span><span class="p">(</span><span class="n">corner</span><span class="p">,</span> <span class="s">&#39;Corner frequency of lowpass&#39;</span><span class="p">,</span> <span class="n">nyquist_warn</span><span class="p">,</span> <span class="n">nyquist_exception</span><span class="p">)</span>
        <span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_cached_filter_coefs</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="p">[</span><span class="n">corner</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">],</span> <span class="n">btype</span><span class="o">=</span><span class="s">&#39;low&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Erroneous filter coefficients returned by scipy.signal.butter(). You may need to downsample the signal before filtering.&#39;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">demean</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">-=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="Trace.highpass"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.highpass">[docs]</a>    <span class="k">def</span> <span class="nf">highpass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">corner</span><span class="p">,</span> <span class="n">nyquist_warn</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nyquist_exception</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">demean</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Apply butterworth highpass to the trace.</span>

<span class="sd">        :param order: order of the filter</span>
<span class="sd">        :param corner: corner frequency of the filter</span>
<span class="sd">        </span>
<span class="sd">        Mean is removed before filtering.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nyquist_check</span><span class="p">(</span><span class="n">corner</span><span class="p">,</span> <span class="s">&#39;Corner frequency of highpass&#39;</span><span class="p">,</span> <span class="n">nyquist_warn</span><span class="p">,</span> <span class="n">nyquist_exception</span><span class="p">)</span>
        <span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_cached_filter_coefs</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="p">[</span><span class="n">corner</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">],</span> <span class="n">btype</span><span class="o">=</span><span class="s">&#39;high&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Erroneous filter coefficients returned by scipy.signal.butter(). You may need to downsample the signal before filtering.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">demean</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">-=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="Trace.bandpass"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.bandpass">[docs]</a>    <span class="k">def</span> <span class="nf">bandpass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">corner_hp</span><span class="p">,</span> <span class="n">corner_lp</span><span class="p">,</span> <span class="n">demean</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Apply butterworth bandpass to the trace.</span>
<span class="sd">        </span>
<span class="sd">        :param order: order of the filter</span>
<span class="sd">        :param corner_hp: lower corner frequency of the filter</span>
<span class="sd">        :param corner_lp: upper corner frequency of the filter</span>

<span class="sd">        Mean is removed before filtering.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nyquist_check</span><span class="p">(</span><span class="n">corner_hp</span><span class="p">,</span> <span class="s">&#39;Lower corner frequency of bandpass&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nyquist_check</span><span class="p">(</span><span class="n">corner_lp</span><span class="p">,</span> <span class="s">&#39;Higher corner frequency of bandpass&#39;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_cached_filter_coefs</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="p">[</span><span class="n">corner</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="p">(</span><span class="n">corner_hp</span><span class="p">,</span> <span class="n">corner_lp</span><span class="p">)],</span> <span class="n">btype</span><span class="o">=</span><span class="s">&#39;band&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">demean</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">-=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="Trace.abshilbert"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.abshilbert">[docs]</a>    <span class="k">def</span> <span class="nf">abshilbert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">hilbert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">))</span>
    </div>
<div class="viewcode-block" id="Trace.envelope"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.envelope">[docs]</a>    <span class="k">def</span> <span class="nf">envelope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">hilbert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Trace.taper"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.taper">[docs]</a>    <span class="k">def</span> <span class="nf">taper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taperer</span><span class="p">):</span>
        <span class="n">taperer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="Trace.whiten"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.whiten">[docs]</a>    <span class="k">def</span> <span class="nf">whiten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Whiten signal in time domain using autoregression and recursive filter.</span>
<span class="sd">        </span>
<span class="sd">        :param order: order of the autoregression process</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">b</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitening_coefficients</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Trace.whitening_coefficients"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.whitening_coefficients">[docs]</a>    <span class="k">def</span> <span class="nf">whitening_coefficients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">ar</span> <span class="o">=</span> <span class="n">yulewalker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]</span> <span class="o">+</span> <span class="n">ar</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>
</div>
<div class="viewcode-block" id="Trace.ampspec_whiten"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.ampspec_whiten">[docs]</a>    <span class="k">def</span> <span class="nf">ampspec_whiten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">td_taper</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span> <span class="n">fd_taper</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span> <span class="n">pad_to_pow2</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">demean</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Whiten signal via frequency domain using moving average on amplitude spectra.</span>
<span class="sd">        </span>
<span class="sd">        :param width: width of smoothing kernel [Hz]</span>
<span class="sd">        :param td_taper: time domain taper, object of type :py:class:`Taper` or ``None`` or ``&#39;auto&#39;``.</span>
<span class="sd">        :param fd_taper: frequency domain taper, object of type :py:class:`Taper` or ``None`` or ``&#39;auto&#39;``.</span>
<span class="sd">        :param pad_to_pow2: whether to pad the signal with zeros up to a length of 2^n</span>
<span class="sd">        :param demean: whether to demean the signal before tapering</span>
<span class="sd">        </span>
<span class="sd">        The signal is first demeaned and then tapered using *td_taper*. Then,</span>
<span class="sd">        the spectrum is calculated and inversely weighted with a smoothed</span>
<span class="sd">        version of its amplitude spectrum. A moving average is used for the</span>
<span class="sd">        smoothing. The smoothed spectrum is then tapered using *fd_taper*.</span>
<span class="sd">        Finally, the smoothed and tapered spectrum is back-transformed into the</span>
<span class="sd">        time domain.</span>

<span class="sd">        If *td_taper* is set to ``&#39;auto&#39;``, ``CosFader(1.0/width)`` is used. If</span>
<span class="sd">        *fd_taper* is set to ``&#39;auto&#39;``, ``CosFader(width)`` is used.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ndata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_len</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">pad_to_pow2</span><span class="p">:</span>
            <span class="n">ntrans</span> <span class="o">=</span> <span class="n">nextpow2</span><span class="p">(</span><span class="n">ndata</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ntrans</span> <span class="o">=</span> <span class="n">ndata</span>

        <span class="n">df</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">ntrans</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>
        <span class="n">nw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="n">df</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ndata</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">nw</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TraceTooShort</span><span class="p">(</span><span class="s">&#39;Samples in trace: </span><span class="si">%s</span><span class="s">, samples needed: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ndata</span><span class="p">,</span> <span class="n">nw</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">td_taper</span> <span class="o">==</span> <span class="s">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">td_taper</span> <span class="o">=</span> <span class="n">CosFader</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">width</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fd_taper</span> <span class="o">==</span> <span class="s">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">fd_taper</span> <span class="o">=</span> <span class="n">CosFader</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">td_taper</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">taper</span><span class="p">(</span><span class="n">td_taper</span><span class="p">)</span>

        <span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">demean</span><span class="p">:</span>
            <span class="n">ydata</span> <span class="o">-=</span> <span class="n">ydata</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            
        <span class="n">spec</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span> <span class="n">ntrans</span><span class="p">)</span>
        
        <span class="n">amp</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">nspec</span> <span class="o">=</span> <span class="n">amp</span><span class="o">.</span><span class="n">size</span>
        <span class="n">csamp</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span>
        <span class="n">amp_smoothed</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nspec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">csamp</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">nw</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">nw</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nspec</span> <span class="o">-</span> <span class="n">nw</span>
        <span class="n">amp_smoothed</span><span class="p">[</span><span class="n">n1</span><span class="p">:</span><span class="n">n2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">csamp</span><span class="p">[</span><span class="n">nw</span><span class="p">:]</span> <span class="o">-</span> <span class="n">csamp</span><span class="p">[:</span><span class="o">-</span><span class="n">nw</span><span class="p">])</span> <span class="o">/</span> <span class="n">nw</span>
        <span class="n">amp_smoothed</span><span class="p">[:</span><span class="n">n1</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp_smoothed</span><span class="p">[</span><span class="n">n1</span><span class="p">]</span>
        <span class="n">amp_smoothed</span><span class="p">[</span><span class="n">n2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">amp_smoothed</span><span class="p">[</span><span class="n">n2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
       
        <span class="n">denom</span> <span class="o">=</span> <span class="n">amp_smoothed</span> <span class="o">*</span> <span class="n">amp</span>
        <span class="n">numer</span> <span class="o">=</span> <span class="n">amp</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">denom</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-9</span>
        <span class="k">if</span> <span class="n">eps</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-9</span>
        
        <span class="n">numer</span> <span class="o">+=</span> <span class="n">eps</span>
        <span class="n">denom</span> <span class="o">+=</span> <span class="n">eps</span>
        <span class="n">spec</span> <span class="o">*=</span> <span class="n">numer</span><span class="o">/</span><span class="n">denom</span>
        
        <span class="k">if</span> <span class="n">fd_taper</span><span class="p">:</span>
            <span class="n">fd_taper</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

        <span class="n">ydata</span> <span class="o">=</span>  <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">ydata</span><span class="p">[:</span><span class="n">ndata</span><span class="p">])</span>
</div>
    <span class="k">def</span> <span class="nf">_get_cached_freqs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">deltaf</span><span class="p">):</span>
        <span class="n">ck</span> <span class="o">=</span> <span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="n">deltaf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ck</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Trace</span><span class="o">.</span><span class="n">cached_frequencies</span><span class="p">:</span>
            <span class="n">Trace</span><span class="o">.</span><span class="n">cached_frequencies</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">*</span><span class="n">deltaf</span>
        <span class="k">return</span> <span class="n">Trace</span><span class="o">.</span><span class="n">cached_frequencies</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span>
        
<div class="viewcode-block" id="Trace.bandpass_fft"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.bandpass_fft">[docs]</a>    <span class="k">def</span> <span class="nf">bandpass_fft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corner_hp</span><span class="p">,</span> <span class="n">corner_lp</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Apply boxcar bandbpass to trace (in spectral domain).&#39;&#39;&#39;</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">nextpow2</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
        <span class="n">fdata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_freqs</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdata</span><span class="p">),</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="n">n2</span><span class="p">))</span>
        <span class="n">fdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">fdata</span> <span class="o">*=</span> <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">corner_hp</span> <span class="o">&lt;</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">freqs</span> <span class="o">&lt;</span> <span class="n">corner_lp</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">fdata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        </div>
<div class="viewcode-block" id="Trace.shift"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.shift">[docs]</a>    <span class="k">def</span> <span class="nf">shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tshift</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Time shift the trace.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+=</span> <span class="n">tshift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">+=</span> <span class="n">tshift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
        </div>
<div class="viewcode-block" id="Trace.snap"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.snap">[docs]</a>    <span class="k">def</span> <span class="nf">snap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Shift trace samples to nearest even multiples of the sampling rate.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Trace.sta_lta_centered"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.sta_lta_centered">[docs]</a>    <span class="k">def</span> <span class="nf">sta_lta_centered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tshort</span><span class="p">,</span> <span class="n">tlong</span><span class="p">,</span> <span class="n">quad</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">scalingmethod</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Run special STA/LTA filter where the short time window is centered on the long time window.</span>

<span class="sd">        :param tshort: length of short time window in [s]</span>
<span class="sd">        :param tlong: length of long time window in [s]</span>
<span class="sd">        :param quad: whether to square the data prior to applying the STA/LTA filter</span>
<span class="sd">        :param scalingmethod: integer key to select how output values are scaled / normalized (``1``, ``2``, or ``3``)</span>
<span class="sd">        </span>
<span class="sd">        =================== ============================================ ===================</span>
<span class="sd">        Scalingmethod       Implementation                               Range</span>
<span class="sd">        =================== ============================================ ===================</span>
<span class="sd">        ``1``               As/Al* Tl/Ts                                 [0,1]</span>
<span class="sd">        ``2``               (As/Al - 1) / (Tl/Ts - 1)                    [-Ts/Tl,1]</span>
<span class="sd">        ``3``               Like ``2`` but clipping range at zero        [0,1]</span>
<span class="sd">        =================== ============================================ ===================</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    
        <span class="n">nshort</span> <span class="o">=</span> <span class="n">tshort</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="n">nlong</span> <span class="o">=</span> <span class="n">tlong</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
    
        <span class="k">assert</span> <span class="n">nshort</span> <span class="o">&lt;</span> <span class="n">nlong</span>
        <span class="k">if</span> <span class="n">nlong</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">TraceTooShort</span><span class="p">(</span><span class="s">&#39;Samples in trace: </span><span class="si">%s</span><span class="s">, samples needed: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">),</span> <span class="n">nlong</span><span class="p">))</span>
         
        <span class="k">if</span> <span class="n">quad</span><span class="p">:</span>
            <span class="n">sqrdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sqrdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
    
        <span class="n">mavg_short</span> <span class="o">=</span> <span class="n">moving_avg</span><span class="p">(</span><span class="n">sqrdata</span><span class="p">,</span><span class="n">nshort</span><span class="p">)</span>
        <span class="n">mavg_long</span> <span class="o">=</span> <span class="n">moving_avg</span><span class="p">(</span><span class="n">sqrdata</span><span class="p">,</span><span class="n">nlong</span><span class="p">)</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">scalingmethod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Invalid argument to scalingrange argument.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scalingmethod</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">mavg_short</span><span class="o">/</span><span class="n">mavg_long</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">nshort</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nlong</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">scalingmethod</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="p">(</span><span class="n">mavg_short</span><span class="o">/</span><span class="n">mavg_long</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">nlong</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nshort</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">scalingmethod</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Trace.peaks"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.peaks">[docs]</a>    <span class="k">def</span> <span class="nf">peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">tsearch</span><span class="p">,</span> <span class="n">deadtime</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">nblock_duration_detection</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Detect peaks above given threshold.</span>
<span class="sd">        </span>
<span class="sd">        From every instant, where the signal rises above *threshold*, a of time</span>
<span class="sd">        length of *tsearch* seconds is searched for a maximum. A list with</span>
<span class="sd">        tuples (time, value) for each detected peak is returned. The *deadtime*</span>
<span class="sd">        argument turns on a special deadtime duration detection algorithm useful</span>
<span class="sd">        in combination with recursive STA/LTA filters.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
        <span class="n">above</span> <span class="o">=</span>  <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">deriv</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="n">deriv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">above</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">above</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">itrig_positions</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">deriv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tpeaks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">apeaks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tzeros</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tzero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span>
        
        <span class="k">for</span> <span class="n">itrig_pos</span> <span class="ow">in</span> <span class="n">itrig_positions</span><span class="p">:</span>
            <span class="n">ibeg</span> <span class="o">=</span> <span class="n">itrig_pos</span>
            <span class="n">iend</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">),</span> <span class="n">itrig_pos</span> <span class="o">+</span> <span class="n">tsearch</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>
            <span class="n">ipeak</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">ibeg</span><span class="p">:</span><span class="n">iend</span><span class="p">])</span>
            <span class="n">tpeak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">ipeak</span><span class="o">+</span><span class="n">ibeg</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
            <span class="n">apeak</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ibeg</span><span class="o">+</span><span class="n">ipeak</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">tpeak</span> <span class="o">&lt;</span> <span class="n">tzero</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">deadtime</span><span class="p">:</span>
                <span class="n">ibeg</span> <span class="o">=</span> <span class="n">itrig_pos</span>
                <span class="n">iblock</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">nblock</span> <span class="o">=</span> <span class="n">nblock_duration_detection</span>
                <span class="n">totalsum</span> <span class="o">=</span> <span class="mf">0.</span> 
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ibeg</span><span class="o">+</span><span class="n">iblock</span><span class="o">*</span><span class="n">nblock</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
                        <span class="n">tzero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
                        <span class="k">break</span>

                    <span class="n">logy</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">ibeg</span><span class="o">+</span><span class="n">iblock</span><span class="o">*</span><span class="n">nblock</span><span class="p">:</span><span class="n">ibeg</span><span class="o">+</span><span class="p">(</span><span class="n">iblock</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nblock</span><span class="p">])</span>
                    <span class="n">logy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">totalsum</span>
                    <span class="n">ysum</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">logy</span><span class="p">)</span>
                    <span class="n">totalsum</span> <span class="o">=</span> <span class="n">ysum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">below</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ysum</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">deriv</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ysum</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
                    <span class="n">deriv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">below</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">below</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">izero_positions</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">deriv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">iblock</span><span class="o">*</span><span class="n">nblock</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">izero_positions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">tzero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">ibeg</span> <span class="o">+</span> <span class="n">izero_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
                        <span class="k">break</span>
                    <span class="n">iblock</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tzero</span> <span class="o">=</span> <span class="n">ibeg</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="n">tsearch</span>

            <span class="n">tpeaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tpeak</span><span class="p">)</span>
            <span class="n">apeaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">apeak</span><span class="p">)</span>
            <span class="n">tzeros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tzero</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">deadtime</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tpeaks</span><span class="p">,</span> <span class="n">apeaks</span><span class="p">,</span> <span class="n">tzeros</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tpeaks</span><span class="p">,</span> <span class="n">apeaks</span>
</div>
<div class="viewcode-block" id="Trace.extend"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.extend">[docs]</a>    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">fillmethod</span><span class="o">=</span><span class="s">&#39;zeros&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Extend trace to given span.</span>
<span class="sd">        </span>
<span class="sd">        :param tmin,tmax:  new span</span>
<span class="sd">        :param fillmethod: &#39;zeros&#39; or &#39;repeat&#39; </span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="k">assert</span> <span class="n">tmin</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="ow">and</span> <span class="n">tmax</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span>
        
        <span class="n">nl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">-</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span>
        <span class="n">nh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">tmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">-=</span> <span class="n">nl</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">+=</span> <span class="n">nh</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">nl</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="o">+</span><span class="n">nh</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nl</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="n">nh</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
        <span class="k">if</span> <span class="n">fillmethod</span> <span class="o">==</span> <span class="s">&#39;repeat&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[:</span><span class="n">nl</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">nl</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="n">nh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="n">nh</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">data</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
     </div>
<div class="viewcode-block" id="Trace.transfer"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.transfer">[docs]</a>    <span class="k">def</span> <span class="nf">transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tfade</span><span class="p">,</span> <span class="n">freqlimits</span><span class="p">,</span> <span class="n">transfer_function</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cut_off_fading</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return new trace with transfer function applied.</span>
<span class="sd">        </span>
<span class="sd">        :param tfade:             rise/fall time in seconds of taper applied in timedomain at both ends of trace.</span>
<span class="sd">        :param freqlimits:        4-tuple with corner frequencies in Hz.</span>
<span class="sd">        :param transfer_function: FrequencyResponse object; must provide a method &#39;evaluate(freqs)&#39;, which returns the</span>
<span class="sd">                                  transfer function coefficients at the frequencies &#39;freqs&#39;.</span>
<span class="sd">        :param cut_off_fading:    whether to cut off rise/fall interval in output trace.</span>
<span class="sd">        &#39;&#39;&#39;</span>
    
        <span class="k">if</span> <span class="n">transfer_function</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">transfer_function</span> <span class="o">=</span> <span class="n">FrequencyResponse</span><span class="p">()</span>
    
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">&lt;=</span> <span class="n">tfade</span><span class="o">*</span><span class="mf">2.</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TraceTooShort</span><span class="p">(</span><span class="s">&#39;Trace </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s"> too short for fading length setting. trace length = </span><span class="si">%g</span><span class="s">, fading length = </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nslc_id</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tfade</span><span class="p">)))</span>

        <span class="n">ndata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span>
        <span class="n">ntrans</span> <span class="o">=</span> <span class="n">nextpow2</span><span class="p">(</span><span class="n">ndata</span><span class="o">*</span><span class="mf">1.2</span><span class="p">)</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tapered_coefs</span><span class="p">(</span><span class="n">ntrans</span><span class="p">,</span> <span class="n">freqlimits</span><span class="p">,</span> <span class="n">transfer_function</span><span class="p">)</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
        <span class="n">data_pad</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntrans</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">data_pad</span><span class="p">[:</span><span class="n">ndata</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data_pad</span><span class="p">[:</span><span class="n">ndata</span><span class="p">]</span> <span class="o">*=</span> <span class="n">costaper</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">tfade</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="p">(</span><span class="n">ndata</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">tfade</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="n">ndata</span><span class="p">,</span> <span class="n">ndata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>
        <span class="n">fdata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">data_pad</span><span class="p">)</span>
        <span class="n">fdata</span> <span class="o">*=</span> <span class="n">coefs</span>
        <span class="n">ddata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">fdata</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">output</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">ddata</span><span class="p">[:</span><span class="n">ndata</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cut_off_fading</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="n">tfade</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="n">tfade</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">NoData</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TraceTooShort</span><span class="p">(</span><span class="s">&#39;Trace </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s"> too short for fading length setting. trace length = </span><span class="si">%g</span><span class="s">, fading length = </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nslc_id</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tfade</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">output</span>
        </div>
<div class="viewcode-block" id="Trace.spectrum"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pad_to_pow2</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">tfade</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get FFT spectrum of trace.</span>

<span class="sd">        :param pad_to_pow2: whether to zero-pad the data to next larger power-of-two length</span>
<span class="sd">        :param tfade: ``None`` or a time length in seconds, to apply cosine shaped tapers to both</span>

<span class="sd">        :returns: a tuple with (frequencies, values)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ndata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span>
        
        <span class="k">if</span> <span class="n">pad_to_pow2</span><span class="p">:</span>
            <span class="n">ntrans</span> <span class="o">=</span> <span class="n">nextpow2</span><span class="p">(</span><span class="n">ndata</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ntrans</span> <span class="o">=</span> <span class="n">ndata</span>

        <span class="k">if</span> <span class="n">tfade</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">*</span> <span class="n">costaper</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">tfade</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="p">(</span><span class="n">ndata</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">tfade</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="n">ndata</span><span class="p">,</span> <span class="n">ndata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>
            
        <span class="n">fydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span> <span class="n">ntrans</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">ntrans</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>
        <span class="n">fxdata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fydata</span><span class="p">))</span><span class="o">*</span><span class="n">df</span>
        <span class="k">return</span> <span class="n">fxdata</span><span class="p">,</span> <span class="n">fydata</span>
        </div>
    <span class="k">def</span> <span class="nf">_get_tapered_coefs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ntrans</span><span class="p">,</span> <span class="n">freqlimits</span><span class="p">,</span> <span class="n">transfer_function</span><span class="p">):</span>
    
        <span class="n">deltaf</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="n">ntrans</span><span class="p">)</span>
        <span class="n">nfreqs</span> <span class="o">=</span> <span class="n">ntrans</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">transfer</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nfreqs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="n">snapper</span><span class="p">(</span><span class="n">nfreqs</span><span class="p">,</span> <span class="n">deltaf</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="o">=</span> <span class="n">freqlimits</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hi</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">-</span><span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">*</span><span class="n">deltaf</span> <span class="o">+</span> <span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">deltaf</span>
        <span class="n">transfer</span><span class="p">[</span><span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">):</span><span class="n">hi</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span> <span class="o">=</span> <span class="n">transfer_function</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
        
        <span class="n">tapered_transfer</span> <span class="o">=</span> <span class="n">costaper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span> <span class="n">nfreqs</span><span class="p">,</span> <span class="n">deltaf</span><span class="p">)</span><span class="o">*</span><span class="n">transfer</span>
        <span class="n">tapered_transfer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c"># don&#39;t introduce static offsets</span>
        <span class="k">return</span> <span class="n">tapered_transfer</span>
        
<div class="viewcode-block" id="Trace.fill_template"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.fill_template">[docs]</a>    <span class="k">def</span> <span class="nf">fill_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="n">additional</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Fill string template with trace metadata.</span>
<span class="sd">        </span>
<span class="sd">        Uses normal pyton &#39;%(placeholder)s&#39; string templates. The following</span>
<span class="sd">        placeholders are considered: ``network``, ``station``, ``location``,</span>
<span class="sd">        ``channel``, ``tmin`` (time of first sample), ``tmax`` (time of last</span>
<span class="sd">        sample), ``tmin_ms``, ``tmax_ms``, ``tmin_us``, ``tmax_us``. The</span>
<span class="sd">        versions with &#39;_ms&#39; include milliseconds, the versions with &#39;_us&#39;</span>
<span class="sd">        include microseconds.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span> <span class="p">(</span><span class="s">&#39;network&#39;</span><span class="p">,</span> <span class="s">&#39;station&#39;</span><span class="p">,</span> <span class="s">&#39;location&#39;</span><span class="p">,</span> <span class="s">&#39;channel&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">))</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">_%H-%M-%S&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">_%H-%M-%S&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tmin_ms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">_%H-%M-%S.3FRAC&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tmax_ms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">_%H-%M-%S.3FRAC&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tmin_us&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">_%H-%M-%S.6FRAC&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tmax_us&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">_%H-%M-%S.6FRAC&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">additional</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">template</span> <span class="o">%</span> <span class="n">params</span>
</div>
<div class="viewcode-block" id="Trace.plot"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Show trace with matplotlib.</span>
<span class="sd">        </span>
<span class="sd">        See also: :py:meth:`Trace.snuffle`.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">())</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="o">+</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">-%m-%y %H:%M:%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">))</span><span class="o">+</span><span class="s">&#39; - &#39;</span><span class="o">+</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">-%m-%y %H:%M:%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">))</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    </div>
<div class="viewcode-block" id="Trace.snuffle"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.snuffle">[docs]</a>    <span class="k">def</span> <span class="nf">snuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Show trace in a snuffler window.</span>

<span class="sd">        :param stations: list of `pyrocko.model.Station` objects or ``None``</span>
<span class="sd">        :param events: list of `pyrocko.model.Event` objects or ``None``</span>
<span class="sd">        :param markers: list of `pyrocko.gui_util.Marker` objects or ``None``</span>
<span class="sd">        :param ntracks: float, number of tracks to be shown initially (default: 12)</span>
<span class="sd">        :param follow: time interval (in seconds) for real time follow mode or ``None``</span>
<span class="sd">        :param controls: bool, whether to show the main controls (default: ``True``)</span>
<span class="sd">        :param opengl: bool, whether to use opengl (default: ``False``)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">snuffle</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="snuffle"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.snuffle">[docs]</a><span class="k">def</span> <span class="nf">snuffle</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Show traces in a snuffler window.</span>

<span class="sd">    :param stations: list of `pyrocko.model.Station` objects or ``None``</span>
<span class="sd">    :param events: list of `pyrocko.model.Event` objects or ``None``</span>
<span class="sd">    :param markers: list of `pyrocko.gui_util.Marker` objects or ``None``</span>
<span class="sd">    :param ntracks: float, number of tracks to be shown initially (default: 12)</span>
<span class="sd">    :param follow: time interval (in seconds) for real time follow mode or ``None``</span>
<span class="sd">    :param controls: bool, whether to show the main controls (default: ``True``)</span>
<span class="sd">    :param opengl: bool, whether to use opengl (default: ``False``)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="kn">import</span> <span class="n">pile</span><span class="p">,</span> <span class="n">snuffler</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pile</span><span class="o">.</span><span class="n">Pile</span><span class="p">()</span>
    <span class="n">trf</span> <span class="o">=</span> <span class="n">pile</span><span class="o">.</span><span class="n">MemTracesFile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">traces</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_file</span><span class="p">(</span><span class="n">trf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">snuffler</span><span class="o">.</span><span class="n">snuffle</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NoData"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.NoData">[docs]</a><span class="k">class</span> <span class="nc">NoData</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This exception is raised by some :py:class:`Trace` operations when no or not enough data is available.&#39;&#39;&#39;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="AboveNyquist"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.AboveNyquist">[docs]</a><span class="k">class</span> <span class="nc">AboveNyquist</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This exception is raised by some :py:class:`Trace` operations when given frequencies are above the Nyquist frequency.&#39;&#39;&#39;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="TraceTooShort"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.TraceTooShort">[docs]</a><span class="k">class</span> <span class="nc">TraceTooShort</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This exception is raised by some :py:class:`Trace` operations when the trace is too short.&#39;&#39;&#39;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="minmax"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.minmax">[docs]</a><span class="k">def</span> <span class="nf">minmax</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;minmax&#39;</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39;Get data range given traces grouped by selected pattern.</span>
<span class="sd">   </span>
<span class="sd">    :param key: a callable which takes as single argument a trace and returns a key for the grouping of the results.</span>
<span class="sd">                If this is ``None``, the default, ``lambda tr: (tr.network, tr.station, tr.location, tr.channel)`` is used.</span>
<span class="sd">    :param mode: &#39;minmax&#39; or floating point number. If this is &#39;minmax&#39;, minimum and maximum of the traces are used, </span>
<span class="sd">                 if it is a number, mean +- stdandard deviation times *mode* is used.</span>
<span class="sd">    </span>
<span class="sd">    :returns: a dict with the combined data ranges.</span>

<span class="sd">    Examples::</span>
<span class="sd">    </span>
<span class="sd">        ranges = minmax(traces, lambda tr: tr.channel)</span>
<span class="sd">        print ranges[&#39;N&#39;]   # print minimum and maximum of all traces with channel == &#39;N&#39;</span>
<span class="sd">        print ranges[&#39;E&#39;]   # print mimimum and maximum of all traces with channel == &#39;E&#39;</span>

<span class="sd">        ranges = minmax(traces, lambda tr: (tr.network, tr.station))</span>
<span class="sd">        print ranges[&#39;GR&#39;, &#39;HAM3&#39;]    # print minmum and maxium of all traces with </span>
<span class="sd">                                      # network == &#39;GR&#39; and station == &#39;HAM3&#39;</span>

<span class="sd">        ranges = minmax(traces, lambda tr: None)</span>
<span class="sd">        print ranges[None]  # prints minimum and maximum of all traces</span>


<span class="sd">    &#39;&#39;&#39;</span>
   
    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">_default_key</span>

    <span class="n">ranges</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;minmax&#39;</span><span class="p">:</span>
            <span class="n">mi</span><span class="p">,</span> <span class="n">ma</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">trace</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">mi</span><span class="p">,</span> <span class="n">ma</span> <span class="o">=</span> <span class="n">mean</span><span class="o">-</span><span class="n">std</span><span class="o">*</span><span class="n">mode</span><span class="p">,</span> <span class="n">mean</span><span class="o">+</span><span class="n">std</span><span class="o">*</span><span class="n">mode</span>
            
        <span class="n">k</span> <span class="o">=</span> <span class="n">key</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
            <span class="n">ranges</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mi</span><span class="p">,</span> <span class="n">ma</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmi</span><span class="p">,</span> <span class="n">tma</span> <span class="o">=</span> <span class="n">ranges</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">ranges</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tmi</span><span class="p">,</span><span class="n">mi</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">tma</span><span class="p">,</span><span class="n">ma</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ranges</span>
        </div>
<div class="viewcode-block" id="minmaxtime"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.minmaxtime">[docs]</a><span class="k">def</span> <span class="nf">minmaxtime</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39;Get time range given traces grouped by selected pattern.</span>
<span class="sd">    </span>
<span class="sd">    :param key: a callable which takes as single argument a trace and returns a key for the grouping of the results.</span>
<span class="sd">                If this is ``None``, the default, ``lambda tr: (tr.network, tr.station, tr.location, tr.channel)`` is used.</span>
<span class="sd">    </span>
<span class="sd">    :returns: a dict with the combined data ranges.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">_default_key</span>

    <span class="n">ranges</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
        <span class="n">mi</span><span class="p">,</span> <span class="n">ma</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">trace</span><span class="o">.</span><span class="n">tmax</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">key</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
            <span class="n">ranges</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mi</span><span class="p">,</span> <span class="n">ma</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmi</span><span class="p">,</span> <span class="n">tma</span> <span class="o">=</span> <span class="n">ranges</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">ranges</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tmi</span><span class="p">,</span><span class="n">mi</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">tma</span><span class="p">,</span><span class="n">ma</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ranges</span>
    </div>
<div class="viewcode-block" id="degapper"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.degapper">[docs]</a><span class="k">def</span> <span class="nf">degapper</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">maxgap</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fillmethod</span><span class="o">=</span><span class="s">&#39;interpolate&#39;</span><span class="p">,</span> <span class="n">deoverlap</span><span class="o">=</span><span class="s">&#39;use_second&#39;</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39;Try to connect traces and remove gaps.</span>
<span class="sd">    </span>
<span class="sd">    This method will combine adjacent traces, which match in their network, </span>
<span class="sd">    station, location and channel attributes. Overlapping parts are handled</span>
<span class="sd">    according to the `deoverlap` argument.</span>
<span class="sd">    </span>
<span class="sd">    :param traces:      input traces, must be sorted by their full_id attribute.</span>
<span class="sd">    :param maxgap:      maximum number of samples to interpolate.</span>
<span class="sd">    :param fillmethod:  what to put into the gaps: &#39;interpolate&#39; or &#39;zeros&#39;.</span>
<span class="sd">    :param deoverlap:   how to handle overlaps: &#39;use_second&#39; to use data from </span>
<span class="sd">                        second trace (default), &#39;use_first&#39; to use data from first</span>
<span class="sd">                        trace, &#39;crossfade_cos&#39; to crossfade with cosine taper </span>
<span class="sd">      </span>
<span class="sd">    :returns:           list of traces</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">in_traces</span> <span class="o">=</span> <span class="n">traces</span> 
    <span class="n">out_traces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_traces</span><span class="p">:</span> <span class="k">return</span> <span class="n">out_traces</span>
    <span class="n">out_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">in_traces</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">in_traces</span><span class="p">:</span>
        
        <span class="n">a</span> <span class="o">=</span> <span class="n">out_traces</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">in_traces</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">avirt</span><span class="p">,</span> <span class="n">bvirt</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ydata</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">ydata</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="n">avirt</span> <span class="o">==</span> <span class="n">bvirt</span><span class="p">,</span> <span class="s">&#39;traces given to degapper() must either all have data or have no data.&#39;</span>
        <span class="n">virtual</span> <span class="o">=</span> <span class="n">avirt</span> <span class="ow">and</span> <span class="n">bvirt</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">nslc_id</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">nslc_id</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">deltat</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">deltat</span> <span class="ow">and</span> 
            <span class="n">a</span><span class="o">.</span><span class="n">data_len</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">data_len</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> 
            <span class="p">(</span><span class="n">virtual</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)):</span>
            
            <span class="n">dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">tmin</span><span class="o">-</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">data_len</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span><span class="o">/</span><span class="n">a</span><span class="o">.</span><span class="n">deltat</span>
            <span class="n">idist</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">dist</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dist</span> <span class="o">-</span> <span class="n">idist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.05</span> <span class="ow">and</span> <span class="n">idist</span> <span class="o">&lt;=</span> <span class="n">maxgap</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c">#logger.warn(&#39;Cannot degap traces with displaced sampling (%s,%s,%s,%s)&#39; % a.nslc_id)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">idist</span> <span class="o">&lt;=</span> <span class="n">maxgap</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">virtual</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fillmethod</span> <span class="o">==</span> <span class="s">&#39;interpolate&#39;</span><span class="p">:</span>
                            <span class="n">filler</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(((</span><span class="mf">1.</span><span class="o">+</span><span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">idist</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">))</span><span class="o">/</span><span class="n">idist</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">fillmethod</span> <span class="o">==</span> <span class="s">&#39;zeros&#39;</span><span class="p">:</span>
                            <span class="n">filler</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">idist</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">ydist</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span><span class="n">filler</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="p">))</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">tmax</span>
                    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">mtime</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">mtime</span><span class="p">:</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">mtime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">mtime</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">mtime</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">elif</span> <span class="n">idist</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">virtual</span><span class="p">:</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="p">))</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">tmax</span>
                    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">mtime</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">mtime</span><span class="p">:</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">mtime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">mtime</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">mtime</span><span class="p">)</span>
                    <span class="k">continue</span>
                    
                <span class="k">elif</span> <span class="n">idist</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">tmax</span> <span class="o">&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">tmax</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">virtual</span><span class="p">:</span>
                            <span class="n">na</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span>
                            <span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="n">idist</span><span class="o">+</span><span class="mi">1</span>
                            <span class="k">if</span> <span class="n">deoverlap</span> <span class="o">==</span> <span class="s">&#39;use_second&#39;</span><span class="p">:</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">],</span> <span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="p">))</span>
                            <span class="k">elif</span> <span class="n">deoverlap</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;use_first&#39;</span><span class="p">,</span> <span class="s">&#39;crossfade_cos&#39;</span><span class="p">):</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">n</span><span class="p">:]))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">assert</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;unknown deoverlap method&#39;</span>

                            <span class="k">if</span> <span class="n">deoverlap</span> <span class="o">==</span> <span class="s">&#39;crossfade_cos&#39;</span><span class="p">:</span>
                                <span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="n">idist</span><span class="o">+</span><span class="mi">1</span>
                                <span class="n">taper</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mf">1.</span><span class="o">+</span><span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">na</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">na</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1.</span><span class="o">-</span><span class="n">taper</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">na</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">na</span><span class="p">]</span> <span class="o">+=</span> <span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="n">taper</span>

                        <span class="n">a</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">tmax</span>
                        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">mtime</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">mtime</span><span class="p">:</span>
                            <span class="n">a</span><span class="o">.</span><span class="n">mtime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">mtime</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">mtime</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># make short second trace vanish</span>
                        <span class="k">continue</span>
                    
        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">data_len</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">out_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">out_traces</span><span class="p">:</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">out_traces</span>
</div>
<div class="viewcode-block" id="rotate"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.rotate">[docs]</a><span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;2D rotation of traces.</span>
<span class="sd">    </span>
<span class="sd">    :param traces: list of input traces</span>
<span class="sd">    :param azimuth: difference of the azimuths of the component directions</span>
<span class="sd">                     (azimuth of out_channels[0]) - (azimuth of in_channels[0])</span>
<span class="sd">    :param in_channels: names of the input channels (e.g. &#39;N&#39;, &#39;E&#39;)</span>
<span class="sd">    :param out_channels: names of the output channels (e.g. &#39;R&#39;, &#39;T&#39;)</span>
<span class="sd">    :returns: list of rotated traces </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">phi</span> <span class="o">=</span> <span class="n">azimuth</span><span class="o">/</span><span class="mf">180.</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">cphi</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">sphi</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">rotated</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">in_channels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_channels_to_names</span><span class="p">(</span><span class="n">in_channels</span><span class="p">))</span>
    <span class="n">out_channels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_channels_to_names</span><span class="p">(</span><span class="n">out_channels</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span> <span class="o">==</span> <span class="n">in_channels</span> <span class="ow">and</span>
                 <span class="n">a</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span>
                 <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">deltat</span><span class="o">-</span><span class="n">b</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.001</span> <span class="p">):</span>
                <span class="n">tmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>
                <span class="n">tmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">tmin</span> <span class="o">&lt;</span> <span class="n">tmax</span><span class="p">:</span>
                    <span class="n">ac</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">bc</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">tmin</span> <span class="o">-</span> <span class="n">bc</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ac</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.01</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Cannot rotate traces with displaced sampling (</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">a</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">)</span>
                        <span class="k">continue</span>
                    
                    <span class="n">acydata</span> <span class="o">=</span>  <span class="n">ac</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span><span class="o">*</span><span class="n">cphi</span><span class="o">+</span><span class="n">bc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span><span class="o">*</span><span class="n">sphi</span>
                    <span class="n">bcydata</span> <span class="o">=</span> <span class="o">-</span><span class="n">ac</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span><span class="o">*</span><span class="n">sphi</span><span class="o">+</span><span class="n">bc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span><span class="o">*</span><span class="n">cphi</span>
                    <span class="n">ac</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">acydata</span><span class="p">)</span>
                    <span class="n">bc</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">bcydata</span><span class="p">)</span>

                    <span class="n">ac</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">bc</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">rotated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span>
                    <span class="n">rotated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span>
                    
    <span class="k">return</span> <span class="n">rotated</span>

</div>
<span class="k">def</span> <span class="nf">_decompose</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Decompose matrix into independent submatrices.&#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">depends</span><span class="p">(</span><span class="n">iout</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">iout</span><span class="p">,:]</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">row</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">provides</span><span class="p">(</span><span class="n">iin</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:,</span><span class="n">iin</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">col</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">))</span>
    
    <span class="n">a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">systems</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">outs</span><span class="p">:</span>
        <span class="n">iout</span> <span class="o">=</span> <span class="n">outs</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        
        <span class="n">gout</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iin</span> <span class="ow">in</span> <span class="n">depends</span><span class="p">(</span><span class="n">iout</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
            <span class="n">gout</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">provides</span><span class="p">(</span><span class="n">iin</span><span class="p">,</span><span class="n">a</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gout</span><span class="p">:</span> <span class="k">continue</span>
        
        <span class="n">gin</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iout2</span> <span class="ow">in</span> <span class="n">gout</span><span class="p">:</span>
            <span class="n">gin</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">depends</span><span class="p">(</span><span class="n">iout2</span><span class="p">,</span><span class="n">a</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gin</span><span class="p">:</span> <span class="k">continue</span>
                
        <span class="k">for</span> <span class="n">iout2</span> <span class="ow">in</span> <span class="n">gout</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">iout2</span> <span class="ow">in</span> <span class="n">outs</span><span class="p">:</span>
                <span class="n">outs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">iout2</span><span class="p">)</span>

        <span class="n">gin</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gin</span><span class="p">)</span>
        <span class="n">gin</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">gout</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gout</span><span class="p">)</span>
        <span class="n">gout</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        
        <span class="n">systems</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">gin</span><span class="p">,</span> <span class="n">gout</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">gout</span><span class="p">,:][:,</span><span class="n">gin</span><span class="p">]))</span>
    
    <span class="k">return</span> <span class="n">systems</span>

<span class="k">def</span> <span class="nf">_channels_to_names</span><span class="p">(</span><span class="n">channels</span><span class="p">):</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Channel</span><span class="p">):</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">names</span>

<div class="viewcode-block" id="project"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.project">[docs]</a><span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span>
   
    <span class="sd">&#39;&#39;&#39;Affine transform of three-component traces.</span>

<span class="sd">    Compute matrix-vector product of three-component traces, to e.g. rotate</span>
<span class="sd">    traces into a different basis. The traces are distinguished and ordered by their channel attribute.</span>
<span class="sd">    The tranform is applied to overlapping parts of any appropriate combinations of the input traces. This</span>
<span class="sd">    should allow this function to be robust with data gaps.</span>
<span class="sd">    It also tries to apply the tranformation</span>
<span class="sd">    to subsets of the channels, if this is possible, so that, if for example a vertical</span>
<span class="sd">    compontent is missing, horizontal components can still be rotated.</span>

<span class="sd">    :param traces: list of traces in arbitrary order</span>
<span class="sd">    :param matrix: tranformation matrix</span>
<span class="sd">    :param in_channels: input channel names</span>
<span class="sd">    :param out_channels: output channel names</span>
<span class="sd">    :returns: list of transformed traces</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">in_channels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="n">_channels_to_names</span><span class="p">(</span><span class="n">in_channels</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">out_channels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="n">_channels_to_names</span><span class="p">(</span><span class="n">out_channels</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">systems</span> <span class="o">=</span> <span class="n">_decompose</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    
    <span class="c"># fallback to full matrix if some are not quadratic</span>
    <span class="k">for</span> <span class="n">iins</span><span class="p">,</span> <span class="n">iouts</span><span class="p">,</span> <span class="n">submatrix</span> <span class="ow">in</span> <span class="n">systems</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">submatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">submatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">_project3</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">)</span>
    
    <span class="n">projected</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iins</span><span class="p">,</span> <span class="n">iouts</span> <span class="p">,</span><span class="n">submatrix</span> <span class="ow">in</span> <span class="n">systems</span><span class="p">:</span>
        <span class="n">in_cha</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="p">[</span> <span class="n">in_channels</span><span class="p">[</span><span class="n">iin</span><span class="p">]</span> <span class="k">for</span> <span class="n">iin</span> <span class="ow">in</span> <span class="n">iins</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">out_cha</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="p">[</span> <span class="n">out_channels</span><span class="p">[</span><span class="n">iout</span><span class="p">]</span> <span class="k">for</span> <span class="n">iout</span> <span class="ow">in</span> <span class="n">iouts</span> <span class="p">]</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">submatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">projected</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="n">_project1</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">submatrix</span><span class="p">,</span> <span class="n">in_cha</span><span class="p">,</span> <span class="n">out_cha</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">submatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">projected</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="n">_project2</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">submatrix</span><span class="p">,</span> <span class="n">in_cha</span><span class="p">,</span> <span class="n">out_cha</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">projected</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="n">_project3</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">submatrix</span><span class="p">,</span> <span class="n">in_cha</span><span class="p">,</span> <span class="n">out_cha</span><span class="p">)</span> <span class="p">)</span>
    
   
    <span class="k">return</span> <span class="n">projected</span>
</div>
<div class="viewcode-block" id="project_dependencies"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.project_dependencies">[docs]</a><span class="k">def</span> <span class="nf">project_dependencies</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39;Figure out what dependencies project() would produce.&#39;&#39;&#39;</span>
    
    <span class="n">in_channels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="n">_channels_to_names</span><span class="p">(</span><span class="n">in_channels</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">out_channels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="n">_channels_to_names</span><span class="p">(</span><span class="n">out_channels</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">systems</span> <span class="o">=</span> <span class="n">_decompose</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    
    <span class="n">subpro</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iins</span><span class="p">,</span> <span class="n">iouts</span><span class="p">,</span> <span class="n">submatrix</span> <span class="ow">in</span> <span class="n">systems</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">submatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">submatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">subpro</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">matrix</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">subpro</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">iins</span><span class="p">,</span> <span class="n">iouts</span> <span class="p">,</span><span class="n">submatrix</span> <span class="ow">in</span> <span class="n">systems</span><span class="p">:</span>
            <span class="n">in_cha</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="p">[</span> <span class="n">in_channels</span><span class="p">[</span><span class="n">iin</span><span class="p">]</span> <span class="k">for</span> <span class="n">iin</span> <span class="ow">in</span> <span class="n">iins</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">out_cha</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="p">[</span> <span class="n">out_channels</span><span class="p">[</span><span class="n">iout</span><span class="p">]</span> <span class="k">for</span> <span class="n">iout</span> <span class="ow">in</span> <span class="n">iouts</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">subpro</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">submatrix</span><span class="p">,</span> <span class="n">in_cha</span><span class="p">,</span> <span class="n">out_cha</span><span class="p">))</span>
            
    <span class="n">deps</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">mat</span><span class="p">,</span> <span class="n">in_cha</span><span class="p">,</span> <span class="n">out_cha</span> <span class="ow">in</span> <span class="n">subpro</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">oc</span> <span class="ow">in</span> <span class="n">out_cha</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">oc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">deps</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">in_cha</span><span class="p">:</span>
                <span class="n">deps</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">deps</span>
        </div>
<span class="k">def</span> <span class="nf">_project1</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">projected</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">channel</span><span class="p">,)</span> <span class="o">==</span> <span class="n">in_channels</span><span class="p">:</span> 
            <span class="k">continue</span>
        
        <span class="n">ac</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">())</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">projected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">projected</span>

<span class="k">def</span> <span class="nf">_project2</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">projected</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">channel</span> <span class="p">)</span> <span class="o">==</span> <span class="n">in_channels</span> <span class="ow">and</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span>
                    <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">deltat</span><span class="o">-</span><span class="n">b</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.001</span> <span class="p">):</span>
                <span class="k">continue</span>
                    
            <span class="n">tmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>
            <span class="n">tmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">tmin</span> <span class="o">&gt;=</span> <span class="n">tmax</span><span class="p">:</span>
                <span class="k">continue</span>
        
            <span class="n">ac</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">bc</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">tmin</span> <span class="o">-</span> <span class="n">bc</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ac</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.01</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Cannot project traces with displaced sampling (</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">a</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">)</span>
                <span class="k">continue</span>
                
            <span class="n">acydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span><span class="n">bc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>
            <span class="n">bcydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span><span class="n">bc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>
            
            <span class="n">ac</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">acydata</span><span class="p">)</span>
            <span class="n">bc</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">bcydata</span><span class="p">)</span>

            <span class="n">ac</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">bc</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="n">projected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span>
            <span class="n">projected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">projected</span>
            
<span class="k">def</span> <span class="nf">_project3</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">projected</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span> <span class="o">==</span> <span class="n">in_channels</span> <span class="ow">and</span>
                     <span class="n">a</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span>
                     <span class="n">b</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span>
                     <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">deltat</span><span class="o">-</span><span class="n">b</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.001</span> <span class="ow">and</span>
                     <span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">deltat</span><span class="o">-</span><span class="n">c</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.001</span> <span class="p">):</span>
                    <span class="k">continue</span>
                     
                <span class="n">tmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>
                <span class="n">tmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span>
                    
                <span class="k">if</span> <span class="n">tmin</span> <span class="o">&gt;=</span> <span class="n">tmax</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="n">ac</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">bc</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">tmin</span> <span class="o">-</span> <span class="n">bc</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ac</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.01</span> <span class="ow">or</span>
                    <span class="nb">abs</span><span class="p">(</span><span class="n">bc</span><span class="o">.</span><span class="n">tmin</span> <span class="o">-</span> <span class="n">cc</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bc</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.01</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Cannot project traces with displaced sampling (</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">a</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">)</span>
                    <span class="k">continue</span>
                    
                <span class="n">acydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span><span class="n">bc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span><span class="n">cc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>
                <span class="n">bcydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span><span class="n">bc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span><span class="n">cc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>
                <span class="n">ccydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span><span class="n">bc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span><span class="n">cc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>
                
                <span class="n">ac</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">acydata</span><span class="p">)</span>
                <span class="n">bc</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">bcydata</span><span class="p">)</span>
                <span class="n">cc</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">ccydata</span><span class="p">)</span>

                <span class="n">ac</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">bc</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">cc</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                
                <span class="n">projected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span>
                <span class="n">projected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span>
                <span class="n">projected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
     
    <span class="k">return</span> <span class="n">projected</span>


<div class="viewcode-block" id="correlate"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.correlate">[docs]</a><span class="k">def</span> <span class="nf">correlate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;valid&#39;</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Cross correlation of two traces.</span>
<span class="sd">    </span>
<span class="sd">    This function computes the cross correlation with the NumPy function of the</span>
<span class="sd">    same name.  A trace containing the cross correlation coefficients is</span>
<span class="sd">    returned. The time information of the output trace is adjusted so that the</span>
<span class="sd">    returned cross correlation can be viewed directly as a function of time</span>
<span class="sd">    shift. This function tries to circumvent some problems caused by older</span>
<span class="sd">    versions of numpy.correlate.</span>

<span class="sd">    :param a,b: input traces</span>
<span class="sd">    :param mode: &#39;valid&#39;, &#39;full&#39;, or &#39;same&#39;</span>
<span class="sd">    :param normalization: &#39;normal&#39;, &#39;gliding&#39;, or None</span>

<span class="sd">    :returns: trace containing cross correlation coefficients</span>

<span class="sd">    Example::</span>
<span class="sd">        </span>
<span class="sd">        # align two traces a and b containing a time shifted similar signal:</span>
<span class="sd">        c = pyrocko.trace.correlate(a,b)</span>
<span class="sd">        t, coef = c.max()  # get time and value of maximum</span>
<span class="sd">        b.shift(-t)        # align b with a</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">assert</span> <span class="n">same_sampling_rate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

    <span class="n">ya</span><span class="p">,</span> <span class="n">yb</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">ydata</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;same&#39;</span> <span class="ow">and</span> <span class="n">ya</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">yb</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="c"># because we have problems predicting k range in this mode when sizes are not the same</span>
        <span class="k">if</span> <span class="n">ya</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">yb</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">ya</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ya</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">yb</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">ya</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ya</span><span class="o">.</span><span class="n">dtype</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">yb</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">ya</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">yb</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">yb</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ya</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">yb</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">yb</span><span class="o">.</span><span class="n">dtype</span><span class="p">)))</span>

    <span class="n">yc</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">ya</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">yb</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">ya</span><span class="o">.</span><span class="n">size</span> <span class="ow">and</span> <span class="n">numpy_has_correlate_flip_bug</span><span class="p">():</span>
        <span class="n">yc</span> <span class="o">=</span> <span class="n">yc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">normalization</span> <span class="o">==</span> <span class="s">&#39;normal&#39;</span><span class="p">:</span>
        <span class="n">normfac</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ya</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yb</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">yc</span> <span class="o">/=</span> <span class="n">normfac</span>

    <span class="k">elif</span> <span class="n">normalization</span> <span class="o">==</span> <span class="s">&#39;gliding&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s">&#39;valid&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;gliding normalization currently only available with &quot;valid&quot; mode.&#39;</span>

        <span class="k">if</span> <span class="n">ya</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">yb</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">yshort</span><span class="p">,</span> <span class="n">ylong</span> <span class="o">=</span> <span class="n">ya</span><span class="p">,</span> <span class="n">yb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yshort</span><span class="p">,</span> <span class="n">ylong</span> <span class="o">=</span> <span class="n">yb</span><span class="p">,</span> <span class="n">ya</span>
        
        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">0.00001</span>
        <span class="n">normfac_short</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yshort</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> 
        <span class="n">normfac</span> <span class="o">=</span> <span class="n">normfac_short</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">moving_sum</span><span class="p">(</span><span class="n">ylong</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">yshort</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;valid&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="n">normfac_short</span><span class="o">*</span><span class="n">epsilon</span>
        
        <span class="k">if</span> <span class="n">yb</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">ya</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">normfac</span> <span class="o">=</span> <span class="n">normfac</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">yc</span> <span class="o">/=</span> <span class="n">normfac</span>
    
    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">yc</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="o">*</span><span class="n">merge_codes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="s">&#39;~&#39;</span><span class="p">))</span>
    <span class="n">c</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">tmin</span><span class="o">-</span><span class="n">a</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;same&#39;</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="n">ya</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="n">yb</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>  <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ya</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">yb</span><span class="o">.</span><span class="n">size</span><span class="p">))</span><span class="o">*</span><span class="n">c</span><span class="o">.</span><span class="n">deltat</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;valid&#39;</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="n">ya</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">yb</span><span class="o">.</span><span class="n">size</span><span class="p">))</span><span class="o">*</span> <span class="n">c</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;full&#39;</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">yb</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="n">ya</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="n">ya</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">yb</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span><span class="o">*</span> <span class="n">c</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">c</span>
</div>
<div class="viewcode-block" id="deconvolve"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.deconvolve">[docs]</a><span class="k">def</span> <span class="nf">deconvolve</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">waterlevel</span><span class="p">,</span> <span class="n">fd_taper</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pad_to_pow2</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmin</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">deltat</span> <span class="o">*</span> <span class="mf">0.001</span>
    <span class="n">same_sampling_rate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

    <span class="n">ndata</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">data_len</span><span class="p">(),</span> <span class="n">b</span><span class="o">.</span><span class="n">data_len</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">pad_to_pow2</span><span class="p">:</span>
        <span class="n">ntrans</span> <span class="o">=</span> <span class="n">nextpow2</span><span class="p">(</span><span class="n">ndata</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ntrans</span> <span class="o">=</span> <span class="n">ndata</span>
        
    <span class="n">aspec</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">ntrans</span><span class="p">)</span>
    <span class="n">bspec</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">ntrans</span><span class="p">)</span>
    
    <span class="n">out</span> <span class="o">=</span> <span class="n">aspec</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">bspec</span><span class="p">)</span>
    
    <span class="n">bautocorr</span> <span class="o">=</span> <span class="n">bspec</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">bspec</span><span class="p">)</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span> <span class="n">bautocorr</span><span class="p">,</span> <span class="n">waterlevel</span> <span class="o">*</span> <span class="n">bautocorr</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="p">)</span>

    <span class="n">out</span> <span class="o">/=</span> <span class="n">denom</span>
    <span class="n">df</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">ndata</span><span class="o">*</span><span class="n">a</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">fd_taper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fd_taper</span><span class="p">(</span> <span class="n">out</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">df</span> <span class="p">)</span>

    <span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    
    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">ydata</span><span class="p">[:</span><span class="n">ndata</span><span class="p">])</span>
    <span class="n">c</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="o">*</span><span class="n">merge_codes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">c</span> 
</div>
<div class="viewcode-block" id="same_sampling_rate"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.same_sampling_rate">[docs]</a><span class="k">def</span> <span class="nf">same_sampling_rate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Check if two traces have the same sampling rate.</span>
<span class="sd">    </span>
<span class="sd">    :param a,b: input traces</span>
<span class="sd">    :param eps: relative tolerance</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">deltat</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">deltat</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span><span class="o">*</span><span class="n">eps</span>
</div>
<div class="viewcode-block" id="merge_codes"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.merge_codes">[docs]</a><span class="k">def</span> <span class="nf">merge_codes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Merge network-station-location-channel codes of a pair of traces.&#39;&#39;&#39;</span>
    
    
    <span class="n">o</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">xa</span><span class="p">,</span><span class="n">xb</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">xa</span> <span class="o">==</span> <span class="n">xb</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xa</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">xa</span><span class="p">,</span><span class="n">xb</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">o</span>
</div>
<div class="viewcode-block" id="Taper"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Taper">[docs]</a><span class="k">class</span> <span class="nc">Taper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="CosTaper"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.CosTaper">[docs]</a><span class="k">class</span> <span class="nc">CosTaper</span><span class="p">(</span><span class="n">Taper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_corners</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corners</span>
        <span class="n">apply_costaper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CosFader"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.CosFader">[docs]</a><span class="k">class</span> <span class="nc">CosFader</span><span class="p">(</span><span class="n">Taper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xfade</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">xfrac</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">xfade</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">xfrac</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xfade</span> <span class="o">=</span> <span class="n">xfade</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xfrac</span> <span class="o">=</span> <span class="n">xfrac</span>
    
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
        <span class="n">xfade</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xfade</span>

        <span class="n">xlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
        <span class="k">if</span> <span class="n">xfade</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">xfade</span> <span class="o">=</span> <span class="n">xlen</span> <span class="o">*</span> <span class="n">xfrac</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xfade</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">xlen</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xfade</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">xlen</span>

        <span class="n">apply_costaper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GaussTaper"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.GaussTaper">[docs]</a><span class="k">class</span> <span class="nc">GaussTaper</span><span class="p">(</span><span class="n">Taper</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span> <span class="o">=</span> <span class="n">alpha</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span> <span class="p">)</span><span class="o">*</span><span class="n">dx</span>
        <span class="n">y</span> <span class="o">*=</span> <span class="n">num</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">f</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FrequencyResponse"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.FrequencyResponse">[docs]</a><span class="k">class</span> <span class="nc">FrequencyResponse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Evaluates frequency response at given frequencies.&#39;&#39;&#39;</span>
    
<div class="viewcode-block" id="FrequencyResponse.evaluate"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.FrequencyResponse.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">freqs</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">coefs</span>
   </div></div>
<div class="viewcode-block" id="InverseEvalresp"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.InverseEvalresp">[docs]</a><span class="k">class</span> <span class="nc">InverseEvalresp</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Calls evalresp and generates values of the inverse instrument response for </span>
<span class="sd">       deconvolution of instrument response.</span>
<span class="sd">       </span>
<span class="sd">       :param respfile: response file in evalresp format</span>
<span class="sd">       :param trace: trace for which the response is to be extracted from the file</span>
<span class="sd">       :param target: ``&#39;dis&#39;`` for displacement or ``&#39;vel&#39;`` for velocity</span>
<span class="sd">       &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">respfile</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s">&#39;dis&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">respfile</span> <span class="o">=</span> <span class="n">respfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nslc_id</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">nslc_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instant</span> <span class="o">=</span> <span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="n">trace</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        
<div class="viewcode-block" id="InverseEvalresp.evaluate"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.InverseEvalresp.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nslc_id</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">evalresp</span><span class="o">.</span><span class="n">evalresp</span><span class="p">(</span><span class="n">sta_list</span><span class="o">=</span><span class="n">station</span><span class="p">,</span>
                          <span class="n">cha_list</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span>
                          <span class="n">net_code</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
                          <span class="n">locid</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                          <span class="n">instant</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instant</span><span class="p">,</span>
                          <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span>
                          <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                          <span class="nb">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">respfile</span><span class="p">,</span>
                          <span class="n">rtype</span><span class="o">=</span><span class="s">&#39;CS&#39;</span><span class="p">)</span>
        
        <span class="n">transfer</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="n">transfer</span>
</div></div>
<div class="viewcode-block" id="PoleZeroResponse"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.PoleZeroResponse">[docs]</a><span class="k">class</span> <span class="nc">PoleZeroResponse</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Evaluates frequency response from pole-zero representation.</span>

<span class="sd">    ::</span>

<span class="sd">                           (j*2*pi*f - zeros[0]) * (j*2*pi*f - zeros[1]) * ... </span>
<span class="sd">         T(f) = constant * -------------------------------------------------------</span>
<span class="sd">                           (j*2*pi*f - poles[0]) * (j*2*pi*f - poles[1]) * ...</span>
<span class="sd">    </span>
<span class="sd">   </span>
<span class="sd">    The poles and zeros should be given as angular frequencies, not in Hz.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">poles</span><span class="p">,</span> <span class="n">constant</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zeros</span> <span class="o">=</span> <span class="n">zeros</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poles</span> <span class="o">=</span> <span class="n">poles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constant</span> <span class="o">=</span> <span class="n">constant</span>
        
<div class="viewcode-block" id="PoleZeroResponse.evaluate"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.PoleZeroResponse.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="n">jomeg</span> <span class="o">=</span> <span class="mf">1.0</span><span class="n">j</span><span class="o">*</span> <span class="mf">2.</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freqs</span>
        
        <span class="n">a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">freqs</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">constant</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeros</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">*=</span> <span class="n">jomeg</span><span class="o">-</span><span class="n">z</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">poles</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">/=</span> <span class="n">jomeg</span><span class="o">-</span><span class="n">p</span>
        
        <span class="k">return</span> <span class="n">a</span>
        </div></div>
<div class="viewcode-block" id="SampledResponse"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.SampledResponse">[docs]</a><span class="k">class</span> <span class="nc">SampledResponse</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Interpolates frequency response given at a set of sampled frequencies.</span>
<span class="sd">    </span>
<span class="sd">    :param freqs,vals: frequencies and values of the sampled response function.</span>
<span class="sd">    :param left,right: values to return when input is out of range. If set to ``None`` (the default) the endpoints are returned.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span>
        
<div class="viewcode-block" id="SampledResponse.evaluate"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.SampledResponse.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="n">ereal</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">),</span> <span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
        <span class="n">eimag</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">),</span> <span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
        <span class="n">transfer</span> <span class="o">=</span> <span class="n">ereal</span> <span class="o">+</span> <span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="n">eimag</span>
        <span class="k">return</span> <span class="n">transfer</span>
    </div>
<div class="viewcode-block" id="SampledResponse.inverse"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.SampledResponse.inverse">[docs]</a>    <span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get inverse as a new :py:class:`SampledResponse` object.&#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">inv_or_none</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="n">x</span>
            
        <span class="k">return</span> <span class="n">SampledResponse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">inv_or_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">),</span> <span class="n">right</span><span class="o">=</span><span class="n">inv_or_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">))</span>
    </div>
<div class="viewcode-block" id="SampledResponse.frequencies"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.SampledResponse.frequencies">[docs]</a>    <span class="k">def</span> <span class="nf">frequencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span>
    </div>
<div class="viewcode-block" id="SampledResponse.values"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.SampledResponse.values">[docs]</a>    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span>
    </div></div>
<div class="viewcode-block" id="IntegrationResponse"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.IntegrationResponse">[docs]</a><span class="k">class</span> <span class="nc">IntegrationResponse</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;The integration response, optionally multiplied by a constant gain.</span>

<span class="sd">    ::</span>

<span class="sd">                    gain</span>
<span class="sd">        T(f) = --------------</span>
<span class="sd">               (j*2*pi * f)^n</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">=</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gain</span> <span class="o">=</span> <span class="n">gain</span>
        
<div class="viewcode-block" id="IntegrationResponse.evaluate"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.IntegrationResponse.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gain</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freqs</span><span class="p">)</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span>
</div></div>
<div class="viewcode-block" id="DifferentiationResponse"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.DifferentiationResponse">[docs]</a><span class="k">class</span> <span class="nc">DifferentiationResponse</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;The differentiation response, optionally multiplied by a constant gain.</span>

<span class="sd">    ::</span>

<span class="sd">        T(f) = gain * (j*2*pi * f)^n</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">=</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gain</span> <span class="o">=</span> <span class="n">gain</span>
        
<div class="viewcode-block" id="DifferentiationResponse.evaluate"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.DifferentiationResponse.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gain</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">freqs</span><span class="p">)</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span>
</div></div>
<div class="viewcode-block" id="AnalogFilterResponse"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.AnalogFilterResponse">[docs]</a><span class="k">class</span> <span class="nc">AnalogFilterResponse</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Frequency response of an analog filter.</span>
<span class="sd">    </span>
<span class="sd">    (see :py:func:`scipy.signal.freqs`).&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="o">=</span> <span class="n">b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="o">=</span> <span class="n">a</span>
    
<div class="viewcode-block" id="AnalogFilterResponse.evaluate"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.AnalogFilterResponse.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">signal</span><span class="o">.</span><span class="n">freqs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span><span class="p">,</span> <span class="n">freqs</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
</div></div>
<div class="viewcode-block" id="MultiplyResponse"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.MultiplyResponse">[docs]</a><span class="k">class</span> <span class="nc">MultiplyResponse</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Multiplication of two :py:class:`FrequencyResponse` objects.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="o">=</span> <span class="n">b</span>

<div class="viewcode-block" id="MultiplyResponse.evaluate"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.MultiplyResponse.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
</div></div>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">need_python_2_5.trace</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">cached_coefficients</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">def</span> <span class="nf">_get_cached_filter_coefs</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">corners</span><span class="p">,</span> <span class="n">btype</span><span class="p">):</span>
    <span class="n">ck</span> <span class="o">=</span> <span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">corners</span><span class="p">),</span> <span class="n">btype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ck</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cached_coefficients</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corners</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cached_coefficients</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">btype</span><span class="o">=</span><span class="n">btype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cached_coefficients</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">corners</span><span class="p">,</span> <span class="n">btype</span><span class="o">=</span><span class="n">btype</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cached_coefficients</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span>
    
    
<span class="k">class</span> <span class="nc">_globals</span><span class="p">:</span>
    <span class="n">_numpy_has_correlate_flip_bug</span> <span class="o">=</span> <span class="bp">None</span>

<span class="n">_default_key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tr</span><span class="p">:</span> <span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>

<div class="viewcode-block" id="numpy_has_correlate_flip_bug"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.numpy_has_correlate_flip_bug">[docs]</a><span class="k">def</span> <span class="nf">numpy_has_correlate_flip_bug</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Check if NumPy&#39;s correlate function reveals old behaviour&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">_globals</span><span class="o">.</span><span class="n">_numpy_has_correlate_flip_bug</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ab</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">ba</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">_globals</span><span class="o">.</span><span class="n">_numpy_has_correlate_flip_bug</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ab</span> <span class="o">==</span> <span class="n">ba</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">_globals</span><span class="o">.</span><span class="n">_numpy_has_correlate_flip_bug</span>
</div>
<div class="viewcode-block" id="autocorr"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.autocorr">[docs]</a><span class="k">def</span> <span class="nf">autocorr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nshifts</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Compute biased estimate of the first autocorrelation coefficients.</span>
<span class="sd">    </span>
<span class="sd">    :param x: input array</span>
<span class="sd">    :param nshifts: number of coefficients to calculate</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">mean</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span>
    <span class="n">xdm</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">mean</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nshifts</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nshifts</span><span class="p">):</span>
        <span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">((</span><span class="n">n</span><span class="o">-</span><span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">std</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">xdm</span><span class="p">[:</span><span class="n">n</span><span class="o">-</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">xdm</span><span class="p">[</span><span class="n">k</span><span class="p">:]</span> <span class="p">)</span>
        
    <span class="k">return</span> <span class="n">r</span>
</div>
<div class="viewcode-block" id="yulewalker"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.yulewalker">[docs]</a><span class="k">def</span> <span class="nf">yulewalker</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Compute autoregression coefficients using Yule-Walker method.</span>
<span class="sd">    </span>
<span class="sd">    :param x: input array</span>
<span class="sd">    :param order: number of coefficients to produce</span>

<span class="sd">    A biased estimate of the autocorrelation is used. The Yule-Walker equations</span>
<span class="sd">    are solved by :py:func:`numpy.linalg.inv` instead of Levinson-Durbin</span>
<span class="sd">    recursion which is normally used.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">gamma</span> <span class="o">=</span> <span class="n">autocorr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="n">order</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">order</span><span class="p">,</span><span class="n">order</span><span class="p">))</span>
    <span class="n">gamma2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">gamma</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">order</span><span class="p">])</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
        <span class="n">ioff</span> <span class="o">=</span> <span class="n">order</span><span class="o">-</span><span class="n">i</span>
        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">gamma2</span><span class="p">[</span><span class="n">ioff</span><span class="p">:</span><span class="n">ioff</span><span class="o">+</span><span class="n">order</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="o">-</span><span class="n">d</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="moving_avg"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.moving_avg">[docs]</a><span class="k">def</span> <span class="nf">moving_avg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cx</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">nn</span><span class="o">-</span><span class="n">n</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span><span class="o">-</span><span class="n">cx</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">])</span><span class="o">/</span><span class="n">n</span>
    <span class="n">y</span><span class="p">[:</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">nn</span><span class="o">-</span><span class="n">n</span><span class="p">):]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">nn</span><span class="o">-</span><span class="n">n</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">y</span>
</div>
<div class="viewcode-block" id="moving_sum"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.moving_sum">[docs]</a><span class="k">def</span> <span class="nf">moving_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">n</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;valid&#39;</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;valid&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nn</span><span class="o">-</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cx</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> 
        <span class="n">y</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="o">-</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cx</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span><span class="o">-</span><span class="n">cx</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;full&#39;</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="o">+</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cx</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="o">-</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span><span class="o">-</span><span class="n">cx</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span>
        <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cx</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">y</span>
</div>
<div class="viewcode-block" id="nextpow2"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.nextpow2">[docs]</a><span class="k">def</span> <span class="nf">nextpow2</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">2</span><span class="o">**</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
    </div>
<div class="viewcode-block" id="snapper_w_offset"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.snapper_w_offset">[docs]</a><span class="k">def</span> <span class="nf">snapper_w_offset</span><span class="p">(</span><span class="n">nmax</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">snapfun</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">snap</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="n">snapfun</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">offset</span><span class="p">)</span><span class="o">/</span><span class="n">delta</span><span class="p">),</span><span class="n">nmax</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">snap</span>
</div>
<div class="viewcode-block" id="snapper"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.snapper">[docs]</a><span class="k">def</span> <span class="nf">snapper</span><span class="p">(</span><span class="n">nmax</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">snapfun</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">snap</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="n">snapfun</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">delta</span><span class="p">),</span><span class="n">nmax</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">snap</span>
</div>
<div class="viewcode-block" id="apply_costaper"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.apply_costaper">[docs]</a><span class="k">def</span> <span class="nf">apply_costaper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="n">snapper_w_offset</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[:</span><span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">y</span><span class="p">[</span><span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">):</span><span class="n">hi</span><span class="p">(</span><span class="n">b</span><span class="p">)]</span> <span class="o">*=</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">dx</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="n">hi</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">-</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">x0</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">hi</span><span class="p">(</span><span class="n">c</span><span class="p">):</span><span class="n">hi</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span> <span class="o">*=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">dx</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hi</span><span class="p">(</span><span class="n">c</span><span class="p">),</span><span class="n">hi</span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="o">-</span><span class="p">(</span><span class="n">c</span><span class="o">-</span><span class="n">x0</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">hi</span><span class="p">(</span><span class="n">d</span><span class="p">):]</span> <span class="o">=</span> <span class="mf">0.</span>
</div>
<div class="viewcode-block" id="costaper"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.costaper">[docs]</a><span class="k">def</span> <span class="nf">costaper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span> <span class="n">nfreqs</span><span class="p">,</span> <span class="n">deltaf</span><span class="p">):</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="n">snapper</span><span class="p">(</span><span class="n">nfreqs</span><span class="p">,</span> <span class="n">deltaf</span><span class="p">)</span>
    <span class="n">tap</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nfreqs</span><span class="p">)</span>
    <span class="n">tap</span><span class="p">[</span><span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">):</span><span class="n">hi</span><span class="p">(</span><span class="n">b</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">deltaf</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="n">hi</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">tap</span><span class="p">[</span><span class="n">hi</span><span class="p">(</span><span class="n">b</span><span class="p">):</span><span class="n">hi</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">tap</span><span class="p">[</span><span class="n">hi</span><span class="p">(</span><span class="n">c</span><span class="p">):</span><span class="n">hi</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">deltaf</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hi</span><span class="p">(</span><span class="n">c</span><span class="p">),</span><span class="n">hi</span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">tap</span>
</div>
<div class="viewcode-block" id="t2ind"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.t2ind">[docs]</a><span class="k">def</span> <span class="nf">t2ind</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">tdelta</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="nb">round</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">snap</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">tdelta</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="hilbert"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.hilbert">[docs]</a><span class="k">def</span> <span class="nf">hilbert</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return the hilbert transform of x of length N.</span>

<span class="sd">    (from scipy.signal, but changed to use fft and ifft from numpy.fft)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;N must be positive.&quot;</span>
    <span class="k">if</span> <span class="n">num</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;Warning: imaginary part of x ignored.&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">Xf</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">:(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="p">[:,</span> <span class="n">newaxis</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">Xf</span><span class="o">*</span><span class="n">h</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
    
        </div>
</pre></div>

          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Pyrocko v0.2 Manual</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Sebastian Heimann.
    </div>
  </body>
</html>