

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyrocko.cake &mdash; Pyrocko v0.2 Manual</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Pyrocko v0.2 Manual"
          href="../../_static/opensearch.xml"/>
    <link rel="top" title="Pyrocko v0.2 Manual" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Pyrocko v0.2 Manual</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <h1>Source code for pyrocko.cake</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">inspect</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">cmath</span><span class="o">,</span> <span class="nn">operator</span>
<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">bisect</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">fitpack</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">num</span>

<span class="n">ZEPS</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">P</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">S</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">DOWN</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">UP</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span>

<span class="n">r2d</span> <span class="o">=</span> <span class="mf">180.</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span>
<span class="n">d2r</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">r2d</span>
<span class="n">km</span> <span class="o">=</span> <span class="mf">1000.</span>

<div class="viewcode-block" id="castagna_vs_to_vp"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.castagna_vs_to_vp">[docs]</a><span class="k">def</span> <span class="nf">castagna_vs_to_vp</span><span class="p">(</span><span class="n">vs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Calculate vp from vs using castagna&#39;s relation.</span>

<span class="sd">    Castagna&#39;s relation (the mudrock line) is an empirical relation for vp/vs for </span>
<span class="sd">    siliciclastic rocks (i.e. sandstones and shales). [Castagna et al., 1985]</span>

<span class="sd">        vp = 1.16 * vs + 1360 [m/s]</span>

<span class="sd">    :param vs: S-wave velocity [m/s]</span>
<span class="sd">    :returns: vp in [m/s]</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">vs</span><span class="o">*</span><span class="mf">1.16</span> <span class="o">+</span> <span class="mf">1360.0</span>
</div>
<span class="k">def</span> <span class="nf">evenize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">minsize</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">minsize</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="n">ry</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">ry</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">ry</span>
    
    <span class="n">s</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> 
    <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x2</span>

<div class="viewcode-block" id="filled"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.filled">[docs]</a><span class="k">def</span> <span class="nf">filled</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create NumPy array filled with given value.</span>

<span class="sd">    This works like :py:func:`numpy.ones` but initializes the array with `v` instead</span>
<span class="sd">    of ones.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">x</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</div>
<span class="k">def</span> <span class="nf">next_or_none</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">i</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">reci_or_none</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="n">x</span>
    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<div class="viewcode-block" id="monotony"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.monotony">[docs]</a><span class="k">def</span> <span class="nf">monotony</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Check if an array is strictly increasing or decreasing.</span>
<span class="sd">    </span>
<span class="sd">    Given an array `x`, returns `1` if the values of x are in strictly</span>
<span class="sd">    increasing order and `-1` if they are in strictly decreasing order, or zero</span>
<span class="sd">    otherwise.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">p</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="o">-</span><span class="n">p</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
</div>
<span class="k">def</span> <span class="nf">xytups</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">num</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">monoton</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">monoton</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xytups</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">monoton</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xytups</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xp</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">fp</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">xv</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">xp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">xv</span> <span class="p">,</span> <span class="n">xv</span> <span class="o">&lt;</span> <span class="n">xp</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fvs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                <span class="n">xr</span> <span class="o">=</span> <span class="p">(</span><span class="n">xv</span> <span class="o">-</span> <span class="n">xp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">xp</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">fv</span> <span class="o">=</span> <span class="n">xr</span><span class="o">*</span><span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">xr</span><span class="p">)</span><span class="o">*</span><span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">fs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xv</span><span class="p">,</span><span class="n">fv</span><span class="p">))</span>
                
        <span class="k">return</span> <span class="n">fs</span>

<span class="k">def</span> <span class="nf">float_or_none</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parstore_float</span><span class="p">(</span><span class="n">thelocals</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">thelocals</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s">&#39;self&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">float_or_none</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">InvalidArguments</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<div class="viewcode-block" id="Material"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.Material">[docs]</a><span class="k">class</span> <span class="nc">Material</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Isotropic elastic material.</span>

<span class="sd">    :param vp: P-wave velocity [m/s]</span>
<span class="sd">    :param vs: S-wave velocity [m/s]</span>
<span class="sd">    :param rho: density [kg/m^3]</span>
<span class="sd">    :param qp: P-wave attenuation Qp</span>
<span class="sd">    :param qs: S-wave attenuation Qs</span>
<span class="sd">    :param poisson: Poisson ratio (only used if either `vp` or `vs` is not given)</span>
<span class="sd">    :param lame: tuple with Lame parameter `lambda` and `shear modulus` [Pa] (only used if `vp` and `vs` are not given)</span>
<span class="sd">    :param qk: bulk attenuation Qk (only used if `qp` and `qs` are not given)</span>
<span class="sd">    :param qmu: shear attenuation Qmu (only used if `qp` and `qs` are not given)</span>

<span class="sd">    If no velocities and no lame parameters are given, standard crustal values of vp = 5800 m/s and vs = 3200 m/s are used.</span>
<span class="sd">    If no Q values are given, standard crustal values of qp = 1456 and qs = 600 are used.</span>

<span class="sd">    Everything is in SI units (m/s, Pa, kg/m^3) unless explicitly stated.</span>

<span class="sd">    The returned object has the public attributes ``vp``, ``vs``, ``rho``,</span>
<span class="sd">    ``qp``, and ``qs``. Other material properties can be queried by instance methods.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vp</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="mf">2600.</span><span class="p">,</span> <span class="n">qp</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">poisson</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lame</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">qk</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">qmu</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">parstore_float</span><span class="p">(</span><span class="nb">locals</span><span class="p">(),</span> <span class="bp">self</span><span class="p">,</span> <span class="s">&#39;vp&#39;</span><span class="p">,</span> <span class="s">&#39;vs&#39;</span><span class="p">,</span> <span class="s">&#39;rho&#39;</span><span class="p">,</span> <span class="s">&#39;qp&#39;</span><span class="p">,</span> <span class="s">&#39;qs&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">vs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">poisson</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">lame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidArguments</span><span class="p">(</span><span class="s">&#39;If vp and vs are given, poisson ratio and lame paramters should not be given.&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">vp</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">vs</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">lame</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vp</span> <span class="o">=</span> <span class="mf">5800.</span>
            <span class="k">if</span> <span class="n">poisson</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">poisson</span> <span class="o">=</span> <span class="mf">0.25</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">poisson</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">poisson</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">vp</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">vs</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">lame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">poisson</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidArguments</span><span class="p">(</span><span class="s">&#39;Poisson ratio should not be given, when lame parameters are given.&#39;</span><span class="p">)</span>
            <span class="n">lam</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lame</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">lame</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vp</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">lam</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mu</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">vp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">vs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">poisson</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">poisson</span> <span class="o">=</span> <span class="mf">0.25</span>
            <span class="k">if</span> <span class="n">lame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidArguments</span><span class="p">(</span><span class="s">&#39;If vp is given, Lame parameters should not be given.&#39;</span><span class="p">)</span>
            <span class="n">poisson</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">poisson</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">=</span> <span class="n">vp</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">poisson</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">poisson</span><span class="p">))</span>
        
        <span class="k">elif</span> <span class="n">vp</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">vs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">poisson</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">poisson</span> <span class="o">=</span> <span class="mf">0.25</span>
            <span class="k">if</span> <span class="n">lame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidArguments</span><span class="p">(</span><span class="s">&#39;If vs is given, Lame parameters should not be given.&#39;</span><span class="p">)</span>
            <span class="n">poisson</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">poisson</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vp</span> <span class="o">=</span> <span class="n">vs</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">poisson</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">poisson</span><span class="p">))</span>
    
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidArguments</span><span class="p">(</span><span class="s">&#39;Invalid combination of input parameters in material definition.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">qp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">qs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">qk</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">qmu</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InvalidArguments</span><span class="p">(</span><span class="s">&#39;if qp or qs are given, qk and qmu should not be given.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">qp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qp</span> <span class="o">=</span> <span class="mf">1456.</span>
            <span class="k">if</span> <span class="n">qs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qs</span> <span class="o">=</span> <span class="mf">600.</span>
        
        <span class="k">elif</span> <span class="n">qp</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">qs</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">qk</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">qmu</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qp</span> <span class="o">=</span> <span class="mf">1456.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qs</span> <span class="o">=</span> <span class="mf">600.</span>

        <span class="k">elif</span> <span class="n">qp</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">qs</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">qk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">qmu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">qmu</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">l</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">qk</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qs</span> <span class="o">=</span> <span class="n">qmu</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidArguments</span><span class="p">(</span><span class="s">&#39;Invalid combination of input parameters in material definition.&#39;</span><span class="p">)</span>
    
<div class="viewcode-block" id="Material.astuple"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.Material.astuple">[docs]</a>    <span class="k">def</span> <span class="nf">astuple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs</span>
</div>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">astuple</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">astuple</span><span class="p">()</span>

<div class="viewcode-block" id="Material.lame"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.Material.lame">[docs]</a>    <span class="k">def</span> <span class="nf">lame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get Lame&#39;s parameter lambda and shear modulus.&#39;&#39;&#39;</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span>
        <span class="n">lam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">mu</span>
        <span class="k">return</span> <span class="n">lam</span><span class="p">,</span> <span class="n">mu</span>
</div>
<div class="viewcode-block" id="Material.lame_lambda"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.Material.lame_lambda">[docs]</a>    <span class="k">def</span> <span class="nf">lame_lambda</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get Lame&#39;s parameter lambda.</span>
<span class="sd">        </span>
<span class="sd">        Returned units are [Pa].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">lam</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lam</span>
</div>
<div class="viewcode-block" id="Material.shear_modulus"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.Material.shear_modulus">[docs]</a>    <span class="k">def</span> <span class="nf">shear_modulus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get shear modulus.</span>
<span class="sd">        </span>
<span class="sd">        Returned units are [Pa].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span>
</div>
<div class="viewcode-block" id="Material.poisson"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.Material.poisson">[docs]</a>    <span class="k">def</span> <span class="nf">poisson</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get Poisson&#39;s ratio.&#39;&#39;&#39;</span>
        <span class="n">lam</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lam</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="n">lam</span><span class="o">+</span><span class="n">mu</span><span class="p">))</span>
   </div>
<div class="viewcode-block" id="Material.bulk"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.Material.bulk">[docs]</a>    <span class="k">def</span> <span class="nf">bulk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get bulk modulus.&#39;&#39;&#39;</span>
        <span class="n">lam</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lam</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">mu</span><span class="o">/</span><span class="mf">3.0</span>
</div>
<div class="viewcode-block" id="Material.youngs"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.Material.youngs">[docs]</a>    <span class="k">def</span> <span class="nf">youngs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get Young&#39;s modulus.&#39;&#39;&#39;</span>
        <span class="n">lam</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">lam</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">lam</span><span class="o">+</span><span class="n">mu</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Material.vp_vs_ratio"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.Material.vp_vs_ratio">[docs]</a>    <span class="k">def</span> <span class="nf">vp_vs_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get vp/vs ratio.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span>
</div>
<div class="viewcode-block" id="Material.qmu"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.Material.qmu">[docs]</a>    <span class="k">def</span> <span class="nf">qmu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get shear attenuation coefficient Qmu.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs</span>
</div>
<div class="viewcode-block" id="Material.qk"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.Material.qk">[docs]</a>    <span class="k">def</span> <span class="nf">qk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get bulk attenuation coefficient Qk.&#39;&#39;&#39;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">l</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">qp</span><span class="p">)</span> <span class="o">-</span> <span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_rayleigh_equation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="n">cr_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">cr</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">cr_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">cr</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">cr_a</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="n">cr_b</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        
        <span class="k">return</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">-</span><span class="n">cr_b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">cr_a</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">cr_b</span><span class="p">)</span>

<div class="viewcode-block" id="Material.rayleigh"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.Material.rayleigh">[docs]</a>    <span class="k">def</span> <span class="nf">rayleigh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get rayleigh velocity assuming a homogenous halfspace.</span>
<span class="sd">        </span>
<span class="sd">        Returned units are [m/s].&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">bisect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rayleigh_equation</span><span class="p">,</span> <span class="mf">0.001</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Material.describe"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.Material.describe">[docs]</a>    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get a readable listing of the material properties.&#39;&#39;&#39;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">P wave velocity     [km/s]    : </span><span class="si">%12g</span><span class="s"></span>
<span class="s">S wave velocity     [km/s]    : </span><span class="si">%12g</span><span class="s"></span>
<span class="s">P/S wave vel. ratio           : </span><span class="si">%12g</span><span class="s">     </span>
<span class="s">Lame lambda         [GPa]     : </span><span class="si">%12g</span><span class="s"></span>
<span class="s">Lame shear modulus  [GPa]     : </span><span class="si">%12g</span><span class="s"></span>
<span class="s">Poisson ratio                 : </span><span class="si">%12g</span><span class="s"></span>
<span class="s">Bulk modulus        [GPa]     : </span><span class="si">%12g</span><span class="s"></span>
<span class="s">Young&#39;s modulus     [GPa]     : </span><span class="si">%12g</span><span class="s"></span>
<span class="s">Rayleigh wave vel.  [km/s]    : </span><span class="si">%12g</span><span class="s"></span>
<span class="s">Density             [g/cm**3] : </span><span class="si">%12g</span><span class="s"></span>
<span class="s">Qp                            : </span><span class="si">%12g</span><span class="s"></span>
<span class="s">Qs = Qmu                      : </span><span class="si">%12g</span><span class="s"></span>
<span class="s">Qk                            : </span><span class="si">%12g</span><span class="s"></span>
<span class="s">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">template</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lame_lambda</span><span class="p">()</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shear_modulus</span><span class="p">()</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">poisson</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bulk</span><span class="p">()</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">youngs</span><span class="p">()</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rayleigh</span><span class="p">()</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">())</span>
</div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vp</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span> <span class="n">qs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astuple</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%10g</span><span class="s"> km/s  </span><span class="si">%10g</span><span class="s"> km/s </span><span class="si">%10g</span><span class="s"> g/cm^3 </span><span class="si">%10g</span><span class="s"> </span><span class="si">%10g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vp</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">vs</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">rho</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Material(vp=</span><span class="si">%s</span><span class="s">, vs=</span><span class="si">%s</span><span class="s">, rho=</span><span class="si">%s</span><span class="s">, qp=</span><span class="si">%s</span><span class="s">, qs=</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> \
                <span class="nb">tuple</span><span class="p">(</span> <span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="p">)</span> <span class="p">)</span>

</div>
<div class="viewcode-block" id="Leg"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.Leg">[docs]</a><span class="k">class</span> <span class="nc">Leg</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Represents a continuous piece of wave propagation in a :py:class:`PhaseDef`.&#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">departure</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">departure</span> <span class="o">=</span> <span class="n">departure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depthmin</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depthmax</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set_depthmin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depthmin</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depthmin</span> <span class="o">=</span> <span class="n">depthmin</span>
    
    <span class="k">def</span> <span class="nf">set_depthmax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depthmax</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depthmax</span> <span class="o">=</span> <span class="n">depthmax</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">sd</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="k">return</span> <span class="s">&#39;</span><span class="si">%g</span><span class="s"> km&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="n">km</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&#39;interface </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">d</span>
        
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> mode propagation, departing </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">smode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="p">{</span><span class="n">UP</span><span class="p">:</span> <span class="s">&#39;upward&#39;</span><span class="p">,</span> <span class="n">DOWN</span><span class="p">:</span> <span class="s">&#39;downward&#39;</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">departure</span><span class="p">])</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">depthmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;deeper than </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>  <span class="n">sd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depthmax</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">depthmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;shallower than </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">sd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depthmin</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">sc</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&#39; (may not propagate </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="s">&#39; or &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">s</span>
</div>
<span class="k">class</span> <span class="nc">InvalidKneeDef</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<div class="viewcode-block" id="Knee"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.Knee">[docs]</a><span class="k">class</span> <span class="nc">Knee</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Represents a change in wave propagation within a :py:class:`PhaseDef`.&#39;&#39;&#39;</span>

    <span class="n">defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="s">&#39;surface&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">UP</span><span class="p">,</span> <span class="n">conversion</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">reflection</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">in_setup_state</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">defaults_surface</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="s">&#39;surface&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">UP</span><span class="p">,</span> <span class="n">conversion</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">reflection</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">in_setup_state</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span> <span class="o">=</span> <span class="n">args</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conversion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_setup_state</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;depth&#39;</span><span class="p">,</span> <span class="s">&#39;surface&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="s">&#39;surface&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Knee</span><span class="o">.</span><span class="n">defaults_surface</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Knee</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> 

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_setup_state</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="n">InvalidKneeDef</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> has already been set&#39;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_leg</span><span class="p">,</span> <span class="n">out_leg</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">out_leg</span><span class="o">.</span><span class="n">departure</span> <span class="o">==</span> <span class="n">UP</span> <span class="ow">and</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">UP</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidKneeDef</span><span class="p">(</span><span class="s">&#39;cannot enter </span><span class="si">%s</span><span class="s"> from </span><span class="si">%s</span><span class="s"> and emit ray upwards&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="p">[</span><span class="s">&#39;conversion&#39;</span><span class="p">,</span> <span class="s">&#39;reflection&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">],</span>
                <span class="p">{</span><span class="n">UP</span><span class="p">:</span> <span class="s">&#39;below&#39;</span><span class="p">,</span> <span class="n">DOWN</span><span class="p">:</span> <span class="s">&#39;above&#39;</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">out_leg</span><span class="o">.</span><span class="n">departure</span> <span class="o">==</span> <span class="n">DOWN</span> <span class="ow">and</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidKneeDef</span><span class="p">(</span><span class="s">&#39;cannot enter </span><span class="si">%s</span><span class="s"> from </span><span class="si">%s</span><span class="s"> and emit ray downwards&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="p">[</span><span class="s">&#39;conversion&#39;</span><span class="p">,</span> <span class="s">&#39;reflection&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">],</span>
                <span class="p">{</span><span class="n">UP</span><span class="p">:</span> <span class="s">&#39;below&#39;</span><span class="p">,</span> <span class="n">DOWN</span><span class="p">:</span> <span class="s">&#39;above&#39;</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">in_leg</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">out_leg</span><span class="o">.</span><span class="n">mode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidKneeDef</span><span class="p">(</span><span class="s">&#39;mode of propagation should change at a conversion&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span> <span class="o">=</span> <span class="n">in_leg</span><span class="o">.</span><span class="n">mode</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span> <span class="o">=</span> <span class="n">out_leg</span><span class="o">.</span><span class="n">mode</span>

    <span class="k">def</span> <span class="nf">at_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">==</span> <span class="s">&#39;surface&#39;</span>

<div class="viewcode-block" id="Knee.matches"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.Knee.matches">[docs]</a>    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discontinuity</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">-</span> <span class="n">discontinuity</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ZEPS</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">discontinuity</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">direction</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span> <span class="o">==</span> <span class="n">mode</span>
</div>
<div class="viewcode-block" id="Knee.out_direction"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.Knee.out_direction">[docs]</a>    <span class="k">def</span> <span class="nf">out_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span>
</div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_surface</span><span class="p">():</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;surface&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">UP</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;underside&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;upperside&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversion</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;reflection with conversion from </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">smode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span><span class="p">),</span> <span class="n">smode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;reflection&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversion</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;conversion from </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">smode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span><span class="p">),</span> <span class="n">smode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;at interface in </span><span class="si">%g</span><span class="s"> km depth&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_surface</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;at </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">UP</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;on upgoing path&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;on downgoing path&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PhaseDefParseError"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.PhaseDefParseError">[docs]</a><span class="k">class</span> <span class="nc">PhaseDefParseError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">definition</span> <span class="o">=</span> <span class="n">definition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">exception</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Invalid phase definition: &quot;</span><span class="si">%s</span><span class="s">&quot; (at character </span><span class="si">%i</span><span class="s">: </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="PhaseDef"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.PhaseDef">[docs]</a><span class="k">class</span> <span class="nc">PhaseDef</span><span class="p">:</span>
   
    <span class="sd">&#39;&#39;&#39;Definition of a seismic propagation path.</span>
<span class="sd">    </span>
<span class="sd">    Seismic phases are conventionally named e.g. P, Pn, PP, PcP, etc. In this</span>
<span class="sd">    module a slightly different terminology is adapted, which allows to specify</span>
<span class="sd">    arbitrary conversion/reflection histories for seismic phases. The</span>
<span class="sd">    conventions used here are inspired by the conventions used in the TauP</span>
<span class="sd">    toolkit, but are not completely compatible with those.</span>

<span class="sd">    The definition of a seismic phase in the syntax implemented here is a</span>
<span class="sd">    string consisting of an alternating sequence of *legs* and *knees*. A *leg*</span>
<span class="sd">    here represents seismic wave propagation without any conversion,</span>
<span class="sd">    encountering only super-critical reflections. Legs are denoted by ``P``,</span>
<span class="sd">    ``p`` or ``S`` or ``s``. The capital letters are used when the take-off of</span>
<span class="sd">    the *leg* is in downward direction, while the lower case letter indicate a</span>
<span class="sd">    take-off in upward direction. A *knee* is denoted by a string of the form</span>
<span class="sd">    ``(INTERFACE)`` where INTERFACE is the name of an interface (which should</span>
<span class="sd">    be defined in the models which are used with this phase) or ``DEPTH``,</span>
<span class="sd">    where DEPTH is a number, for mode conversions, ``v(INTERFACE)`` or</span>
<span class="sd">    ``vDEPTH`` for top-side reflections or ``^(INTERFACE)`` or ``^DEPTH`` for</span>
<span class="sd">    underside reflections. When DEPTH is given as a numerical value, the</span>
<span class="sd">    interface closest to that depth is chosen. If two legs appear</span>
<span class="sd">    consecutively without an explicit *knee*, surface interaction is assumed.</span>
<span class="sd">    The string may end with a backslash ``\\``, to indicate that the ray should</span>
<span class="sd">    arrive at the receiver from above instead of from below, which is the</span>
<span class="sd">    default. It is possible to restrict the maximum and minimum depth of a</span>
<span class="sd">    *leg* by appending ``&lt;(INTERFACE)`` or ``&lt;DEPTH`` or ``&gt;(INTERFACE)`` or</span>
<span class="sd">    ``&gt;DEPTH`` after the leg character, respectively.</span>
<span class="sd">    </span>
<span class="sd">    Examples:</span>

<span class="sd">        * ``P`` - like the classical P, but includes PKP, PKIKP, Pg</span>
<span class="sd">        * ``P&lt;(moho)`` - like Pg, but must leave source downwards</span>
<span class="sd">        * ``pP`` - leaves source upward, reflects at surface, then travels as P</span>
<span class="sd">        * ``P(moho)s`` - conversion from P to S at the Moho on upgoing path</span>
<span class="sd">        * ``P(moho)S`` - conversion from P to S at the Moho on downgoing path</span>
<span class="sd">        * ``P^(conrad)P`` - underside reflection of P at the Conrad discontinuity</span>
<span class="sd">         </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">classic_defs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="s">&#39;mc&#39;</span><span class="p">:</span>
        <span class="c"># PmP PcP and the like:</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="s">&#39;PP PS SS SP&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="n">classic_defs</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">v(</span><span class="si">%s</span><span class="s">)</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;m&#39;</span><span class="p">:</span> <span class="s">&#39;moho&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="s">&#39;cmb&#39;</span><span class="p">}[</span><span class="n">r</span><span class="p">],</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="p">)</span> <span class="p">]</span>
       
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">&#39;PS&#39;</span><span class="p">:</span>
        <span class="n">classic_defs</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;g&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&lt;(moho)&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="p">]</span>
        <span class="n">classic_defs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&lt;(cmb)&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definition</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        
        <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sdepth</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">sinterface</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">depthmax</span> <span class="o">=</span> <span class="n">depthmin</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">depthlim</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">depthlimtype</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">sdethmlim</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">direction_stop</span> <span class="o">=</span> <span class="n">UP</span>
        <span class="n">need_leg</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">ic</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">definition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">knee</span> <span class="o">=</span> <span class="n">Knee</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ic</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">definition</span><span class="p">):</span>

                    <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
                        
                        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">&#39;0123456789.&#39;</span><span class="p">:</span>
                            <span class="n">need_leg</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">sdepth</span> <span class="o">+=</span> <span class="n">c</span>
                            <span class="k">continue</span>
                        
                        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">knee</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sdepth</span><span class="p">)</span><span class="o">*</span><span class="mf">1000.</span>
                            <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;)&#39;</span><span class="p">:</span>
                            <span class="n">knee</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">sinterface</span>
                            <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sinterface</span> <span class="o">+=</span> <span class="n">c</span> 

                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>

                        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">&#39;0123456789.&#39;</span><span class="p">:</span>
                                <span class="n">sdepthlim</span> <span class="o">+=</span> <span class="n">c</span>
                                <span class="k">continue</span>
                            <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
                                <span class="n">state</span> <span class="o">=</span> <span class="mi">4</span>
                                <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">depthlim</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sdepthlim</span><span class="p">)</span><span class="o">*</span><span class="mf">1000.</span>
                                <span class="k">if</span> <span class="n">depthlimtype</span> <span class="o">==</span> <span class="s">&#39;&lt;&#39;</span><span class="p">:</span>
                                    <span class="n">depthmax</span> <span class="o">=</span> <span class="n">depthlim</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">depthmin</span> <span class="o">=</span> <span class="n">depthlim</span>
                                <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

                        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;)&#39;</span><span class="p">:</span>
                                <span class="n">depthlim</span> <span class="o">=</span> <span class="n">sdepthlim</span>
                                <span class="k">if</span> <span class="n">depthlimtype</span> <span class="o">==</span> <span class="s">&#39;&lt;&#39;</span><span class="p">:</span>
                                    <span class="n">depthmax</span> <span class="o">=</span> <span class="n">depthlim</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">depthmin</span> <span class="o">=</span> <span class="n">depthlim</span>
                                <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">sdepthlim</span> <span class="o">+=</span> <span class="n">c</span>
                                <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
                            <span class="n">need_leg</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="n">state</span> <span class="o">=</span> <span class="mi">2</span>
                            <span class="k">continue</span>

                        <span class="k">elif</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">&#39;&lt;&gt;&#39;</span><span class="p">:</span>
                            <span class="n">state</span> <span class="o">=</span> <span class="mi">3</span>
                            <span class="n">depthlim</span> <span class="o">=</span> <span class="bp">None</span>
                            <span class="n">sdepthlim</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                            <span class="n">depthlimtype</span> <span class="o">=</span> <span class="n">c</span>
                            <span class="k">continue</span>
                        
                        <span class="k">elif</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">&#39;psPS&#39;</span><span class="p">:</span>
                            <span class="n">leg</span> <span class="o">=</span> <span class="n">Leg</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">&#39;ps&#39;</span><span class="p">:</span>
                                <span class="n">leg</span><span class="o">.</span><span class="n">departure</span> <span class="o">=</span> <span class="n">UP</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">leg</span><span class="o">.</span><span class="n">departure</span> <span class="o">=</span> <span class="n">DOWN</span>
                            <span class="n">leg</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">imode</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">events</span><span class="p">:</span>
                                <span class="n">in_leg</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">depthmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                    <span class="n">in_leg</span><span class="o">.</span><span class="n">set_depthmin</span><span class="p">(</span><span class="n">depthmin</span><span class="p">)</span>
                                    <span class="n">depthmin</span> <span class="o">=</span> <span class="bp">None</span>
                                <span class="k">if</span> <span class="n">depthmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                    <span class="n">in_leg</span><span class="o">.</span><span class="n">set_depthmax</span><span class="p">(</span><span class="n">depthmax</span><span class="p">)</span>
                                    <span class="n">depthmax</span> <span class="o">=</span> <span class="bp">None</span>
                                
                                <span class="k">if</span> <span class="n">in_leg</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">leg</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
                                    <span class="n">knee</span><span class="o">.</span><span class="n">conversion</span> <span class="o">=</span> <span class="bp">False</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">knee</span><span class="o">.</span><span class="n">conversion</span> <span class="o">=</span> <span class="bp">True</span>
                               
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">knee</span><span class="o">.</span><span class="n">reflection</span> <span class="ow">and</span> <span class="n">knee</span><span class="o">.</span><span class="n">conversion</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">&#39;ps&#39;</span><span class="p">:</span>
                                        <span class="n">knee</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">UP</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">knee</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">DOWN</span>

                                <span class="n">knee</span><span class="o">.</span><span class="n">set_modes</span><span class="p">(</span><span class="n">in_leg</span><span class="p">,</span> <span class="n">leg</span><span class="p">)</span>
                                <span class="n">knee</span><span class="o">.</span><span class="n">in_setup_state</span> <span class="o">=</span> <span class="bp">False</span>
                                <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">knee</span><span class="p">)</span>
                                <span class="n">knee</span> <span class="o">=</span> <span class="n">Knee</span><span class="p">()</span>
                                <span class="n">sdepth</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                                <span class="n">sinterface</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>


                            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leg</span><span class="p">)</span>
                            <span class="n">need_leg</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="k">continue</span>

                        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;^&#39;</span><span class="p">:</span>
                            <span class="n">need_leg</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="n">knee</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">UP</span>
                            <span class="n">knee</span><span class="o">.</span><span class="n">reflection</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">continue</span>

                        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;v&#39;</span><span class="p">:</span>
                            <span class="n">need_leg</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="n">knee</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">DOWN</span>
                            <span class="n">knee</span><span class="o">.</span><span class="n">reflection</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">continue</span>

                        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span>
                            <span class="n">direction_stop</span> <span class="o">=</span> <span class="n">DOWN</span>
                            <span class="k">continue</span>
                            
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">PhaseDefParseError</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="s">&#39;invalid character: &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">depthlim</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sdepthlim</span><span class="p">)</span><span class="o">*</span><span class="mf">1000.</span>
                    <span class="k">if</span> <span class="n">depthlimtype</span> <span class="o">==</span> <span class="s">&#39;&lt;&#39;</span><span class="p">:</span>
                        <span class="n">depthmax</span> <span class="o">=</span> <span class="n">depthlim</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">depthmin</span> <span class="o">=</span> <span class="n">depthlim</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">InvalidKneeDef</span><span class="p">),</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PhaseDefParseError</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            

            <span class="k">if</span> <span class="n">state</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">need_leg</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PhaseDefParseError</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="s">&#39;unfinished expression&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">events</span> <span class="ow">and</span> <span class="n">depthmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_depthmin</span><span class="p">(</span><span class="n">depthmin</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">events</span> <span class="ow">and</span> <span class="n">depthmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_depthmax</span><span class="p">(</span><span class="n">depthmax</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">definition</span> <span class="o">=</span> <span class="n">definition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">direction_stop</span> <span class="o">=</span> <span class="n">direction_stop</span>
   
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ev</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">first_leg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">last_leg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">legs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span> <span class="n">leg</span> <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">leg</span><span class="p">,</span> <span class="n">Leg</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">knees</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span> <span class="n">knee</span> <span class="k">for</span> <span class="n">knee</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">knee</span><span class="p">,</span> <span class="n">Knee</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">used_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">Leg</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">departure</span> <span class="o">==</span> <span class="n">UP</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smode</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smode</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">reflection</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">el</span><span class="o">.</span><span class="n">at_surface</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;v&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;^&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">el</span><span class="o">.</span><span class="n">at_surface</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">depth</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">el</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction_stop</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
   
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;PhaseDef(&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">definition</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_repr</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">definition</span> <span class="o">!=</span> <span class="n">used</span><span class="p">:</span>
            <span class="n">orig</span> <span class="o">=</span> <span class="s">&#39; (entered as &quot;</span><span class="si">%s</span><span class="s">&quot;)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">definition</span>

        <span class="n">sarrive</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s"> - arriving at target from </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;below&#39;</span><span class="p">,</span> <span class="s">&#39;above&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">direction_stop</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">]</span>
        <span class="k">return</span> <span class="s">&#39;Phase definition &quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="se">\n</span><span class="s"> - &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">used</span><span class="p">,</span> <span class="n">orig</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s"> - &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="n">sarrive</span>
        

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">csswap</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">cmath</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">psv_surface_ind</span><span class="p">(</span><span class="n">in_mode</span><span class="p">,</span> <span class="n">out_mode</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">in_mode</span><span class="o">==</span><span class="n">S</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">out_mode</span><span class="o">==</span><span class="n">S</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">psv_surface</span><span class="p">(</span><span class="n">material</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="n">vp</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">rho</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="n">material</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="n">material</span><span class="o">.</span><span class="n">rho</span>
    
    <span class="n">sinphi</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">vp</span>
    <span class="n">sinlam</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">vs</span>
    <span class="n">cosphi</span> <span class="o">=</span> <span class="n">csswap</span><span class="p">(</span> <span class="n">sinphi</span> <span class="p">)</span>
    <span class="n">coslam</span> <span class="o">=</span> <span class="n">csswap</span><span class="p">(</span> <span class="n">sinlam</span> <span class="p">)</span>
    <span class="n">vsp_term</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">vs</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
    <span class="n">pcc_term</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cosphi</span><span class="o">/</span><span class="n">vp</span> <span class="o">*</span> <span class="n">coslam</span><span class="o">/</span><span class="n">vs</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="n">vsp_term</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">pcc_term</span>

    <span class="n">scatter</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span> <span class="n">vsp_term</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">pcc_term</span><span class="p">,</span> <span class="mf">4.0</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">coslam</span><span class="o">/</span><span class="n">vp</span><span class="o">*</span><span class="n">vsp_term</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">4.0</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">cosphi</span><span class="o">/</span><span class="n">vs</span><span class="o">*</span><span class="n">vsp_term</span><span class="p">,</span> <span class="n">vsp_term</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">pcc_term</span> <span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">energy</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">scatter</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-16</span>
        <span class="n">normvec</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vp</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">cosphi</span><span class="o">+</span><span class="n">eps</span><span class="p">,</span> <span class="n">vs</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">coslam</span><span class="o">+</span><span class="n">eps</span><span class="p">])</span>
        <span class="n">escatter</span> <span class="o">=</span> <span class="n">scatter</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">normvec</span><span class="p">[:,</span><span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">normvec</span><span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]))</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">escatter</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">psv_solid_ind</span><span class="p">(</span><span class="n">in_direction</span><span class="p">,</span> <span class="n">out_direction</span><span class="p">,</span> <span class="n">in_mode</span><span class="p">,</span> <span class="n">out_mode</span><span class="p">):</span>
    <span class="k">return</span>  <span class="p">(</span><span class="n">out_direction</span><span class="o">==</span><span class="n">DOWN</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">out_mode</span><span class="o">==</span><span class="n">S</span><span class="p">),</span> <span class="p">(</span><span class="n">in_direction</span><span class="o">==</span><span class="n">UP</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">in_mode</span><span class="o">==</span><span class="n">S</span><span class="p">)</span>
    
<div class="viewcode-block" id="psv_solid"><a class="viewcode-back" href="../../cake.html#pyrocko.cake.psv_solid">[docs]</a><span class="k">def</span> <span class="nf">psv_solid</span><span class="p">(</span><span class="n">material1</span><span class="p">,</span> <span class="n">material2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Solid-solid interface scatter matrix.</span>

<span class="sd">    Taken from Aki &amp; Richards.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">vp1</span><span class="p">,</span> <span class="n">vs1</span><span class="p">,</span> <span class="n">rho1</span> <span class="o">=</span> <span class="n">material1</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="n">material1</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="n">material1</span><span class="o">.</span><span class="n">rho</span>
    <span class="n">vp2</span><span class="p">,</span> <span class="n">vs2</span><span class="p">,</span> <span class="n">rho2</span> <span class="o">=</span> <span class="n">material2</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="n">material2</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="n">material2</span><span class="o">.</span><span class="n">rho</span>
    
    <span class="n">sinphi1</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">vp1</span>
    <span class="n">cosphi1</span> <span class="o">=</span> <span class="n">csswap</span><span class="p">(</span> <span class="n">sinphi1</span> <span class="p">)</span>
    <span class="n">sinlam1</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">vs1</span>
    <span class="n">coslam1</span> <span class="o">=</span> <span class="n">csswap</span><span class="p">(</span> <span class="n">sinlam1</span> <span class="p">)</span>
    <span class="n">sinphi2</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">vp2</span>
    <span class="n">cosphi2</span> <span class="o">=</span> <span class="n">csswap</span><span class="p">(</span> <span class="n">sinphi2</span> <span class="p">)</span>
    <span class="n">sinlam2</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">vs2</span>
    <span class="n">coslam2</span> <span class="o">=</span> <span class="n">csswap</span><span class="p">(</span> <span class="n">sinlam2</span> <span class="p">)</span>
    
    <span class="c"># from aki and richards</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span> <span class="o">-</span><span class="n">vp1</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">-</span><span class="n">coslam1</span><span class="p">,</span> <span class="n">vp2</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">coslam2</span> <span class="p">],</span>
                   <span class="p">[</span> <span class="n">cosphi1</span><span class="p">,</span> <span class="o">-</span><span class="n">vs1</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">cosphi2</span><span class="p">,</span> <span class="o">-</span><span class="n">vs2</span><span class="o">*</span><span class="n">p</span> <span class="p">],</span>
                   <span class="p">[</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">rho1</span><span class="o">*</span><span class="n">vs1</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">cosphi1</span><span class="p">,</span> <span class="n">rho1</span><span class="o">*</span><span class="n">vs1</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">vs1</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> 
                     <span class="mf">2.0</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="n">vs2</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">cosphi2</span><span class="p">,</span> <span class="n">rho2</span><span class="o">*</span><span class="n">vs2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">vs2</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">],</span>
                   <span class="p">[</span> <span class="o">-</span><span class="n">rho1</span><span class="o">*</span><span class="n">vp1</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">vs1</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">rho1</span><span class="o">*</span><span class="n">vs1</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">coslam1</span><span class="p">,</span> 
                     <span class="n">rho2</span><span class="o">*</span><span class="n">vp2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">vs2</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="n">vs2</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">coslam2</span> <span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="n">N</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="n">scatter</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">N</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">energy</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">scatter</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-16</span>
        <span class="k">if</span> <span class="n">vs1</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">vs1</span> <span class="o">=</span> <span class="n">vp1</span><span class="o">*</span><span class="mf">1e-16</span>
        <span class="k">if</span> <span class="n">vs2</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">vs2</span> <span class="o">=</span> <span class="n">vp2</span><span class="o">*</span><span class="mf">1e-16</span>
        <span class="n">normvec</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vp1</span><span class="o">*</span><span class="n">rho1</span><span class="o">*</span><span class="p">(</span><span class="n">cosphi1</span><span class="o">+</span><span class="n">eps</span><span class="p">),</span> <span class="n">vs1</span><span class="o">*</span><span class="n">rho1</span><span class="o">*</span><span class="p">(</span><span class="n">coslam1</span><span class="o">+</span><span class="n">eps</span><span class="p">),</span> 
                             <span class="n">vp2</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="p">(</span><span class="n">cosphi2</span><span class="o">+</span><span class="n">eps</span><span class="p">),</span> <span class="n">vs2</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="p">(</span><span class="n">coslam2</span><span class="o">+</span><span class="n">eps</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="n">escatter</span> <span class="o">=</span> <span class="n">scatter</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">normvec</span><span class="p">[:,</span><span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">/</span> <span class="n">normvec</span><span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span>
        
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">escatter</span><span class="p">)</span>
</div>
<span class="k">class</span> <span class="nc">BadPotIntCoefs</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">potint_coefs</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">):</span>  <span class="c"># r2 &gt; r1</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">r2</span><span class="o">*</span><span class="mf">1e-9</span>
    <span class="k">if</span> <span class="n">c1</span> <span class="o">==</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">c2</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">c1c2</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c1c2</span> <span class="o">=</span> <span class="n">c1</span><span class="o">/</span><span class="n">c2</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">c1c2</span><span class="p">)</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">r1</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span><span class="o">/</span><span class="n">r2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">10.</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadPotIntCoefs</span><span class="p">()</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">c1</span><span class="o">/</span><span class="p">(</span><span class="n">r1</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span><span class="o">**</span><span class="n">b</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>

<span class="k">def</span> <span class="nf">imode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;p&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">P</span>
    <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;s&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">S</span>

<span class="k">def</span> <span class="nf">smode</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;p&#39;</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;s&#39;</span>

<span class="k">class</span> <span class="nc">SurfaceReached</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">BottomReached</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">MaxDepthReached</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">MinDepthReached</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">CannotPropagate</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">ilayer</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">=</span> <span class="n">direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ilayer</span> <span class="o">=</span> <span class="n">ilayer</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Cannot enter layer </span><span class="si">%i</span><span class="s"> from </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ilayer</span><span class="p">,</span> <span class="p">{</span><span class="n">UP</span><span class="p">:</span> <span class="s">&#39;below&#39;</span><span class="p">,</span> <span class="n">DOWN</span><span class="p">:</span> <span class="s">&#39;above&#39;</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">Layer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span> <span class="o">=</span> <span class="n">ztop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="o">=</span> <span class="n">zbot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zmid</span> <span class="o">=</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">_update_potint_coefs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ppic</span> <span class="o">=</span> <span class="n">potint_coefs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="p">),</span> <span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spic</span> <span class="o">=</span> <span class="n">potint_coefs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="p">),</span> <span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="n">BadPotIntCoefs</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">potint_coefs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ppic</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spic</span>

    <span class="k">def</span> <span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span> <span class="o">&lt;=</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_bottom</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_top</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span> <span class="o">&lt;=</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_bottom</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_top</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">at_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ZEPS</span>

    <span class="k">def</span> <span class="nf">at_top</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ztop</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ZEPS</span>

    <span class="k">def</span> <span class="nf">pflat_top</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pflat_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pflat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="n">z</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">xt_potint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">utop</span><span class="p">,</span> <span class="n">ubot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">us</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potint_coefs</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">ztop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span>
        <span class="n">zbot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span>
        <span class="k">if</span> <span class="n">zpart</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">utop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ubot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span> <span class="o">=</span> <span class="n">zpart</span>
            <span class="n">utop</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="n">ztop</span><span class="p">)</span><span class="o">**</span><span class="n">b</span><span class="p">)</span>
            <span class="n">ubot</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="n">zbot</span><span class="p">)</span><span class="o">**</span><span class="n">b</span><span class="p">)</span>
        
        <span class="n">r1</span> <span class="o">=</span> <span class="n">radius</span><span class="p">(</span><span class="n">zbot</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">radius</span><span class="p">(</span><span class="n">ztop</span><span class="p">)</span>
        <span class="n">eta1</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">*</span> <span class="n">ubot</span>
        <span class="n">eta2</span> <span class="o">=</span> <span class="n">r2</span> <span class="o">*</span> <span class="n">utop</span>
        <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">cpe</span><span class="p">(</span><span class="n">eta</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">num</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span><span class="n">p</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="mf">1.0</span><span class="p">))</span>
            <span class="k">def</span> <span class="nf">sep</span><span class="p">(</span><span class="n">eta</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">eta</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>

            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpe</span><span class="p">(</span><span class="n">eta2</span><span class="p">)</span><span class="o">-</span><span class="n">cpe</span><span class="p">(</span><span class="n">eta1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">b</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">sep</span><span class="p">(</span><span class="n">eta2</span><span class="p">)</span><span class="o">-</span><span class="n">sep</span><span class="p">(</span><span class="n">eta1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">b</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r2</span><span class="o">/</span><span class="n">r1</span><span class="p">)</span>
            <span class="n">sap</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">p</span><span class="o">/</span><span class="n">sap</span> <span class="o">*</span> <span class="n">lr</span>
            <span class="n">t</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sap</span><span class="p">)</span>
       
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">iturn</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">r2</span><span class="o">*</span><span class="n">utop</span> <span class="o">-</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r1</span><span class="o">*</span><span class="n">ubot</span> <span class="o">-</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">x</span><span class="p">[</span><span class="n">iturn</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">2.</span>
            <span class="n">t</span><span class="p">[</span><span class="n">iturn</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">2.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r2</span><span class="o">*</span><span class="n">utop</span> <span class="o">-</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">r1</span><span class="o">*</span><span class="n">ubot</span> <span class="o">-</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">*=</span> <span class="mf">2.</span>
                <span class="n">t</span> <span class="o">*=</span> <span class="mf">2.</span>
        
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">t</span>

    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="n">radius</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
   
    <span class="k">def</span> <span class="nf">zturn_potint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potint_coefs</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">b</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">earthradius</span><span class="o">-</span><span class="n">r</span>

    <span class="k">def</span> <span class="nf">propagate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
            <span class="n">zin</span><span class="p">,</span> <span class="n">zout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zin</span><span class="p">,</span> <span class="n">zout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">zin</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CannotPropagate</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ilayer</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">zout</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">direction</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">direction</span>

<span class="k">class</span> <span class="nc">DoesNotTurn</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">earthradius</span> <span class="o">=</span> <span class="mf">6371.</span><span class="o">*</span><span class="mf">1000.</span>
<span class="k">def</span> <span class="nf">radius</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">earthradius</span> <span class="o">-</span> <span class="n">z</span>

<span class="k">class</span> <span class="nc">HomogeneousLayer</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">Layer</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span> <span class="o">=</span> <span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span> <span class="o">=</span> <span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_potint_coefs</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">material</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span>

    <span class="k">def</span> <span class="nf">u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">vp</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">vs</span>

    <span class="k">def</span> <span class="nf">us</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">u</span>

    <span class="k">def</span> <span class="nf">v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">vp</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">vs</span>

    <span class="k">def</span> <span class="nf">vs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span><span class="p">,</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">xt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt_potint</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="p">)</span>
        
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">pflat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pflat_bottom</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zpart</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zpart</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">zpart</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="mf">0.001</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">pflat</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">eps</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">pflat</span><span class="o">/</span><span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">zmid</span><span class="p">)</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">/</span> <span class="n">denom</span> 
        <span class="n">t</span> <span class="o">=</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">/</span> <span class="n">denom</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span>

    <span class="k">def</span> <span class="nf">zturn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">zturn_potint</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
        
        <span class="k">raise</span> <span class="n">DoesNotTurn</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">HomogeneousLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">HomogeneousLayer</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">upper</span><span class="o">.</span><span class="n">ilayer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ilayer</span>
        <span class="n">lower</span><span class="o">.</span><span class="n">ilayer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ilayer</span>
        <span class="k">return</span> <span class="n">upper</span><span class="p">,</span> <span class="n">lower</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39; &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span><span class="p">:</span>
            <span class="n">calcmode</span> <span class="o">=</span> <span class="s">&#39;P&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">calcmode</span> <span class="o">=</span> <span class="s">&#39;H&#39;</span>

        <span class="k">return</span> <span class="s">&#39;  (</span><span class="si">%i</span><span class="s">) homogeneous layer </span><span class="si">%s</span><span class="s">(</span><span class="si">%g</span><span class="s"> km - </span><span class="si">%g</span><span class="s"> km) [</span><span class="si">%s</span><span class="s">]</span><span class="se">\n</span><span class="s">    </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ilayer</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="o">/</span><span class="n">km</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="o">/</span><span class="n">km</span><span class="p">,</span> <span class="n">calcmode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">GradientLayer</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="n">mtop</span><span class="p">,</span> <span class="n">mbot</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">Layer</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span> <span class="o">=</span> <span class="n">mtop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span> <span class="o">=</span> <span class="n">mbot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_potint_coefs</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ptop</span><span class="p">,</span> <span class="n">pbot</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ptop</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">pbot</span> <span class="o">-</span> <span class="n">ptop</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">)</span> 

    <span class="k">def</span> <span class="nf">material</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">dtop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">astuple</span><span class="p">()</span>
        <span class="n">dbot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">astuple</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ptop</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">ptop</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dtop</span><span class="p">,</span><span class="n">dbot</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">return</span> <span class="n">Material</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">us</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span>

    <span class="k">def</span> <span class="nf">u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">vs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span>

    <span class="k">def</span> <span class="nf">v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">xt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt_potint</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="p">)</span>

        <span class="n">utop</span><span class="p">,</span> <span class="n">ubot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">us</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">ubot</span> <span class="o">-</span> <span class="mf">1.</span><span class="o">/</span><span class="n">utop</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">)</span>
        <span class="n">pflat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pflat_bottom</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zpart</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">utop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ubot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">peps</span> <span class="o">=</span> <span class="mf">1e-16</span>
        <span class="n">pdp</span> <span class="o">=</span> <span class="n">pflat</span> <span class="o">+</span> <span class="n">peps</span> 
        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">pflat</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">eta</span><span class="o">/</span><span class="n">u</span> 
            <span class="n">tt</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">pflat</span><span class="o">&lt;=</span><span class="n">u</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">u</span><span class="o">+</span><span class="n">eta</span><span class="p">)</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pdp</span><span class="p">)</span> <span class="o">-</span> <span class="n">eta</span><span class="o">/</span><span class="n">u</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">xx</span><span class="p">,</span> <span class="n">tt</span>

        <span class="n">xxtop</span><span class="p">,</span> <span class="n">tttop</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">utop</span><span class="p">)</span>
        <span class="n">xxbot</span><span class="p">,</span> <span class="n">ttbot</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">ubot</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span>  <span class="p">(</span><span class="n">xxtop</span> <span class="o">-</span> <span class="n">xxbot</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">pdp</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span>  <span class="p">(</span><span class="n">tttop</span> <span class="o">-</span> <span class="n">ttbot</span><span class="p">)</span><span class="o">/</span><span class="n">b</span> <span class="o">+</span> <span class="n">pflat</span><span class="o">*</span><span class="n">x</span>
      
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">iturn</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">utop</span> <span class="o">-</span> <span class="n">pflat</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ubot</span> <span class="o">-</span> <span class="n">pflat</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">x</span><span class="p">[</span><span class="n">iturn</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">2.</span>
            <span class="n">t</span><span class="p">[</span><span class="n">iturn</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">2.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">utop</span> <span class="o">-</span> <span class="n">pflat</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ubot</span> <span class="o">-</span> <span class="n">pflat</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">*=</span> <span class="mf">2.</span>
                <span class="n">t</span> <span class="o">*=</span> <span class="mf">2.</span>

        <span class="n">x</span> <span class="o">/=</span> <span class="p">(</span><span class="n">earthradius</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span>
   
    <span class="k">def</span> <span class="nf">zturn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">zturn_potint</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">pflat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pflat_bottom</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">vtop</span><span class="p">,</span> <span class="n">vbot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">pflat</span> <span class="o">-</span> <span class="n">vtop</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">vbot</span><span class="o">-</span><span class="n">vtop</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">mmid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">GradientLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="p">,</span> <span class="n">mmid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">GradientLayer</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="p">,</span> <span class="n">mmid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">upper</span><span class="o">.</span><span class="n">ilayer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ilayer</span>
        <span class="n">lower</span><span class="o">.</span><span class="n">ilayer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ilayer</span>
        <span class="k">return</span> <span class="n">upper</span><span class="p">,</span> <span class="n">lower</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39; &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span><span class="p">:</span>
            <span class="n">calcmode</span> <span class="o">=</span> <span class="s">&#39;P&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">calcmode</span> <span class="o">=</span> <span class="s">&#39;G&#39;</span>

        <span class="k">return</span> <span class="s">&#39;  (</span><span class="si">%i</span><span class="s">) gradient layer </span><span class="si">%s</span><span class="s">(</span><span class="si">%g</span><span class="s"> km - </span><span class="si">%g</span><span class="s"> km) [</span><span class="si">%s</span><span class="s">]</span><span class="se">\n</span><span class="s">    </span><span class="si">%s</span><span class="se">\n</span><span class="s">    </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ilayer</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="o">/</span><span class="n">km</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="o">/</span><span class="n">km</span><span class="p">,</span> <span class="n">calcmode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Discontinuity</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

<span class="k">class</span> <span class="nc">Interface</span><span class="p">(</span><span class="n">Discontinuity</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">mabove</span><span class="p">,</span> <span class="n">mbelow</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">Discontinuity</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mabove</span> <span class="o">=</span> <span class="n">mabove</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mbelow</span> <span class="o">=</span> <span class="n">mbelow</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;interface&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;interface &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">us</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">reci_or_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mabove</span><span class="o">.</span><span class="n">vp</span><span class="p">),</span> <span class="n">reci_or_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mbelow</span><span class="o">.</span><span class="n">vp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">reci_or_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mabove</span><span class="o">.</span><span class="n">vs</span><span class="p">),</span> <span class="n">reci_or_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mbelow</span><span class="o">.</span><span class="n">vs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">propagate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="n">uabove</span><span class="p">,</span> <span class="n">ubelow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">us</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ubelow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ubelow</span><span class="o">*</span><span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">direction</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">direction</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">UP</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">uabove</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">uabove</span><span class="o">*</span><span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">direction</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">direction</span>
            
    <span class="k">def</span> <span class="nf">pflat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_direction</span><span class="p">,</span> <span class="n">out_direction</span><span class="p">,</span> <span class="n">in_mode</span><span class="p">,</span> <span class="n">out_mode</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">psv_solid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mabove</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbelow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pflat</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">energy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scatter</span><span class="p">[</span><span class="n">psv_solid_ind</span><span class="p">(</span><span class="n">in_direction</span><span class="p">,</span> <span class="n">out_direction</span><span class="p">,</span> <span class="n">in_mode</span><span class="p">,</span> <span class="n">out_mode</span><span class="p">)]</span>

<span class="k">class</span> <span class="nc">Surface</span><span class="p">(</span><span class="n">Discontinuity</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">mbelow</span><span class="p">):</span>
        <span class="n">Discontinuity</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="s">&#39;surface&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mbelow</span> <span class="o">=</span> <span class="n">mbelow</span>
   
    <span class="k">def</span> <span class="nf">propagate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">direction</span>  <span class="c"># no implicit reflection at surface</span>

    <span class="k">def</span> <span class="nf">pflat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_direction</span><span class="p">,</span> <span class="n">out_direction</span><span class="p">,</span> <span class="n">in_mode</span><span class="p">,</span> <span class="n">out_mode</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">psv_surface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mbelow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pflat</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">energy</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="n">psv_surface_ind</span><span class="p">(</span><span class="n">in_mode</span><span class="p">,</span> <span class="n">out_mode</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;surface&#39;</span>

<span class="k">class</span> <span class="nc">Walker</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="o">=</span> <span class="n">elements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="p">]</span>

    <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BottomReached</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SurfaceReached</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">goto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">DOWN</span><span class="p">):</span>

        <span class="n">inew</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">UP</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">)):</span>
            <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
                    <span class="n">inew</span> <span class="o">=</span> <span class="n">i</span> 
                    <span class="k">break</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">ip</span>

        <span class="k">if</span> <span class="n">inew</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">=</span> <span class="n">inew</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OutOfBounds</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">RayElement</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">__dict__</span>

<span class="k">class</span> <span class="nc">Straight</span><span class="p">(</span><span class="n">RayElement</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction_in</span><span class="p">,</span> <span class="n">direction_out</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">direction_in</span> <span class="o">=</span> <span class="n">direction_in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">direction_out</span> <span class="o">=</span> <span class="n">direction_out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="n">layer</span>
    
    <span class="k">def</span> <span class="nf">angle_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pflat_in</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">vtop</span><span class="p">,</span> <span class="n">vbot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">vs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction_in</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">vtop</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">r2d</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">180.</span><span class="o">-</span><span class="n">num</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">vbot</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">r2d</span>

    <span class="k">def</span> <span class="nf">angle_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pflat_out</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">vtop</span><span class="p">,</span> <span class="n">vbot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">vs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction_out</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">vbot</span>
            <span class="n">o</span> <span class="o">=</span> <span class="mf">90.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">vtop</span>
            <span class="n">o</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="k">return</span> <span class="n">o</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">r2d</span>

    <span class="k">def</span> <span class="nf">pflat_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">z_in</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">pflat_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">z_out</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">z_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">ztop</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">zbot</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">direction_in</span> <span class="o">==</span> <span class="n">UP</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">z_out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">ztop</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">zbot</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">direction_out</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">zturn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span>
        <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">zturn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">u_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">us</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">direction_in</span><span class="o">==</span><span class="n">UP</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">u_out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">us</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">direction_out</span><span class="o">==</span><span class="n">DOWN</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">xt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="n">zpart</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">direction_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">)))</span>

<span class="k">class</span> <span class="nc">Kink</span><span class="p">(</span><span class="n">RayElement</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_direction</span><span class="p">,</span> <span class="n">out_direction</span><span class="p">,</span> <span class="n">in_mode</span><span class="p">,</span> <span class="n">out_mode</span><span class="p">,</span> <span class="n">discontinuity</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_direction</span> <span class="o">=</span> <span class="n">in_direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_direction</span> <span class="o">=</span> <span class="n">out_direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span> <span class="o">=</span> <span class="n">in_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span> <span class="o">=</span> <span class="n">out_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discontinuity</span> <span class="o">=</span> <span class="n">discontinuity</span>

    <span class="k">def</span> <span class="nf">reflection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_direction</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_direction</span>

    <span class="k">def</span> <span class="nf">conversion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span>

    <span class="k">def</span> <span class="nf">efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">discontinuity</span><span class="o">.</span><span class="n">efficiency</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversion</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;|~&#39;</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;|&#39;</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;~&#39;</span>
        <span class="k">return</span> <span class="s">&#39;_&#39;</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">in_direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discontinuity</span><span class="p">)))</span>

<span class="k">class</span> <span class="nc">PRangeNotSet</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">RayPath</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">zstart</span><span class="p">,</span> <span class="n">zstop</span><span class="p">,</span> <span class="n">redistribute_p</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zstart</span> <span class="o">=</span> <span class="n">zstart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zstop</span> <span class="o">=</span> <span class="n">zstop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">used_phase</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spline_px</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spline_pt</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pmin</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_redistribute_p</span> <span class="o">=</span> <span class="n">redistribute_p</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_have_prange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PRangeNotSet</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">set_prange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pmin</span><span class="p">,</span> <span class="n">pmax</span><span class="p">,</span> <span class="n">dp</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span> <span class="o">=</span> <span class="n">pmin</span><span class="p">,</span> <span class="n">pmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prange_dp</span> <span class="o">=</span> <span class="n">dp</span>

    <span class="k">def</span> <span class="nf">set_used_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">used_phase</span> <span class="o">=</span> <span class="n">phase</span>
  
    <span class="k">def</span> <span class="nf">pmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_have_prange</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span>

    <span class="k">def</span> <span class="nf">pmin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_have_prange</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmin</span>

    <span class="k">def</span> <span class="nf">xmin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyse</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmin</span>

    <span class="k">def</span> <span class="nf">xmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyse</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmax</span>

    <span class="k">def</span> <span class="nf">kinks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Kink</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">straights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Straight</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">first_straight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Straight</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">last_straight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Straight</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">reduce</span><span class="p">(</span> <span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">efficiency</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinks</span><span class="p">()),</span> <span class="mf">1.</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">spreading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_have_prange</span><span class="p">()</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prange_dp</span> <span class="o">*</span> <span class="mf">0.01</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmin</span> <span class="o">&gt;</span> <span class="n">dp</span>

        <span class="k">if</span> <span class="n">p</span> <span class="o">+</span> <span class="n">dp</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-</span><span class="n">dp</span>

        <span class="n">x0</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">dp</span><span class="p">)</span>
        <span class="n">dp_dx</span> <span class="o">=</span> <span class="n">dp</span><span class="o">/</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span>
        
        <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x1</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">dp</span>

        <span class="n">first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_straight</span><span class="p">()</span>
        <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_straight</span><span class="p">()</span>
        <span class="k">return</span>  <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dp_dx</span><span class="p">)</span> <span class="o">*</span> <span class="n">first</span><span class="o">.</span><span class="n">pflat_in</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> 
                <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="n">first</span><span class="o">.</span><span class="n">z_in</span><span class="p">())</span> <span class="o">*</span> <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="n">last</span><span class="o">.</span><span class="n">z_out</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> 
                <span class="n">first</span><span class="o">.</span><span class="n">u_in</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">angle_in</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">d2r</span><span class="p">))</span> <span class="o">*</span> 
                <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">angle_out</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">d2r</span><span class="p">)))</span>
    
    <span class="k">def</span> <span class="nf">make_p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dp</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nmin</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">dp</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">n</span> <span class="ow">is</span> <span class="bp">None</span>
        
        <span class="k">if</span> <span class="n">dp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prange_dp</span>
        
        <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_pmin</span><span class="p">)</span><span class="o">/</span><span class="n">dp</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">nmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">nmin</span><span class="p">)</span>
            
        <span class="n">ppp</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ppp</span>

    <span class="k">def</span> <span class="nf">xt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">st</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">straights</span><span class="p">():</span>
            <span class="n">x</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">sx</span> <span class="o">+=</span> <span class="n">x</span>
            <span class="n">st</span> <span class="o">+=</span> <span class="n">t</span>

        <span class="k">return</span> <span class="n">sx</span><span class="p">,</span> <span class="n">st</span>

    <span class="k">def</span> <span class="nf">iter_zxt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">straights</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">s</span><span class="o">.</span><span class="n">z_in</span><span class="p">(),</span> <span class="n">sx</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">st</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="n">x</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">sx</span> <span class="o">+=</span> <span class="n">x</span>
            <span class="n">st</span> <span class="o">+=</span> <span class="n">t</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span> 
            <span class="k">yield</span> <span class="n">s</span><span class="o">.</span><span class="n">z_out</span><span class="p">(),</span> <span class="n">sx</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">st</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">iter_partial_zxt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">straights</span><span class="p">():</span>
            <span class="n">back</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">yield</span> <span class="n">filled</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">z_in</span><span class="p">(),</span> <span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">sx</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">st</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">zin</span><span class="p">,</span> <span class="n">zout</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">z_in</span><span class="p">(),</span> <span class="n">s</span><span class="o">.</span><span class="n">z_out</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">zin</span> <span class="o">!=</span> <span class="n">zout</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="n">dz</span> <span class="o">=</span> <span class="p">(</span><span class="n">zout</span> <span class="o">-</span> <span class="n">zin</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">zin</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dz</span>
                    <span class="n">x</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="nb">sorted</span><span class="p">([</span><span class="n">zin</span><span class="p">,</span> <span class="n">z</span><span class="p">]))</span>
                    <span class="k">yield</span> <span class="n">filled</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">sx</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="n">st</span> <span class="o">+</span> <span class="n">t</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">20</span> 
                <span class="n">zturn</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">zturn</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">back</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">zin</span> <span class="o">+</span> <span class="p">(</span><span class="n">zturn</span> <span class="o">-</span> <span class="n">zin</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="mf">0.999</span>
                    <span class="n">x</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="p">[</span><span class="n">zin</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>
                    <span class="k">yield</span> <span class="n">z</span><span class="p">,</span> <span class="n">sx</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="n">st</span> <span class="o">+</span> <span class="n">t</span>
                    <span class="n">back</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>

            <span class="n">x</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">sx</span> <span class="o">+=</span> <span class="n">x</span>
            <span class="n">st</span> <span class="o">+=</span> <span class="n">t</span>
            
            <span class="k">if</span> <span class="n">back</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">z</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">back</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">z</span><span class="p">,</span> <span class="n">sx</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="n">st</span> <span class="o">-</span> <span class="n">t</span>
            
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span> 
            <span class="k">yield</span> <span class="n">filled</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">z_out</span><span class="p">(),</span> <span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">sx</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">st</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_analyse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_p</span><span class="p">(</span><span class="n">nmin</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redistribute_p</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">evenize</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmax</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_monoton_x</span> <span class="o">=</span> <span class="n">monotony</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monoton_t</span> <span class="o">=</span> <span class="n">monotony</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
       
    <span class="k">def</span> <span class="nf">draft_pxt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyse</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span>

    <span class="k">def</span> <span class="nf">interpolate_t2x_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyse</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">interp</span><span class="p">(</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monoton_t</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">interpolate_x2t_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyse</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">interp</span><span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monoton_x</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">interpolate_t2px_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyse</span><span class="p">()</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monoton_t</span><span class="p">)</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monoton_t</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="p">((</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">),</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span> <span class="p">]</span>

    <span class="k">def</span> <span class="nf">interpolate_x2pt_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyse</span><span class="p">()</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monoton_x</span><span class="p">)</span>
        <span class="n">xt</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monoton_x</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">),</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">xt</span><span class="p">)</span> <span class="p">]</span> 

    <span class="k">def</span> <span class="nf">update_splines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyse</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spline_px</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spline_px</span> <span class="o">=</span> <span class="n">fitpack</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spline_pt</span> <span class="o">=</span> <span class="n">fitpack</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">interpolate_x2pt_spline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs_in</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyse</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_splines</span><span class="p">()</span>
        <span class="n">t</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spline_px</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x_in</span> <span class="ow">in</span> <span class="n">xs_in</span><span class="p">:</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cc</span> <span class="o">-=</span> <span class="n">x_in</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">fitpack</span><span class="o">.</span><span class="n">sproot</span><span class="p">((</span><span class="n">t</span><span class="p">,</span><span class="n">cc</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
            <span class="n">ps</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ps</span><span class="p">:</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">fitpack</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spline_px</span><span class="p">))</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">fitpack</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spline_pt</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">xs</span><span class="p">,</span><span class="n">ps</span><span class="p">,</span><span class="n">ts</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">elements</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span> <span class="nb">hash</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">definition</span><span class="p">,)</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start_i</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">end_i</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">turn_i</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">def</span> <span class="nf">append_layers</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">ei</span><span class="p">,</span> <span class="n">ti</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">si</span> <span class="o">==</span> <span class="n">ei</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ti</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">ti</span> <span class="o">==</span> <span class="n">si</span><span class="p">):</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">si</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ti</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;(</span><span class="si">%i</span><span class="s">-</span><span class="si">%i</span><span class="s">-</span><span class="si">%i</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">ei</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;(</span><span class="si">%i</span><span class="s">-</span><span class="si">%i</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">ei</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">Straight</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">start_i</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">start_i</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">ilayer</span>
                <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">direction_in</span> <span class="o">!=</span> <span class="n">el</span><span class="o">.</span><span class="n">direction_out</span><span class="p">:</span>
                    <span class="n">turn_i</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">ilayer</span>
                <span class="n">end_i</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">ilayer</span>
                
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">Kink</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">start_i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">append_layers</span><span class="p">(</span><span class="n">start_i</span><span class="p">,</span> <span class="n">end_i</span><span class="p">,</span> <span class="n">turn_i</span><span class="p">)</span>
                    <span class="n">start_i</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">turn_i</span> <span class="o">=</span> <span class="bp">None</span>

                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">start_i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">append_layers</span><span class="p">(</span><span class="n">start_i</span><span class="p">,</span> <span class="n">end_i</span><span class="p">,</span> <span class="n">turn_i</span><span class="p">)</span>
       
        <span class="n">su</span> <span class="o">=</span> <span class="s">&#39;(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_phase</span><span class="o">.</span><span class="n">used_repr</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%-15s</span><span class="s"> </span><span class="si">%-17s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">definition</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyse</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s"> - x range: </span><span class="si">%g</span><span class="s"> </span><span class="si">%g</span><span class="se">\n</span><span class="s"> - t range: </span><span class="si">%g</span><span class="s"> </span><span class="si">%g</span><span class="se">\n</span><span class="s"> - p range: </span><span class="si">%g</span><span class="s"> </span><span class="si">%g</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmin</span><span class="o">*</span><span class="n">r2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmax</span><span class="o">*</span><span class="n">r2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Ray</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>

    <span class="k">def</span> <span class="nf">refine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="n">xeps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">/</span><span class="mf">10000.</span>
        <span class="n">count</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">xeps</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
            <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">ip</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">size</span>
            <span class="n">pl</span><span class="p">,</span> <span class="n">ph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">_p</span><span class="p">[</span><span class="n">ip</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">_p</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
            <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">xeps</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">dx</span>
            
            <span class="n">p</span> <span class="o">=</span> <span class="n">bisect</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">ph</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>

        <span class="k">return</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">takeoff_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">first_straight</span><span class="p">()</span><span class="o">.</span><span class="n">angle_in</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">incidence_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">last_straight</span><span class="p">()</span><span class="o">.</span><span class="n">angle_out</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">efficiency</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">spreading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">spreading</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">surface_sphere</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">earthradius</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">zstart</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">earthradius</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">zstop</span>
        <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">r2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="n">r2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mf">4.0</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_degrees</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">as_degrees</span><span class="p">:</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%6.3g</span><span class="s"> deg&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">r2d</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%7.5g</span><span class="s"> km&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">earthradius</span><span class="o">/</span><span class="n">km</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%7.5g</span><span class="s"> s/deg </span><span class="si">%s</span><span class="s"> </span><span class="si">%6.4g</span><span class="s"> s </span><span class="si">%5.1f</span><span class="s"> </span><span class="si">%5.1f</span><span class="s"> </span><span class="si">%3.0f%%</span><span class="s"> </span><span class="si">%3.0f%%</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">/</span><span class="n">r2d</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">takeoff_angle</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">incidence_angle</span><span class="p">(),</span> 
                <span class="mi">100</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">efficiency</span><span class="p">(),</span> <span class="mi">100</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">spreading</span><span class="p">()</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">surface_sphere</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DiscontinuityNotFound</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth_or_name</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_or_name</span> <span class="o">=</span> <span class="n">depth_or_name</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Cannot find discontinuity from given depth or name: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_or_name</span>

<span class="k">class</span> <span class="nc">NotPhaseConform</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">LayeredModel</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_surface_material</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nlayers</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">walkers</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">zeq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ZEPS</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">below</span> <span class="o">=</span> <span class="n">element</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
            <span class="n">element</span><span class="o">.</span><span class="n">ilayer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlayers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nlayers</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">DOWN</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span> <span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">Layer</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span> <span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">Layer</span><span class="p">)</span> <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">DOWN</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">(</span><span class="n">direction</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">l</span>

    <span class="k">def</span> <span class="nf">walker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">breaks</span><span class="p">):</span>
        <span class="n">breaks</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">breaks</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">breaks</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">walkers</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">walkers</span><span class="p">[</span><span class="n">breaks</span><span class="p">]</span>

        <span class="n">elements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">br</span> <span class="ow">in</span> <span class="n">breaks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">il</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elements</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">Layer</span><span class="p">)</span> <span class="ow">and</span> <span class="n">l</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">br</span><span class="p">):</span>
                    <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">br</span><span class="p">)</span>    
                    <span class="n">elements</span><span class="p">[</span><span class="n">il</span><span class="p">:</span><span class="n">il</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>
                    <span class="k">break</span>
   
        <span class="n">w</span> <span class="o">=</span> <span class="n">Walker</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">walkers</span><span class="p">[</span><span class="n">breaks</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
        <span class="k">return</span> <span class="n">w</span>

    <span class="k">def</span> <span class="nf">material</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">DOWN</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">material</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">discontinuities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span> <span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">Discontinuity</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">discontinuity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_or_z</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_z</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">candi</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discontinuities</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">z</span><span class="o">-</span><span class="n">name_or_z</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">candi</span> <span class="o">=</span> <span class="p">[</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">discontinuities</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name_or_z</span> <span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">candi</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DiscontinuityNotFound</span><span class="p">(</span><span class="n">name_or_z</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">candi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">adapt_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">knee</span> <span class="ow">in</span> <span class="n">phase</span><span class="o">.</span><span class="n">knees</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">knee</span><span class="o">.</span><span class="n">depth</span> <span class="o">!=</span> <span class="s">&#39;surface&#39;</span><span class="p">:</span>
                <span class="n">knee</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discontinuity</span><span class="p">(</span><span class="n">knee</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span><span class="o">.</span><span class="n">z</span>
        <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="n">phase</span><span class="o">.</span><span class="n">legs</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">leg</span><span class="o">.</span><span class="n">depthmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">leg</span><span class="o">.</span><span class="n">depthmax</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">leg</span><span class="o">.</span><span class="n">depthmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discontinuity</span><span class="p">(</span><span class="n">leg</span><span class="o">.</span><span class="n">depthmax</span><span class="p">)</span><span class="o">.</span><span class="n">z</span>

        <span class="k">return</span> <span class="n">phase</span>

    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="n">PhaseDef</span><span class="p">(</span><span class="s">&#39;P&#39;</span><span class="p">),</span> <span class="n">zstart</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">zstop</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        
        <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt_phase</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="n">knees</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">knees</span><span class="p">()</span>
        <span class="n">legs</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">legs</span><span class="p">()</span>
        <span class="n">next_knee</span> <span class="o">=</span> <span class="n">next_or_none</span><span class="p">(</span><span class="n">knees</span><span class="p">)</span>
        <span class="n">leg</span> <span class="o">=</span> <span class="n">next_or_none</span><span class="p">(</span><span class="n">legs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">leg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

        <span class="n">direction</span> <span class="o">=</span> <span class="n">leg</span><span class="o">.</span><span class="n">departure</span>
        <span class="n">direction_stop</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">direction_stop</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">leg</span><span class="o">.</span><span class="n">mode</span>
        <span class="n">mode_stop</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">last_leg</span><span class="p">()</span><span class="o">.</span><span class="n">mode</span>

        <span class="n">breaks</span> <span class="o">=</span> <span class="p">[</span> <span class="n">zstart</span><span class="p">,</span> <span class="n">zstop</span> <span class="p">]</span>
        <span class="n">walker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">walker</span><span class="p">(</span><span class="n">breaks</span><span class="p">)</span>
        <span class="n">walker</span><span class="o">.</span><span class="n">goto</span><span class="p">(</span><span class="n">zstart</span><span class="p">,</span> <span class="o">-</span><span class="n">direction</span><span class="p">)</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">walker</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">zstart</span>
        <span class="n">mode_layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">used_phase</span> <span class="o">=</span> <span class="n">PhaseDef</span><span class="p">()</span>
        <span class="n">used_phase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">RayPath</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">zstart</span><span class="p">,</span> <span class="n">zstop</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">Discontinuity</span><span class="p">):</span>
                <span class="n">oldmode</span><span class="p">,</span> <span class="n">olddirection</span> <span class="o">=</span> <span class="n">mode</span><span class="p">,</span> <span class="n">direction</span>
                <span class="k">if</span> <span class="n">next_knee</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">next_knee</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">next_knee</span><span class="o">.</span><span class="n">out_direction</span><span class="p">()</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">next_knee</span><span class="o">.</span><span class="n">out_mode</span>
                    <span class="n">next_knee</span> <span class="o">=</span> <span class="n">next_or_none</span><span class="p">(</span><span class="n">knees</span><span class="p">)</span>
                    <span class="n">leg</span> <span class="o">=</span> <span class="n">legs</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                
                <span class="k">else</span><span class="p">:</span> <span class="c"># implicit reflection/transmission</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
           
                <span class="k">if</span> <span class="n">oldmode</span> <span class="o">!=</span> <span class="n">mode</span> <span class="ow">or</span> <span class="n">olddirection</span> <span class="o">!=</span> <span class="n">direction</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">Surface</span><span class="p">):</span>
                        <span class="n">zz</span> <span class="o">=</span> <span class="s">&#39;surface&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">zz</span> <span class="o">=</span> <span class="n">z</span>
                    <span class="n">used_phase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Knee</span><span class="p">(</span><span class="n">zz</span><span class="p">,</span> <span class="n">olddirection</span><span class="p">,</span> <span class="n">olddirection</span><span class="o">!=</span><span class="n">direction</span><span class="p">,</span> <span class="n">oldmode</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
                    <span class="n">used_phase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
                
                <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Kink</span><span class="p">(</span><span class="n">olddirection</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">oldmode</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">current</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">current</span><span class="o">.</span><span class="n">at_bottom</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="ow">and</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BottomReached</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">current</span><span class="o">.</span><span class="n">at_top</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="ow">and</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">UP</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SurfaceReached</span><span class="p">()</span>
                <span class="n">direction_in</span> <span class="o">=</span> <span class="n">direction</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">direction_in</span><span class="p">)</span>

                <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="n">leg</span><span class="o">.</span><span class="n">depthmin</span><span class="p">,</span> <span class="n">leg</span><span class="o">.</span><span class="n">depthmax</span>
                <span class="k">if</span> <span class="n">zmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">zmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">direction_in</span> <span class="o">!=</span> <span class="n">direction</span><span class="p">:</span>
                        <span class="n">zturn</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">zturn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">zmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">zturn</span> <span class="o">&lt;</span> <span class="n">zmin</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">MinDepthReached</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">zmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">zturn</span> <span class="o">&gt;</span> <span class="n">zmax</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">MaxDepthReached</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">zmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">current</span><span class="o">.</span><span class="n">ztop</span> <span class="o">&lt;</span> <span class="n">zmin</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">MinDepthReached</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">zmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">current</span><span class="o">.</span><span class="n">zbot</span> <span class="o">&gt;</span> <span class="n">zmax</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">MaxDepthReached</span><span class="p">()</span>

                <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Straight</span><span class="p">(</span><span class="n">direction_in</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">current</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">zbot</span>
                <span class="k">if</span> <span class="n">next_knee</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeq</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">zstop</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">mode_stop</span> <span class="ow">and</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">direction_stop</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">walker</span><span class="o">.</span><span class="n">down</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">ztop</span>
                <span class="k">if</span> <span class="n">next_knee</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeq</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">zstop</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">mode_stop</span> <span class="ow">and</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">direction_stop</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">walker</span><span class="o">.</span><span class="n">up</span><span class="p">()</span>
                
            <span class="n">current</span> <span class="o">=</span> <span class="n">walker</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
       
        <span class="k">if</span> <span class="n">next_knee</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotPhaseConform</span><span class="p">()</span>
       
        <span class="n">used_phase</span><span class="o">.</span><span class="n">direction_stop</span> <span class="o">=</span> <span class="n">direction_stop</span>
        <span class="n">path</span><span class="o">.</span><span class="n">set_used_phase</span><span class="p">(</span><span class="n">used_phase</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">gather_pathes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phases</span><span class="o">=</span><span class="n">PhaseDef</span><span class="p">(</span><span class="s">&#39;P&#39;</span><span class="p">),</span> <span class="n">zstart</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">zstop</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="n">PhaseDef</span><span class="p">):</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="p">[</span> <span class="n">phases</span> <span class="p">]</span>
        <span class="n">pathes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">first_leg</span><span class="p">()</span><span class="o">.</span><span class="n">mode</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">first_leg</span><span class="p">()</span><span class="o">.</span><span class="n">departure</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="p">(</span><span class="n">zstart</span><span class="p">,</span> <span class="o">-</span><span class="n">direction</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
                <span class="n">pmax</span> <span class="o">=</span> <span class="n">radius</span><span class="p">(</span><span class="n">zstart</span><span class="p">)</span><span class="o">/</span><span class="n">mat</span><span class="o">.</span><span class="n">vp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pmax</span> <span class="o">=</span> <span class="n">radius</span><span class="p">(</span><span class="n">zstart</span><span class="p">)</span><span class="o">/</span><span class="n">mat</span><span class="o">.</span><span class="n">vs</span>
            

            <span class="n">cached</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
            <span class="k">def</span> <span class="nf">p_to_path</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">cached</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">cached</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">zstart</span><span class="p">,</span> <span class="n">zstop</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pathes</span><span class="p">:</span>
                        <span class="n">pathes</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">pathes</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

                <span class="k">except</span> <span class="p">(</span><span class="n">BottomReached</span><span class="p">,</span> <span class="n">SurfaceReached</span><span class="p">,</span> <span class="n">NotPhaseConform</span><span class="p">,</span> <span class="n">CannotPropagate</span><span class="p">,</span> <span class="n">MaxDepthReached</span><span class="p">,</span> <span class="n">MinDepthReached</span><span class="p">),</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="bp">None</span>
                
                <span class="n">cached</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
                <span class="k">return</span> <span class="n">path</span>
            
            <span class="k">def</span> <span class="nf">recurse</span><span class="p">(</span><span class="n">pmin</span><span class="p">,</span> <span class="n">pmax</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">path1</span> <span class="o">=</span> <span class="n">p_to_path</span><span class="p">(</span><span class="n">pmin</span><span class="p">)</span>
                <span class="n">path2</span> <span class="o">=</span> <span class="n">p_to_path</span><span class="p">(</span><span class="n">pmax</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">path1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">path2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="n">path1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">path2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">hash</span><span class="p">(</span><span class="n">path1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">path2</span><span class="p">):</span>
                    <span class="n">recurse</span><span class="p">(</span><span class="n">pmin</span><span class="p">,</span> <span class="p">(</span><span class="n">pmin</span><span class="o">+</span><span class="n">pmax</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">recurse</span><span class="p">((</span><span class="n">pmin</span><span class="o">+</span><span class="n">pmax</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">pmax</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">recurse</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">pmax</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">pathes</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">path</span><span class="o">.</span><span class="n">set_prange</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ps</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ps</span><span class="p">),</span> <span class="n">pmax</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">pathes</span> <span class="o">=</span> <span class="n">pathes</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">pathes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">pmin</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pathes</span>
    
    <span class="k">def</span> <span class="nf">arrivals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distances</span><span class="o">=</span><span class="p">[],</span> <span class="n">phases</span><span class="o">=</span><span class="n">PhaseDef</span><span class="p">(</span><span class="s">&#39;P&#39;</span><span class="p">),</span> <span class="n">zstart</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">zstop</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">refine</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">):</span>

        <span class="n">arrivals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gather_pathes</span><span class="p">(</span> <span class="n">phases</span><span class="p">,</span> <span class="n">zstart</span><span class="o">=</span><span class="n">zstart</span><span class="p">,</span> <span class="n">zstop</span><span class="o">=</span><span class="n">zstop</span><span class="p">,</span> <span class="n">np</span><span class="o">=</span><span class="n">np</span> <span class="p">):</span>
            <span class="k">if</span> <span class="n">interpolation</span> <span class="o">==</span> <span class="s">&#39;spline&#39;</span><span class="p">:</span>
                <span class="n">x2pt</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">interpolate_x2pt_spline</span>
            <span class="k">elif</span> <span class="n">interpolation</span> <span class="o">==</span> <span class="s">&#39;linear&#39;</span><span class="p">:</span>
                <span class="n">x2pt</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">interpolate_x2pt_linear</span>

            <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">x2pt</span><span class="p">(</span><span class="n">distances</span><span class="p">):</span>
                <span class="n">arrivals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ray</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">refine</span><span class="p">:</span>
            <span class="n">iref</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ray</span> <span class="ow">in</span> <span class="n">arrivals</span><span class="p">:</span>
                <span class="n">iref</span> <span class="o">+=</span> <span class="n">ray</span><span class="o">.</span><span class="n">refine</span><span class="p">()</span>

        <span class="n">arrivals</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">t</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">arrivals</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_scanlines</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">producer</span><span class="p">):</span>
        
        <span class="bp">self</span> <span class="o">=</span> <span class="n">cls</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">z</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">producer</span><span class="p">:</span>
        
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Surface</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">material</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeq</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HomogeneousLayer</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeq</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">zbot</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Layer</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Interface</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">mbot</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Discontinuity</span><span class="p">):</span>
                        <span class="n">ztop</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">z</span>
                        <span class="n">mtop</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">mbelow</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
                        <span class="n">ztop</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">zbot</span>
                        <span class="n">mtop</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">mbot</span>
                    
                    <span class="k">if</span> <span class="n">mtop</span> <span class="o">==</span> <span class="n">material</span><span class="p">:</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="n">HomogeneousLayer</span><span class="p">(</span><span class="n">ztop</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="n">GradientLayer</span><span class="p">(</span><span class="n">ztop</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">mtop</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">iter_material_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">get</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;vp&#39;</span><span class="p">,</span> <span class="s">&#39;vs&#39;</span><span class="p">,</span> <span class="s">&#39;rho&#39;</span><span class="p">,</span> <span class="s">&#39;qp&#39;</span><span class="p">,</span> <span class="s">&#39;qs&#39;</span><span class="p">)</span>
        <span class="n">getter</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="n">get</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">getter</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">getter</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="p">)</span>
         
    <span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get</span><span class="o">=</span><span class="s">&#39;vp&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_material_parameter</span><span class="p">(</span><span class="n">get</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get</span><span class="o">=</span><span class="s">&#39;vp&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_material_parameter</span><span class="p">(</span><span class="n">get</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="p">)</span>
                
<span class="k">def</span> <span class="nf">read_hyposat_model</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">translate</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;MOHO&#39;</span><span class="p">:</span> <span class="s">&#39;moho&#39;</span><span class="p">,</span> <span class="s">&#39;CONR&#39;</span><span class="p">:</span> <span class="s">&#39;conrad&#39;</span> <span class="p">}</span>
    <span class="n">lname</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">iline</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">iline</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">z</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">unpack_fixed</span><span class="p">(</span><span class="s">&#39;f10,f10,f10,a4&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">material</span> <span class="o">=</span> <span class="n">Material</span><span class="p">(</span><span class="n">vp</span><span class="o">*</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">vs</span><span class="o">*</span><span class="mf">1000.</span><span class="p">)</span>

        <span class="n">tname</span> <span class="o">=</span> <span class="n">translate</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lname</span><span class="p">,</span> <span class="n">lname</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">z</span><span class="o">*</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">tname</span>

        <span class="n">lname</span> <span class="o">=</span> <span class="n">name</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
<span class="k">def</span> <span class="nf">read_nd_model</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">translate</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;mantle&#39;</span><span class="p">:</span> <span class="s">&#39;moho&#39;</span><span class="p">,</span> <span class="s">&#39;outer-core&#39;</span><span class="p">:</span> <span class="s">&#39;cmb&#39;</span><span class="p">,</span> <span class="s">&#39;inner-core&#39;</span><span class="p">:</span> <span class="s">&#39;icb&#39;</span> <span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">toks</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">z</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span> <span class="n">qs</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">toks</span> <span class="p">]</span>
            <span class="n">material</span> <span class="o">=</span> <span class="n">Material</span><span class="p">(</span><span class="n">vp</span><span class="o">*</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">vs</span><span class="o">*</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">rho</span><span class="o">*</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">z</span><span class="o">*</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">name</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">translate</span><span class="p">[</span><span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">format</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">format</span> <span class="o">==</span> <span class="s">&#39;nd&#39;</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">read_nd_model</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">format</span> <span class="o">==</span> <span class="s">&#39;hyposat&#39;</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">read_hyposat_model</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;unsupported model format&#39;</span>

    <span class="k">return</span> <span class="n">LayeredModel</span><span class="o">.</span><span class="n">from_scanlines</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
</pre></div>

          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Pyrocko v0.2 Manual</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Sebastian Heimann.
    </div>
  </body>
</html>