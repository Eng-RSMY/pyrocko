
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyrocko.trace &mdash; Pyrocko v0.3 Manual</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Pyrocko v0.3 Manual"
          href="../../_static/opensearch.xml"/>
    <link rel="top" title="Pyrocko v0.3 Manual" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Pyrocko v0.3 Manual</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <h1>Source code for pyrocko.trace</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;This module provides basic signal processing for seismic traces.&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">num</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>

<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="kn">import</span> <span class="n">util</span><span class="p">,</span> <span class="n">evalresp</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">orthodrome</span><span class="p">,</span> <span class="n">pchain</span>
<span class="kn">from</span> <span class="nn">pyrocko.util</span> <span class="kn">import</span> <span class="n">reuse</span><span class="p">,</span> <span class="n">hpfloat</span><span class="p">,</span> <span class="n">UnavailableDecimation</span>
<span class="kn">from</span> <span class="nn">pyrocko.guts</span> <span class="kn">import</span> <span class="n">Object</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Complex</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> \
    <span class="n">StringChoice</span>
<span class="kn">from</span> <span class="nn">pyrocko.guts_array</span> <span class="kn">import</span> <span class="n">Array</span>


<span class="n">UnavailableDecimation</span>  <span class="c"># noqa</span>

<span class="n">guts_prefix</span> <span class="o">=</span> <span class="s">&#39;pf&#39;</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;pyrocko.trace&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="Trace"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace">[docs]</a><span class="k">class</span> <span class="nc">Trace</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create new trace object.</span>

<span class="sd">    A ``Trace`` object represents a single continuous strip of evenly sampled</span>
<span class="sd">    time series data.  It is built from a 1D NumPy array containing the data</span>
<span class="sd">    samples and some attributes describing its beginning  and ending time, its</span>
<span class="sd">    sampling rate and four string identifiers (its network, station, location</span>
<span class="sd">    and channel code).</span>

<span class="sd">    :param network: network code</span>
<span class="sd">    :param station: station code</span>
<span class="sd">    :param location: location code</span>
<span class="sd">    :param channel: channel code</span>
<span class="sd">    :param tmin: system time of first sample in [s]</span>
<span class="sd">    :param tmax: system time of last sample in [s] (if set to ``None`` it is</span>
<span class="sd">        computed from length of *ydata*)</span>
<span class="sd">    :param deltat: sampling interval in [s]</span>
<span class="sd">    :param ydata: 1D numpy array with data samples (can be ``None`` when</span>
<span class="sd">        *tmax* is not ``None``)</span>
<span class="sd">    :param mtime: optional modification time</span>
<span class="sd">    :param meta: additional meta information (not used, but maintained by the</span>
<span class="sd">        library)</span>

<span class="sd">    The length of the network, station, location and channel codes is not</span>
<span class="sd">    resricted by this software, but data formats like SAC, Mini-SEED or GSE</span>
<span class="sd">    have different limits on the lengths of these codes. The codes set here are</span>
<span class="sd">    silently truncated when the trace is stored</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">cached_frequencies</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="s">&#39;STA&#39;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">tmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">deltat</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mtime</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">meta</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">deltat</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
            <span class="n">tmin</span> <span class="o">=</span> <span class="n">hpfloat</span><span class="p">(</span><span class="n">tmin</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">tmax</span> <span class="o">=</span> <span class="n">hpfloat</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mtime</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">reuse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">channel</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="n">tmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">=</span> <span class="n">deltat</span>

        <span class="k">if</span> <span class="n">tmax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ydata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&#39;fixme: trace must be created with tmax or ydata&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">tmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">meta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">ydata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtime</span> <span class="o">=</span> <span class="n">mtime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pchain</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">)))))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;Trace (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nslc_id</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;  timerange: </span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">fmt</span><span class="p">),</span>
            <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">fmt</span><span class="p">))</span>

        <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;  delta t: </span><span class="si">%g</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;  </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtime</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtime</span><span class="p">,</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">state</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># backward compatibility with old behaviour</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtime</span> <span class="o">=</span> <span class="n">state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>

<div class="viewcode-block" id="Trace.name"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.name">[docs]</a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get a short string description.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nslc_id</span> <span class="o">+</span> <span class="p">(</span>
            <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">),</span>
            <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">s</span>
</div>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">network</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">station</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">station</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">location</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">channel</span>
            <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>
                 <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-6</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">-</span><span class="n">other</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.01</span>
            <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="n">other</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.01</span>
            <span class="ow">and</span> <span class="n">num</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">ydata</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="nb">round</span><span class="p">):</span>
        <span class="n">it</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">snap</span><span class="p">((</span><span class="n">t</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">clip</span><span class="p">:</span>
            <span class="n">it</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">it</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">it</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="n">it</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>

<div class="viewcode-block" id="Trace.interpolate"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.interpolate">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Value of trace between supporting points through linear interpolation.</span>

<span class="sd">        :param t: time instant</span>
<span class="sd">        :param clip: whether to clip indices to trace ends</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">t0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">)</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">t1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y0</span><span class="o">+</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Trace.index_clip"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.index_clip">[docs]</a>    <span class="k">def</span> <span class="nf">index_clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Clip index to valid range.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Trace.add"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add values of other trace (self += other).</span>

<span class="sd">        Add values of *other* trace to the values of *self*, where it</span>
<span class="sd">        intersects with *other*.  This method does not change the extent of</span>
<span class="sd">        *self*. If *interpolate* is ``True`` (the default), the values of</span>
<span class="sd">        *other* to be added are interpolated at sampling instants of *self*.</span>
<span class="sd">        Linear interpolation is performed. In this case the sampling rate of</span>
<span class="sd">        *other* must be equal to or lower than that of *self*.  If</span>
<span class="sd">        *interpolate* is ``False``, the sampling rates of the two traces must</span>
<span class="sd">        match.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">interpolate</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">&lt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">deltat</span> \
                <span class="ow">or</span> <span class="n">same_sampling_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

            <span class="n">other_xdata</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">+=</span> <span class="n">num</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">xdata</span><span class="p">,</span> <span class="n">other_xdata</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">deltat</span>
            <span class="n">ioff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">other</span><span class="o">.</span><span class="n">tmin</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span>
            <span class="n">ibeg</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioff</span><span class="p">)</span>
            <span class="n">iend</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_len</span><span class="p">(),</span> <span class="n">ioff</span><span class="o">+</span><span class="n">other</span><span class="o">.</span><span class="n">data_len</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">ibeg</span><span class="p">:</span><span class="n">iend</span><span class="p">]</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">ibeg</span><span class="o">-</span><span class="n">ioff</span><span class="p">:</span><span class="n">iend</span><span class="o">-</span><span class="n">ioff</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Trace.mult"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.mult">[docs]</a>    <span class="k">def</span> <span class="nf">mult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Muliply with values of other trace (self \*= other).</span>

<span class="sd">        Multiply values of *other* trace to the values of *self*, where it</span>
<span class="sd">        intersects with *other*.  This method does not change the extent of</span>
<span class="sd">        *self*. If *interpolate* is ``True`` (the default), the values of</span>
<span class="sd">        *other* to be multiplied are interpolated at sampling instants of</span>
<span class="sd">        *self*. Linear interpolation is performed. In this case the sampling</span>
<span class="sd">        rate of *other* must be equal to or lower than that of *self*.  If</span>
<span class="sd">        *interpolate* is ``False``, the sampling rates of the two traces must</span>
<span class="sd">        match.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">interpolate</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">&lt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">deltat</span> <span class="ow">or</span> \
                <span class="n">same_sampling_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

            <span class="n">other_xdata</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">*=</span> <span class="n">num</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">xdata</span><span class="p">,</span> <span class="n">other_xdata</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">deltat</span>
            <span class="n">ibeg1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">other</span><span class="o">.</span><span class="n">tmin</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span>
            <span class="n">ibeg2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">-</span><span class="n">other</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span>
            <span class="n">iend1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">other</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">iend2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="n">other</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>

            <span class="n">ibeg1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_clip</span><span class="p">(</span><span class="n">ibeg1</span><span class="p">)</span>
            <span class="n">iend1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_clip</span><span class="p">(</span><span class="n">iend1</span><span class="p">)</span>
            <span class="n">ibeg2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_clip</span><span class="p">(</span><span class="n">ibeg2</span><span class="p">)</span>
            <span class="n">iend2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_clip</span><span class="p">(</span><span class="n">iend2</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">ibeg1</span><span class="p">:</span><span class="n">iend1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">other</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">ibeg2</span><span class="p">:</span><span class="n">iend2</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Trace.max"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.max">[docs]</a>    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get time and value of data maximum.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Trace.min"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.min">[docs]</a>    <span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get time and value of data minimum.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Trace.absmax"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.absmax">[docs]</a>    <span class="k">def</span> <span class="nf">absmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get time and value of maximum of the absolute of data.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">tmi</span><span class="p">,</span> <span class="n">mi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">tma</span><span class="p">,</span> <span class="n">ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ma</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tmi</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tma</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ma</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Trace.set_codes"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.set_codes">[docs]</a>    <span class="k">def</span> <span class="nf">set_codes</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set network, station, location, and channel codes.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">network</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">network</span>
        <span class="k">if</span> <span class="n">station</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">station</span> <span class="o">=</span> <span class="n">station</span>
        <span class="k">if</span> <span class="n">location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">set_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_station</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">station</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">station</span> <span class="o">=</span> <span class="n">station</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>

<div class="viewcode-block" id="Trace.overlaps"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.overlaps">[docs]</a>    <span class="k">def</span> <span class="nf">overlaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check if trace has overlap with a given time span.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="n">tmax</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">&lt;</span> <span class="n">tmin</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Trace.is_relevant"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.is_relevant">[docs]</a>    <span class="k">def</span> <span class="nf">is_relevant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check if trace has overlap with a given time span and matches a</span>
<span class="sd">        condition callback. (internal use)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="n">tmax</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">&lt;</span> <span class="n">tmin</span><span class="p">)</span> \
            <span class="ow">and</span> <span class="p">(</span><span class="n">selector</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">selector</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_update_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update dependent ids.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">full_id</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nslc_id</span> <span class="o">=</span> <span class="n">reuse</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">))</span>

<div class="viewcode-block" id="Trace.set_mtime"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.set_mtime">[docs]</a>    <span class="k">def</span> <span class="nf">set_mtime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mtime</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set modification time of the trace.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mtime</span> <span class="o">=</span> <span class="n">mtime</span>
</div>
<div class="viewcode-block" id="Trace.get_xdata"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.get_xdata">[docs]</a>    <span class="k">def</span> <span class="nf">get_xdata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create array for time axis.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoData</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> \
            <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
</div>
<div class="viewcode-block" id="Trace.get_ydata"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.get_ydata">[docs]</a>    <span class="k">def</span> <span class="nf">get_ydata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get data array.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoData</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
</div>
<div class="viewcode-block" id="Trace.set_ydata"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.set_ydata">[docs]</a>    <span class="k">def</span> <span class="nf">set_ydata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_ydata</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Replace data array.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">new_ydata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
</div>
    <span class="k">def</span> <span class="nf">data_len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>

<div class="viewcode-block" id="Trace.drop_data"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.drop_data">[docs]</a>    <span class="k">def</span> <span class="nf">drop_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Forget data, make dataless trace.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Trace.drop_growbuffer"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.drop_growbuffer">[docs]</a>    <span class="k">def</span> <span class="nf">drop_growbuffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Detach the traces grow buffer.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pchain</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Trace.copy"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Make a deep copy of the trace.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">tracecopy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">tracecopy</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">tracecopy</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tracecopy</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tracecopy</span>
</div>
<div class="viewcode-block" id="Trace.crop_zeros"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.crop_zeros">[docs]</a>    <span class="k">def</span> <span class="nf">crop_zeros</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Remove any zeros at beginning and end.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">indices</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoData</span><span class="p">()</span>

        <span class="n">ibeg</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">iend</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">ibeg</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">iend</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">ibeg</span><span class="p">:</span><span class="n">iend</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="n">ibeg</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Trace.append"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Append data to the end of the trace.</span>

<span class="sd">        To make this method efficient when successively very few or even single</span>
<span class="sd">        samples are appended, a larger grow buffer is allocated upon first</span>
<span class="sd">        invocation. The traces data is then changed to be a view into the</span>
<span class="sd">        currently filled portion of the grow buffer array.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">newlen</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">newlen</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">newlen</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="p">:</span><span class="n">newlen</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span><span class="p">[:</span><span class="n">newlen</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">newlen</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
</div>
<div class="viewcode-block" id="Trace.chop"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.chop">[docs]</a>    <span class="k">def</span> <span class="nf">chop</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">include_last</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">snap</span><span class="o">=</span><span class="p">(</span><span class="nb">round</span><span class="p">,</span> <span class="nb">round</span><span class="p">),</span> <span class="n">want_incomplete</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Cut the trace to given time span.</span>

<span class="sd">        If the *inplace* argument is True (the default) the trace is cut in</span>
<span class="sd">        place, otherwise a new trace with the cut part is returned.  By</span>
<span class="sd">        default, the indices where to start and end the trace data array are</span>
<span class="sd">        determined by rounding of *tmin* and *tmax* to sampling instances using</span>
<span class="sd">        Python&#39;s :py:func:`round` function. This behaviour can be changed with</span>
<span class="sd">        the *snap* argument, which takes a tuple of two functions (one for the</span>
<span class="sd">        lower and one for the upper end) to be used instead of</span>
<span class="sd">        :py:func:`round`.  The last sample is by default not included unless</span>
<span class="sd">        *include_last* is set to True.  If the given time span exceeds the</span>
<span class="sd">        available time span of the trace, the available part is returned,</span>
<span class="sd">        unless *want_incomplete* is set to False - in that case, a</span>
<span class="sd">        :py:exc:`NoData` exception is raised. This exception is always</span>
<span class="sd">        raised, when the requested time span does dot overlap with the trace&#39;s</span>
<span class="sd">        time span.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">want_incomplete</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tmax</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">&lt;</span> <span class="n">tmin</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoData</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tmin</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">&lt;</span> <span class="n">tmax</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoData</span><span class="p">()</span>

        <span class="n">ibeg</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t2ind</span><span class="p">(</span><span class="n">tmin</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="n">snap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">iplus</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">include_last</span><span class="p">:</span>
            <span class="n">iplus</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">iend</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_len</span><span class="p">(),</span>
            <span class="n">t2ind</span><span class="p">(</span><span class="n">tmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="n">snap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">iplus</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ibeg</span> <span class="o">&gt;=</span> <span class="n">iend</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoData</span><span class="p">()</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">ibeg</span><span class="p">:</span><span class="n">iend</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="n">ibeg</span><span class="o">*</span><span class="n">obj</span><span class="o">.</span><span class="n">deltat</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="p">((</span><span class="n">iend</span><span class="o">-</span><span class="n">ibeg</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">obj</span><span class="o">.</span><span class="n">deltat</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">obj</span>
</div>
<div class="viewcode-block" id="Trace.downsample"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.downsample">[docs]</a>    <span class="k">def</span> <span class="nf">downsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ndecimate</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">initials</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">demean</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Downsample trace by a given integer factor.</span>

<span class="sd">        :param ndecimate: decimation factor, avoid values larger than 8</span>
<span class="sd">        :param snap: whether to put the new sampling instances closest to</span>
<span class="sd">            multiples of the sampling rate.</span>
<span class="sd">        :param initials: ``None``, ``True``, or initial conditions for the</span>
<span class="sd">            anti-aliasing filter, obtained from a previous run. In the latter</span>
<span class="sd">            two cases the final state of the filter is returned instead of</span>
<span class="sd">            ``None``.</span>
<span class="sd">        :param demean: whether to demean the signal before filtering.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">newdeltat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="n">ndecimate</span>
        <span class="k">if</span> <span class="n">snap</span><span class="p">:</span>
            <span class="n">ilag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span>
                <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">/</span> <span class="n">newdeltat</span><span class="p">)</span> <span class="o">*</span> <span class="n">newdeltat</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>
                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ilag</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">snap</span> <span class="ow">and</span> <span class="n">ilag</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ilag</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+=</span> <span class="n">ilag</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">demean</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">-=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">ndecimate</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s">&#39;fir&#39;</span><span class="p">,</span> <span class="n">zi</span><span class="o">=</span><span class="n">initials</span><span class="p">,</span> <span class="n">ioff</span><span class="o">=</span><span class="n">ilag</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">initials</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">finals</span> <span class="o">=</span> <span class="n">result</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">finals</span> <span class="o">=</span> <span class="n">result</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">=</span> <span class="n">reuse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="n">ndecimate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">finals</span>
</div>
<div class="viewcode-block" id="Trace.downsample_to"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.downsample_to">[docs]</a>    <span class="k">def</span> <span class="nf">downsample_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deltat</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">allow_upsample_max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">initials</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">demean</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Downsample to given sampling rate.</span>

<span class="sd">        Tries to downsample the trace to a target sampling interval of</span>
<span class="sd">        *deltat*. This runs the :py:meth:`Trace.downsample` one or several</span>
<span class="sd">        times. If allow_upsample_max is set to a value larger than 1,</span>
<span class="sd">        intermediate upsampling steps are allowed, in order to increase the</span>
<span class="sd">        number of possible downsampling ratios.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">ratio</span> <span class="o">=</span> <span class="n">deltat</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="n">rratio</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rratio</span> <span class="o">-</span> <span class="n">ratio</span><span class="p">)</span><span class="o">/</span><span class="n">ratio</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">allow_upsample_max</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">util</span><span class="o">.</span><span class="n">UnavailableDecimation</span><span class="p">(</span><span class="s">&#39;ratio = </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">ratio</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">deltat_inter</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">util</span><span class="o">.</span><span class="n">lcm</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">deltat</span><span class="p">)</span>
                <span class="n">upsratio</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">/</span><span class="n">deltat_inter</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">upsratio</span> <span class="o">&gt;</span> <span class="n">allow_upsample_max</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">util</span><span class="o">.</span><span class="n">UnavailableDecimation</span><span class="p">(</span><span class="s">&#39;ratio = </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">ratio</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">upsratio</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
                    <span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                        <span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="n">upsratio</span><span class="o">-</span><span class="p">(</span><span class="n">upsratio</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">ydata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[::</span><span class="n">upsratio</span><span class="p">]</span> <span class="o">=</span> <span class="n">ydata</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">upsratio</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">upsratio</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">upsratio</span> <span class="o">*</span> <span class="n">ydata</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> \
                            <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">upsratio</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">upsratio</span> <span class="o">*</span> <span class="n">ydata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">/</span><span class="n">upsratio</span>

                    <span class="n">ratio</span> <span class="o">=</span> <span class="n">deltat</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
                    <span class="n">rratio</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>

        <span class="n">deci_seq</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">decitab</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rratio</span><span class="p">))</span>
        <span class="n">finals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ndecimate</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">deci_seq</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ndecimate</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">xinitials</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">initials</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">xinitials</span> <span class="o">=</span> <span class="n">initials</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">finals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span>
                    <span class="n">ndecimate</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="n">snap</span><span class="p">,</span> <span class="n">initials</span><span class="o">=</span><span class="n">xinitials</span><span class="p">,</span> <span class="n">demean</span><span class="o">=</span><span class="n">demean</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">initials</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">finals</span>
</div>
<div class="viewcode-block" id="Trace.resample"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.resample">[docs]</a>    <span class="k">def</span> <span class="nf">resample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deltat</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Resample to given sampling rate *deltat*.</span>

<span class="sd">        Resampling is performed in the frequency domain.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">ndata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span>
        <span class="n">ntrans</span> <span class="o">=</span> <span class="n">nextpow2</span><span class="p">(</span><span class="n">ndata</span><span class="p">)</span>
        <span class="n">fntrans2</span> <span class="o">=</span> <span class="n">ntrans</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">/</span><span class="n">deltat</span>
        <span class="n">ntrans2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">fntrans2</span><span class="p">))</span>
        <span class="n">deltat2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">ntrans</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ntrans2</span><span class="p">)</span>
        <span class="n">ndata2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">ndata</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">/</span><span class="n">deltat2</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fntrans2</span> <span class="o">-</span> <span class="n">ntrans2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-7</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s">&#39;resample: requested deltat </span><span class="si">%g</span><span class="s"> could not be matched exactly: &#39;</span>
                <span class="s">&#39;</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">deltat</span><span class="p">,</span> <span class="n">deltat2</span><span class="p">))</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
        <span class="n">data_pad</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntrans</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">data_pad</span><span class="p">[:</span><span class="n">ndata</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">fdata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">data_pad</span><span class="p">)</span>
        <span class="n">fdata2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntrans2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">fdata</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">fdata2</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">fdata2</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdata</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        <span class="n">data2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">fdata2</span><span class="p">)</span>
        <span class="n">data2</span> <span class="o">=</span> <span class="n">data2</span><span class="p">[:</span><span class="n">ndata2</span><span class="p">]</span>
        <span class="n">data2</span> <span class="o">*=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ntrans2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ntrans</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">=</span> <span class="n">deltat2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">resample_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deltat</span><span class="p">):</span>
        <span class="n">tyear</span> <span class="o">=</span> <span class="mi">3600</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mf">365.</span>

        <span class="k">if</span> <span class="n">deltat</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">-</span> <span class="n">deltat</span><span class="p">)</span> <span class="o">*</span> <span class="n">tyear</span><span class="o">/</span><span class="n">deltat</span> <span class="o">&lt;</span> <span class="n">deltat</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s">&#39;resample_simple: less than one sample would have to be &#39;</span>
                <span class="s">&#39;inserted/deleted per year. Doing nothing.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">ninterval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">deltat</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">-</span> <span class="n">deltat</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ninterval</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s">&#39;resample_simple: sample insertion/deletion interval less &#39;</span>
                <span class="s">&#39;than 20. results would be erroneous.&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ResamplingFailed</span><span class="p">()</span>

        <span class="n">delete</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">ninterval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ninterval</span> <span class="o">=</span> <span class="o">-</span> <span class="n">ninterval</span>
            <span class="n">delete</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">tyearbegin</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">year_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>

        <span class="n">nmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">-</span> <span class="n">tyearbegin</span><span class="p">)</span><span class="o">/</span><span class="n">deltat</span><span class="p">))</span>

        <span class="n">ibegin</span> <span class="o">=</span> <span class="p">(((</span><span class="n">nmin</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">ninterval</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ninterval</span> <span class="o">-</span> <span class="n">nmin</span>
        <span class="n">nindices</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span> <span class="o">-</span> <span class="n">ibegin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ninterval</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">nindices</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">ibegin</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nindices</span><span class="p">)</span> <span class="o">*</span> <span class="n">ninterval</span>
            <span class="n">data_split</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data_split</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">data_split</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="k">if</span> <span class="n">delete</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">delete</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">ydata_new</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="n">tyearbegin</span> <span class="o">+</span> <span class="n">nmin</span> <span class="o">*</span> <span class="n">deltat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">=</span> <span class="n">deltat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">ydata_new</span><span class="p">)</span>

<div class="viewcode-block" id="Trace.stretch"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.stretch">[docs]</a>    <span class="k">def</span> <span class="nf">stretch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmin_new</span><span class="p">,</span> <span class="n">tmax_new</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Stretch signal while preserving sample rate using sinc interpolation.</span>

<span class="sd">        :param tmin_new: new time of first sample</span>
<span class="sd">        :param tmax_new: new time of last sample</span>

<span class="sd">        This method can be used to correct for a small linear time drift or to</span>
<span class="sd">        introduce sub-sample time shifts. The amount of stretching is limited</span>
<span class="sd">        to 10% by the implementation and is expected to be much smaller than</span>
<span class="sd">        that by the approximations used.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="kn">import</span> <span class="n">signal_ext</span>

        <span class="n">i_control</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">t_control</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tmin_new</span><span class="p">,</span> <span class="n">tmax_new</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmax_new</span> <span class="o">-</span> <span class="n">tmin_new</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">+</span> <span class="mf">1.0</span>
        <span class="n">n_new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">n_new</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
            <span class="n">n_new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>

        <span class="k">assert</span> <span class="n">n_new</span> <span class="o">&gt;=</span> <span class="mi">2</span>

        <span class="n">tmax_new</span> <span class="o">=</span> <span class="n">tmin_new</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_new</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>

        <span class="n">ydata_new</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_new</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">signal_ext</span><span class="o">.</span><span class="n">antidrift</span><span class="p">(</span><span class="n">i_control</span><span class="p">,</span> <span class="n">t_control</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
                             <span class="n">tmin_new</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="n">ydata_new</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="n">tmin_new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">ydata_new</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Trace.nyquist_check"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.nyquist_check">[docs]</a>    <span class="k">def</span> <span class="nf">nyquist_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intro</span><span class="o">=</span><span class="s">&#39;Corner frequency&#39;</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">raise_exception</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check if a given frequency is above the Nyquist frequency of the trace.</span>

<span class="sd">        :param intro: string used to introduce the warning/error message</span>
<span class="sd">        :param warn: whether to emit a warning</span>
<span class="sd">        :param raise_exception: whether to raise an :py:exc:`AboveNyquist`</span>
<span class="sd">            exception.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">frequency</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> (</span><span class="si">%g</span><span class="s"> Hz) is equal to or higher than nyquist &#39;</span> \
                      <span class="s">&#39;frequency (</span><span class="si">%g</span><span class="s"> Hz). (Trace </span><span class="si">%s</span><span class="s">)&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">intro</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">raise_exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AboveNyquist</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Trace.lowpass"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.lowpass">[docs]</a>    <span class="k">def</span> <span class="nf">lowpass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">corner</span><span class="p">,</span> <span class="n">nyquist_warn</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">nyquist_exception</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">demean</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Apply Butterworth lowpass to the trace.</span>

<span class="sd">        :param order: order of the filter</span>
<span class="sd">        :param corner: corner frequency of the filter</span>

<span class="sd">        Mean is removed before filtering.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nyquist_check</span><span class="p">(</span>
            <span class="n">corner</span><span class="p">,</span> <span class="s">&#39;Corner frequency of lowpass&#39;</span><span class="p">,</span> <span class="n">nyquist_warn</span><span class="p">,</span>
            <span class="n">nyquist_exception</span><span class="p">)</span>

        <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_cached_filter_coefs</span><span class="p">(</span>
            <span class="n">order</span><span class="p">,</span> <span class="p">[</span><span class="n">corner</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">],</span> <span class="n">btype</span><span class="o">=</span><span class="s">&#39;low&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s">&#39;Erroneous filter coefficients returned by &#39;</span>
                <span class="s">&#39;scipy.signal.butter(). You may need to downsample the &#39;</span>
                <span class="s">&#39;signal before filtering.&#39;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">demean</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">-=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Trace.highpass"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.highpass">[docs]</a>    <span class="k">def</span> <span class="nf">highpass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">corner</span><span class="p">,</span> <span class="n">nyquist_warn</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">nyquist_exception</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">demean</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Apply butterworth highpass to the trace.</span>

<span class="sd">        :param order: order of the filter</span>
<span class="sd">        :param corner: corner frequency of the filter</span>

<span class="sd">        Mean is removed before filtering.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nyquist_check</span><span class="p">(</span>
            <span class="n">corner</span><span class="p">,</span> <span class="s">&#39;Corner frequency of highpass&#39;</span><span class="p">,</span> <span class="n">nyquist_warn</span><span class="p">,</span>
            <span class="n">nyquist_exception</span><span class="p">)</span>

        <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_cached_filter_coefs</span><span class="p">(</span>
            <span class="n">order</span><span class="p">,</span> <span class="p">[</span><span class="n">corner</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">],</span> <span class="n">btype</span><span class="o">=</span><span class="s">&#39;high&#39;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s">&#39;Erroneous filter coefficients returned by &#39;</span>
                <span class="s">&#39;scipy.signal.butter(). You may need to downsample the &#39;</span>
                <span class="s">&#39;signal before filtering.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">demean</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">-=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Trace.bandpass"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.bandpass">[docs]</a>    <span class="k">def</span> <span class="nf">bandpass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">corner_hp</span><span class="p">,</span> <span class="n">corner_lp</span><span class="p">,</span> <span class="n">demean</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Apply butterworth bandpass to the trace.</span>

<span class="sd">        :param order: order of the filter</span>
<span class="sd">        :param corner_hp: lower corner frequency of the filter</span>
<span class="sd">        :param corner_lp: upper corner frequency of the filter</span>

<span class="sd">        Mean is removed before filtering.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nyquist_check</span><span class="p">(</span><span class="n">corner_hp</span><span class="p">,</span> <span class="s">&#39;Lower corner frequency of bandpass&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nyquist_check</span><span class="p">(</span><span class="n">corner_lp</span><span class="p">,</span> <span class="s">&#39;Higher corner frequency of bandpass&#39;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_cached_filter_coefs</span><span class="p">(</span>
            <span class="n">order</span><span class="p">,</span>
            <span class="p">[</span><span class="n">corner</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="k">for</span> <span class="n">corner</span> <span class="ow">in</span> <span class="p">(</span><span class="n">corner_hp</span><span class="p">,</span> <span class="n">corner_lp</span><span class="p">)],</span>
            <span class="n">btype</span><span class="o">=</span><span class="s">&#39;band&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">demean</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">-=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">abshilbert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">hilbert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">))</span>

<div class="viewcode-block" id="Trace.envelope"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.envelope">[docs]</a>    <span class="k">def</span> <span class="nf">envelope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate the envelope of the trace.</span>

<span class="sd">        :param inplace: calculate envelope in place</span>

<span class="sd">        The calculation follows:</span>

<span class="sd">        .. math::</span>

<span class="sd">            Y&#39; = \\sqrt{Y^2+H(Y)^2}</span>

<span class="sd">        where H is the Hilbert-Transform of the signal Y.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">hilbert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">hilbert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tr</span>
</div>
<div class="viewcode-block" id="Trace.taper"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.taper">[docs]</a>    <span class="k">def</span> <span class="nf">taper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taperer</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">chop</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Apply a :py:class:`Taper` to the trace.</span>

<span class="sd">        :param taperer: instance of :py:class:`Taper` subclass</span>
<span class="sd">        :param inplace: apply taper inplace</span>
<span class="sd">        :param chop: if ``True``: exclude tapered parts from the resulting</span>
<span class="sd">            trace</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">chop</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">taperer</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">tr</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="p">])</span>

        <span class="n">taperer</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tr</span>
</div>
<div class="viewcode-block" id="Trace.whiten"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.whiten">[docs]</a>    <span class="k">def</span> <span class="nf">whiten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Whiten signal in time domain using autoregression and recursive filter.</span>

<span class="sd">        :param order: order of the autoregression process</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitening_coefficients</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">whitening_coefficients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">ar</span> <span class="o">=</span> <span class="n">yulewalker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]</span> <span class="o">+</span> <span class="n">ar</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>

<div class="viewcode-block" id="Trace.ampspec_whiten"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.ampspec_whiten">[docs]</a>    <span class="k">def</span> <span class="nf">ampspec_whiten</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">width</span><span class="p">,</span>
            <span class="n">td_taper</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span>
            <span class="n">fd_taper</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span>
            <span class="n">pad_to_pow2</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">demean</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Whiten signal via frequency domain using moving average on amplitude</span>
<span class="sd">        spectra.</span>

<span class="sd">        :param width: width of smoothing kernel [Hz]</span>
<span class="sd">        :param td_taper: time domain taper, object of type :py:class:`Taper` or</span>
<span class="sd">            ``None`` or ``&#39;auto&#39;``.</span>
<span class="sd">        :param fd_taper: frequency domain taper, object of type</span>
<span class="sd">            :py:class:`Taper` or ``None`` or ``&#39;auto&#39;``.</span>
<span class="sd">        :param pad_to_pow2: whether to pad the signal with zeros up to a length</span>
<span class="sd">            of 2^n</span>
<span class="sd">        :param demean: whether to demean the signal before tapering</span>

<span class="sd">        The signal is first demeaned and then tapered using *td_taper*. Then,</span>
<span class="sd">        the spectrum is calculated and inversely weighted with a smoothed</span>
<span class="sd">        version of its amplitude spectrum. A moving average is used for the</span>
<span class="sd">        smoothing. The smoothed spectrum is then tapered using *fd_taper*.</span>
<span class="sd">        Finally, the smoothed and tapered spectrum is back-transformed into the</span>
<span class="sd">        time domain.</span>

<span class="sd">        If *td_taper* is set to ``&#39;auto&#39;``, ``CosFader(1.0/width)`` is used. If</span>
<span class="sd">        *fd_taper* is set to ``&#39;auto&#39;``, ``CosFader(width)`` is used.</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">ndata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_len</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">pad_to_pow2</span><span class="p">:</span>
            <span class="n">ntrans</span> <span class="o">=</span> <span class="n">nextpow2</span><span class="p">(</span><span class="n">ndata</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ntrans</span> <span class="o">=</span> <span class="n">ndata</span>

        <span class="n">df</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">ntrans</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>
        <span class="n">nw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="n">df</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ndata</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">nw</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TraceTooShort</span><span class="p">(</span>
                <span class="s">&#39;Samples in trace: </span><span class="si">%s</span><span class="s">, samples needed: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ndata</span><span class="p">,</span> <span class="n">nw</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">td_taper</span> <span class="o">==</span> <span class="s">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">td_taper</span> <span class="o">=</span> <span class="n">CosFader</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">width</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fd_taper</span> <span class="o">==</span> <span class="s">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">fd_taper</span> <span class="o">=</span> <span class="n">CosFader</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">td_taper</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">taper</span><span class="p">(</span><span class="n">td_taper</span><span class="p">)</span>

        <span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">demean</span><span class="p">:</span>
            <span class="n">ydata</span> <span class="o">-=</span> <span class="n">ydata</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span> <span class="n">ntrans</span><span class="p">)</span>

        <span class="n">amp</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">nspec</span> <span class="o">=</span> <span class="n">amp</span><span class="o">.</span><span class="n">size</span>
        <span class="n">csamp</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span>
        <span class="n">amp_smoothed</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nspec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">csamp</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">nw</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">nw</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nspec</span> <span class="o">-</span> <span class="n">nw</span>
        <span class="n">amp_smoothed</span><span class="p">[</span><span class="n">n1</span><span class="p">:</span><span class="n">n2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">csamp</span><span class="p">[</span><span class="n">nw</span><span class="p">:]</span> <span class="o">-</span> <span class="n">csamp</span><span class="p">[:</span><span class="o">-</span><span class="n">nw</span><span class="p">])</span> <span class="o">/</span> <span class="n">nw</span>
        <span class="n">amp_smoothed</span><span class="p">[:</span><span class="n">n1</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp_smoothed</span><span class="p">[</span><span class="n">n1</span><span class="p">]</span>
        <span class="n">amp_smoothed</span><span class="p">[</span><span class="n">n2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">amp_smoothed</span><span class="p">[</span><span class="n">n2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">denom</span> <span class="o">=</span> <span class="n">amp_smoothed</span> <span class="o">*</span> <span class="n">amp</span>
        <span class="n">numer</span> <span class="o">=</span> <span class="n">amp</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">denom</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-9</span>
        <span class="k">if</span> <span class="n">eps</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-9</span>

        <span class="n">numer</span> <span class="o">+=</span> <span class="n">eps</span>
        <span class="n">denom</span> <span class="o">+=</span> <span class="n">eps</span>
        <span class="n">spec</span> <span class="o">*=</span> <span class="n">numer</span><span class="o">/</span><span class="n">denom</span>

        <span class="k">if</span> <span class="n">fd_taper</span><span class="p">:</span>
            <span class="n">fd_taper</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

        <span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">ydata</span><span class="p">[:</span><span class="n">ndata</span><span class="p">])</span>
</div>
    <span class="k">def</span> <span class="nf">_get_cached_freqs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">deltaf</span><span class="p">):</span>
        <span class="n">ck</span> <span class="o">=</span> <span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="n">deltaf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ck</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Trace</span><span class="o">.</span><span class="n">cached_frequencies</span><span class="p">:</span>
            <span class="n">Trace</span><span class="o">.</span><span class="n">cached_frequencies</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span> <span class="o">=</span> <span class="n">deltaf</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                <span class="n">nf</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Trace</span><span class="o">.</span><span class="n">cached_frequencies</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span>

<div class="viewcode-block" id="Trace.bandpass_fft"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.bandpass_fft">[docs]</a>    <span class="k">def</span> <span class="nf">bandpass_fft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corner_hp</span><span class="p">,</span> <span class="n">corner_lp</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Apply boxcar bandbpass to trace (in spectral domain).</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">nextpow2</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
        <span class="n">fdata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_freqs</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdata</span><span class="p">),</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="n">n2</span><span class="p">))</span>
        <span class="n">fdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">fdata</span> <span class="o">*=</span> <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">corner_hp</span> <span class="o">&lt;</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">freqs</span> <span class="o">&lt;</span> <span class="n">corner_lp</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">fdata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Trace.shift"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.shift">[docs]</a>    <span class="k">def</span> <span class="nf">shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tshift</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Time shift the trace.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+=</span> <span class="n">tshift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">+=</span> <span class="n">tshift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Trace.snap"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.snap">[docs]</a>    <span class="k">def</span> <span class="nf">snap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Shift trace samples to nearest even multiples of the sampling rate.</span>

<span class="sd">        :param inplace: (boolean) snap traces inplace</span>

<span class="sd">        If *inplace* is ``False`` and the difference of tmin and tmax of both,</span>
<span class="sd">        the snapped and the original trace is smaller than 0.01 x deltat,</span>
<span class="sd">        :py:func:`snap` returns the unsnapped instance of the original trace.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">tmin</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="n">tmin</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>

        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="n">xself</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">-</span> <span class="n">tmin</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="ow">and</span> \
                    <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">-</span> <span class="n">tmax</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span>

            <span class="n">xself</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">interpolate</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="kn">import</span> <span class="n">signal_ext</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">xself</span><span class="o">.</span><span class="n">data_len</span><span class="p">()</span>
            <span class="n">ydata_new</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
            <span class="n">i_control</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="n">t_control</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xself</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">xself</span><span class="o">.</span><span class="n">tmax</span><span class="p">])</span>
            <span class="n">signal_ext</span><span class="o">.</span><span class="n">antidrift</span><span class="p">(</span><span class="n">i_control</span><span class="p">,</span> <span class="n">t_control</span><span class="p">,</span>
                                 <span class="n">xself</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
                                 <span class="n">tmin</span><span class="p">,</span> <span class="n">xself</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="n">ydata_new</span><span class="p">)</span>

            <span class="n">xself</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">ydata_new</span>

        <span class="n">xself</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="n">tmin</span>
        <span class="n">xself</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">tmax</span>
        <span class="n">xself</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">xself</span>
</div>
<div class="viewcode-block" id="Trace.sta_lta_centered"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.sta_lta_centered">[docs]</a>    <span class="k">def</span> <span class="nf">sta_lta_centered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tshort</span><span class="p">,</span> <span class="n">tlong</span><span class="p">,</span> <span class="n">quad</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">scalingmethod</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Run special STA/LTA filter where the short time window is centered on</span>
<span class="sd">        the long time window.</span>

<span class="sd">        :param tshort: length of short time window in [s]</span>
<span class="sd">        :param tlong: length of long time window in [s]</span>
<span class="sd">        :param quad: whether to square the data prior to applying the STA/LTA</span>
<span class="sd">            filter</span>
<span class="sd">        :param scalingmethod: integer key to select how output values are</span>
<span class="sd">            scaled / normalized (``1``, ``2``, or ``3``)</span>

<span class="sd">        ============= ====================================== ===========</span>
<span class="sd">        Scalingmethod Implementation                         Range</span>
<span class="sd">        ============= ====================================== ===========</span>
<span class="sd">        ``1``         As/Al* Tl/Ts                           [0,1]</span>
<span class="sd">        ``2``         (As/Al - 1) / (Tl/Ts - 1)              [-Ts/Tl,1]</span>
<span class="sd">        ``3``         Like ``2`` but clipping range at zero  [0,1]</span>
<span class="sd">        ============= ====================================== ===========</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">nshort</span> <span class="o">=</span> <span class="n">tshort</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="n">nlong</span> <span class="o">=</span> <span class="n">tlong</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>

        <span class="k">assert</span> <span class="n">nshort</span> <span class="o">&lt;</span> <span class="n">nlong</span>
        <span class="k">if</span> <span class="n">nlong</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">TraceTooShort</span><span class="p">(</span>
                <span class="s">&#39;Samples in trace: </span><span class="si">%s</span><span class="s">, samples needed: </span><span class="si">%s</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">),</span> <span class="n">nlong</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">quad</span><span class="p">:</span>
            <span class="n">sqrdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sqrdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>

        <span class="n">mavg_short</span> <span class="o">=</span> <span class="n">moving_avg</span><span class="p">(</span><span class="n">sqrdata</span><span class="p">,</span> <span class="n">nshort</span><span class="p">)</span>
        <span class="n">mavg_long</span> <span class="o">=</span> <span class="n">moving_avg</span><span class="p">(</span><span class="n">sqrdata</span><span class="p">,</span> <span class="n">nlong</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">scalingmethod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Invalid argument to scalingrange argument.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scalingmethod</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">mavg_short</span><span class="o">/</span><span class="n">mavg_long</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">nshort</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nlong</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">scalingmethod</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="p">(</span><span class="n">mavg_short</span><span class="o">/</span><span class="n">mavg_long</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> \
                <span class="o">/</span> <span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">nlong</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nshort</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scalingmethod</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Trace.peaks"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.peaks">[docs]</a>    <span class="k">def</span> <span class="nf">peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">tsearch</span><span class="p">,</span>
              <span class="n">deadtime</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
              <span class="n">nblock_duration_detection</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Detect peaks above given threshold.</span>

<span class="sd">        From every instant, where the signal rises above *threshold*, a time</span>
<span class="sd">        length of *tsearch* seconds is searched for a maximum. A list with</span>
<span class="sd">        tuples (time, value) for each detected peak is returned. The *deadtime*</span>
<span class="sd">        argument turns on a special deadtime duration detection algorithm</span>
<span class="sd">        useful in combination with recursive STA/LTA filters.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
        <span class="n">above</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">deriv</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="n">deriv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">above</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">above</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">itrig_positions</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">deriv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tpeaks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">apeaks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tzeros</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tzero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span>

        <span class="k">for</span> <span class="n">itrig_pos</span> <span class="ow">in</span> <span class="n">itrig_positions</span><span class="p">:</span>
            <span class="n">ibeg</span> <span class="o">=</span> <span class="n">itrig_pos</span>
            <span class="n">iend</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">),</span>
                <span class="n">itrig_pos</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">tsearch</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">)))</span>
            <span class="n">ipeak</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">ibeg</span><span class="p">:</span><span class="n">iend</span><span class="p">])</span>
            <span class="n">tpeak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">ipeak</span><span class="o">+</span><span class="n">ibeg</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
            <span class="n">apeak</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ibeg</span><span class="o">+</span><span class="n">ipeak</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">tpeak</span> <span class="o">&lt;</span> <span class="n">tzero</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">deadtime</span><span class="p">:</span>
                <span class="n">ibeg</span> <span class="o">=</span> <span class="n">itrig_pos</span>
                <span class="n">iblock</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">nblock</span> <span class="o">=</span> <span class="n">nblock_duration_detection</span>
                <span class="n">totalsum</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ibeg</span><span class="o">+</span><span class="n">iblock</span><span class="o">*</span><span class="n">nblock</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
                        <span class="n">tzero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
                        <span class="k">break</span>

                    <span class="n">logy</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="n">y</span><span class="p">[</span><span class="n">ibeg</span><span class="o">+</span><span class="n">iblock</span><span class="o">*</span><span class="n">nblock</span><span class="p">:</span><span class="n">ibeg</span><span class="o">+</span><span class="p">(</span><span class="n">iblock</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nblock</span><span class="p">])</span>
                    <span class="n">logy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">totalsum</span>
                    <span class="n">ysum</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">logy</span><span class="p">)</span>
                    <span class="n">totalsum</span> <span class="o">=</span> <span class="n">ysum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">below</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ysum</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">deriv</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ysum</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
                    <span class="n">deriv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">below</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">below</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">izero_positions</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">deriv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">iblock</span><span class="o">*</span><span class="n">nblock</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">izero_positions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">tzero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="n">ibeg</span> <span class="o">+</span> <span class="n">izero_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">break</span>
                    <span class="n">iblock</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tzero</span> <span class="o">=</span> <span class="n">ibeg</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="n">tsearch</span>

            <span class="n">tpeaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tpeak</span><span class="p">)</span>
            <span class="n">apeaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">apeak</span><span class="p">)</span>
            <span class="n">tzeros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tzero</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">deadtime</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tpeaks</span><span class="p">,</span> <span class="n">apeaks</span><span class="p">,</span> <span class="n">tzeros</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tpeaks</span><span class="p">,</span> <span class="n">apeaks</span>
</div>
<div class="viewcode-block" id="Trace.extend"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.extend">[docs]</a>    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fillmethod</span><span class="o">=</span><span class="s">&#39;zeros&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Extend trace to given span.</span>

<span class="sd">        :param tmin, tmax:  new span</span>
<span class="sd">        :param fillmethod: &#39;zeros&#39; or &#39;repeat&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">nold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span>

        <span class="k">if</span> <span class="n">tmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">nl</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">tmin</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nl</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">tmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">nh</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nold</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">tmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nh</span> <span class="o">=</span> <span class="n">nold</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">nh</span> <span class="o">-</span> <span class="n">nl</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="n">nl</span><span class="p">:</span><span class="o">-</span><span class="n">nl</span> <span class="o">+</span> <span class="n">nold</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
        <span class="k">if</span> <span class="n">fillmethod</span> <span class="o">==</span> <span class="s">&#39;repeat&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="n">nl</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="n">nl</span> <span class="o">+</span> <span class="n">nold</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drop_growbuffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+=</span> <span class="n">nl</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Trace.transfer"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.transfer">[docs]</a>    <span class="k">def</span> <span class="nf">transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">tfade</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                 <span class="n">freqlimits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">transfer_function</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">cut_off_fading</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">invert</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return new trace with transfer function applied (convolution).</span>

<span class="sd">        :param tfade: rise/fall time in seconds of taper applied in timedomain</span>
<span class="sd">            at both ends of trace.</span>
<span class="sd">        :param freqlimits: 4-tuple with corner frequencies in Hz.</span>
<span class="sd">        :param transfer_function: FrequencyResponse object; must provide a</span>
<span class="sd">            method &#39;evaluate(freqs)&#39;, which returns the transfer function</span>
<span class="sd">            coefficients at the frequencies &#39;freqs&#39;.</span>
<span class="sd">        :param cut_off_fading: whether to cut off rise/fall interval in output</span>
<span class="sd">            trace.</span>
<span class="sd">        :param invert: set to True to do a deconvolution</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">transfer_function</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">transfer_function</span> <span class="o">=</span> <span class="n">FrequencyResponse</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">&lt;=</span> <span class="n">tfade</span><span class="o">*</span><span class="mf">2.</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TraceTooShort</span><span class="p">(</span>
                <span class="s">&#39;Trace </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s"> too short for fading length setting. &#39;</span>
                <span class="s">&#39;trace length = </span><span class="si">%g</span><span class="s">, fading length = </span><span class="si">%g</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nslc_id</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tfade</span><span class="p">)))</span>

        <span class="n">ndata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span>
        <span class="n">ntrans</span> <span class="o">=</span> <span class="n">nextpow2</span><span class="p">(</span><span class="n">ndata</span><span class="o">*</span><span class="mf">1.2</span><span class="p">)</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tapered_coefs</span><span class="p">(</span>
            <span class="n">ntrans</span><span class="p">,</span> <span class="n">freqlimits</span><span class="p">,</span> <span class="n">transfer_function</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="n">invert</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
        <span class="n">data_pad</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntrans</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">data_pad</span><span class="p">[:</span><span class="n">ndata</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tfade</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">data_pad</span><span class="p">[:</span><span class="n">ndata</span><span class="p">]</span> <span class="o">*=</span> <span class="n">costaper</span><span class="p">(</span>
                <span class="mf">0.</span><span class="p">,</span> <span class="n">tfade</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="p">(</span><span class="n">ndata</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">tfade</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="n">ndata</span><span class="p">,</span>
                <span class="n">ndata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>

        <span class="n">fdata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">data_pad</span><span class="p">)</span>
        <span class="n">fdata</span> <span class="o">*=</span> <span class="n">coefs</span>
        <span class="n">ddata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">fdata</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">output</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">ddata</span><span class="p">[:</span><span class="n">ndata</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cut_off_fading</span> <span class="ow">and</span> <span class="n">tfade</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="n">tfade</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="n">tfade</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">NoData</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TraceTooShort</span><span class="p">(</span>
                    <span class="s">&#39;Trace </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s"> too short for fading length setting. &#39;</span>
                    <span class="s">&#39;trace length = </span><span class="si">%g</span><span class="s">, fading length = </span><span class="si">%g</span><span class="s">&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nslc_id</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tfade</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">output</span>
</div>
    <span class="k">def</span> <span class="nf">drop_chain_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pchain</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pchain</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">init_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pchain</span> <span class="o">=</span> <span class="n">pchain</span><span class="o">.</span><span class="n">Chain</span><span class="p">(</span>
            <span class="n">do_downsample</span><span class="p">,</span>
            <span class="n">do_extend</span><span class="p">,</span>
            <span class="n">do_pre_taper</span><span class="p">,</span>
            <span class="n">do_fft</span><span class="p">,</span>
            <span class="n">do_filter</span><span class="p">,</span>
            <span class="n">do_ifft</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">deltat</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="n">nocache</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">setup</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="s">&#39;frequency_domain&#39;</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pchain</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deltat</span><span class="p">),</span>
                <span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">),</span>
                <span class="p">(</span><span class="n">setup</span><span class="o">.</span><span class="n">taper</span><span class="p">,),</span>
                <span class="p">(</span><span class="n">setup</span><span class="o">.</span><span class="n">filter</span><span class="p">,),</span>
                <span class="p">(</span><span class="n">setup</span><span class="o">.</span><span class="n">filter</span><span class="p">,),</span>
                <span class="n">nocache</span><span class="o">=</span><span class="n">nocache</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pchain</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deltat</span><span class="p">),</span>
                <span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">),</span>
                <span class="p">(</span><span class="n">setup</span><span class="o">.</span><span class="n">taper</span><span class="p">,),</span>
                <span class="p">(</span><span class="n">setup</span><span class="o">.</span><span class="n">filter</span><span class="p">,),</span>
                <span class="p">(</span><span class="n">setup</span><span class="o">.</span><span class="n">filter</span><span class="p">,),</span>
                <span class="p">(),</span>
                <span class="n">nocache</span><span class="o">=</span><span class="n">nocache</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">setup</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="s">&#39;time_domain&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">processed</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">setup</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="s">&#39;envelope&#39;</span><span class="p">:</span>
                <span class="n">processed</span> <span class="o">=</span> <span class="n">processed</span><span class="o">.</span><span class="n">envelope</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">setup</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="s">&#39;absolute&#39;</span><span class="p">:</span>
                <span class="n">processed</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">processed</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>

            <span class="k">return</span> <span class="n">processed</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span> <span class="n">processed</span>

<div class="viewcode-block" id="Trace.misfit"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.misfit">[docs]</a>    <span class="k">def</span> <span class="nf">misfit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candidate</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="n">nocache</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate misfit and normalization factor against candidate trace.</span>

<span class="sd">        :param candidate: :py:class:`Trace` object</span>
<span class="sd">        :param setup: :py:class:`MisfitSetup` object</span>
<span class="sd">        :returns: tuple ``(m, n)``, where m is the misfit value and n is the</span>
<span class="sd">            normalization divisor</span>

<span class="sd">        If the sampling rates of *self* and *candidate* differ, the trace with</span>
<span class="sd">        the higher sampling rate will be downsampled.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">candidate</span>

        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tr</span><span class="o">.</span><span class="n">_pchain</span><span class="p">:</span>
                <span class="n">tr</span><span class="o">.</span><span class="n">init_chain</span><span class="p">()</span>

        <span class="n">deltat</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span> <span class="o">-</span> <span class="n">deltat</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span> <span class="o">+</span> <span class="n">deltat</span>

        <span class="n">adata</span><span class="p">,</span> <span class="n">aproc</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">run_chain</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">deltat</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="n">nocache</span><span class="p">)</span>
        <span class="n">bdata</span><span class="p">,</span> <span class="n">bproc</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">run_chain</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">deltat</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="n">nocache</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">setup</span><span class="o">.</span><span class="n">domain</span> <span class="o">!=</span> <span class="s">&#39;cc_max_norm&#39;</span><span class="p">:</span>
            <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">Lx_norm</span><span class="p">(</span><span class="n">bdata</span><span class="p">,</span> <span class="n">adata</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">setup</span><span class="o">.</span><span class="n">norm</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ctr</span> <span class="o">=</span> <span class="n">correlate</span><span class="p">(</span><span class="n">aproc</span><span class="p">,</span> <span class="n">bproc</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;full&#39;</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="s">&#39;normal&#39;</span><span class="p">)</span>
            <span class="n">ccmax</span> <span class="o">=</span> <span class="n">ctr</span><span class="o">.</span><span class="n">max</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ccmax</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">aproc</span><span class="p">,</span> <span class="n">bproc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span>
</div>
<div class="viewcode-block" id="Trace.spectrum"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pad_to_pow2</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">tfade</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get FFT spectrum of trace.</span>

<span class="sd">        :param pad_to_pow2: whether to zero-pad the data to next larger</span>
<span class="sd">            power-of-two length</span>
<span class="sd">        :param tfade: ``None`` or a time length in seconds, to apply cosine</span>
<span class="sd">            shaped tapers to both</span>

<span class="sd">        :returns: a tuple with (frequencies, values)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">ndata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span>

        <span class="k">if</span> <span class="n">pad_to_pow2</span><span class="p">:</span>
            <span class="n">ntrans</span> <span class="o">=</span> <span class="n">nextpow2</span><span class="p">(</span><span class="n">ndata</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ntrans</span> <span class="o">=</span> <span class="n">ndata</span>

        <span class="k">if</span> <span class="n">tfade</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">*</span> <span class="n">costaper</span><span class="p">(</span>
                <span class="mf">0.</span><span class="p">,</span> <span class="n">tfade</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="p">(</span><span class="n">ndata</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">tfade</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="n">ndata</span><span class="p">,</span>
                <span class="n">ndata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>

        <span class="n">fydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span> <span class="n">ntrans</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">ntrans</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>
        <span class="n">fxdata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fydata</span><span class="p">))</span><span class="o">*</span><span class="n">df</span>
        <span class="k">return</span> <span class="n">fxdata</span><span class="p">,</span> <span class="n">fydata</span>
</div>
    <span class="k">def</span> <span class="nf">multi_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_freqs</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">):</span>

        <span class="k">class</span> <span class="nc">Gauss</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f0</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_omega0</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">f0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="o">=</span> <span class="n">a</span>

            <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
                <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freqs</span>
                <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">omega</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_omega0</span><span class="p">)</span>
                                 <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_a</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_omega0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">freqs</span><span class="p">,</span> <span class="n">coefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_len</span><span class="p">()</span>
        <span class="n">nfilt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filter_freqs</span><span class="p">)</span>
        <span class="n">signal_tf</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nfilt</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="n">centroid_freqs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nfilt</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ifilt</span><span class="p">,</span> <span class="n">f0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filter_freqs</span><span class="p">):</span>
            <span class="n">taper</span> <span class="o">=</span> <span class="n">Gauss</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">bandwidth</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">taper</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
            <span class="n">nhalf</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">.</span><span class="n">size</span>
            <span class="n">analytic_spec</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
            <span class="n">analytic_spec</span><span class="p">[:</span><span class="n">nhalf</span><span class="p">]</span> <span class="o">=</span> <span class="n">coefs</span><span class="o">*</span><span class="n">weights</span>

            <span class="n">enorm</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">analytic_spec</span><span class="p">[:</span><span class="n">nhalf</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">enorm</span> <span class="o">/=</span> <span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">enorm</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">analytic_spec</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nhalf</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">2.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">analytic_spec</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nhalf</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">2.</span>

            <span class="n">analytic</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">analytic_spec</span><span class="p">)</span>
            <span class="n">signal_tf</span><span class="p">[</span><span class="n">ifilt</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">analytic</span><span class="p">)</span>

            <span class="n">enorm</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">analytic_spec</span><span class="p">[:</span><span class="n">nhalf</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">enorm</span> <span class="o">/=</span> <span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">enorm</span><span class="p">)</span>
            <span class="n">centroid_freqs</span><span class="p">[</span><span class="n">ifilt</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">freqs</span><span class="o">*</span><span class="n">enorm</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">centroid_freqs</span><span class="p">,</span> <span class="n">signal_tf</span>

    <span class="k">def</span> <span class="nf">_get_tapered_coefs</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">ntrans</span><span class="p">,</span> <span class="n">freqlimits</span><span class="p">,</span> <span class="n">transfer_function</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">deltaf</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="n">ntrans</span><span class="p">)</span>
        <span class="n">nfreqs</span> <span class="o">=</span> <span class="n">ntrans</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">transfer</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nfreqs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="n">snapper</span><span class="p">(</span><span class="n">nfreqs</span><span class="p">,</span> <span class="n">deltaf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">freqlimits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">freqlimits</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hi</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">-</span><span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">*</span><span class="n">deltaf</span> \
                <span class="o">+</span> <span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">deltaf</span>

            <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
                <span class="n">transfer</span><span class="p">[</span><span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">):</span><span class="n">hi</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">transfer_function</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">transfer</span><span class="p">[</span><span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">):</span><span class="n">hi</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span> <span class="o">=</span> <span class="n">transfer_function</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

            <span class="n">tapered_transfer</span> <span class="o">=</span> <span class="n">costaper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">nfreqs</span><span class="p">,</span> <span class="n">deltaf</span><span class="p">)</span><span class="o">*</span><span class="n">transfer</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nfreqs</span><span class="p">)</span> <span class="o">*</span> <span class="n">deltaf</span>
            <span class="n">tapered_transfer</span> <span class="o">=</span> <span class="n">transfer_function</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="n">tapered_transfer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c"># don&#39;t introduce static offsets</span>
        <span class="k">return</span> <span class="n">tapered_transfer</span>

<div class="viewcode-block" id="Trace.fill_template"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.fill_template">[docs]</a>    <span class="k">def</span> <span class="nf">fill_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="n">additional</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Fill string template with trace metadata.</span>

<span class="sd">        Uses normal python &#39;%(placeholder)s&#39; string templates. The following</span>
<span class="sd">        placeholders are considered: ``network``, ``station``, ``location``,</span>
<span class="sd">        ``channel``, ``tmin`` (time of first sample), ``tmax`` (time of last</span>
<span class="sd">        sample), ``tmin_ms``, ``tmax_ms``, ``tmin_us``, ``tmax_us``. The</span>
<span class="sd">        versions with &#39;_ms&#39; include milliseconds, the versions with &#39;_us&#39;</span>
<span class="sd">        include microseconds.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%n&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%(network)s</span><span class="s">&#39;</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%(station)s</span><span class="s">&#39;</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%l&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%(location)s</span><span class="s">&#39;</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%c</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%(channel)s</span><span class="s">&#39;</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%b&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%(tmin)s</span><span class="s">&#39;</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%e</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%(tmax)s</span><span class="s">&#39;</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%j&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%(julianday)s</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">((</span><span class="s">&#39;network&#39;</span><span class="p">,</span> <span class="s">&#39;station&#39;</span><span class="p">,</span> <span class="s">&#39;location&#39;</span><span class="p">,</span> <span class="s">&#39;channel&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">))</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">_%H-%M-%S&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">_%H-%M-%S&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tmin_ms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">_%H-%M-%S.3FRAC&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tmax_ms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">_%H-%M-%S.3FRAC&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tmin_us&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">_%H-%M-%S.6FRAC&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tmax_us&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">_%H-%M-%S.6FRAC&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;julianday&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">julian_day_of_year</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">additional</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">template</span> <span class="o">%</span> <span class="n">params</span>
</div>
<div class="viewcode-block" id="Trace.plot"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Show trace with matplotlib.</span>

<span class="sd">        See also: :py:meth:`Trace.snuffle`.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">())</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
            <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">-%m-%y %H:%M:%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)),</span>
            <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">-%m-%y %H:%M:%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">)))</span>

        <span class="n">pylab</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Trace.snuffle"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Trace.snuffle">[docs]</a>    <span class="k">def</span> <span class="nf">snuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Show trace in a snuffler window.</span>

<span class="sd">        :param stations: list of `pyrocko.model.Station` objects or ``None``</span>
<span class="sd">        :param events: list of `pyrocko.model.Event` objects or ``None``</span>
<span class="sd">        :param markers: list of `pyrocko.gui_util.Marker` objects or ``None``</span>
<span class="sd">        :param ntracks: float, number of tracks to be shown initially (default:</span>
<span class="sd">            12)</span>
<span class="sd">        :param follow: time interval (in seconds) for real time follow mode or</span>
<span class="sd">            ``None``</span>
<span class="sd">        :param controls: bool, whether to show the main controls (default:</span>
<span class="sd">            ``True``)</span>
<span class="sd">        :param opengl: bool, whether to use opengl (default: ``False``)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="n">snuffle</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="snuffle"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.snuffle">[docs]</a><span class="k">def</span> <span class="nf">snuffle</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Show traces in a snuffler window.</span>

<span class="sd">    :param stations: list of `pyrocko.model.Station` objects or ``None``</span>
<span class="sd">    :param events: list of `pyrocko.model.Event` objects or ``None``</span>
<span class="sd">    :param markers: list of `pyrocko.gui_util.Marker` objects or ``None``</span>
<span class="sd">    :param ntracks: float, number of tracks to be shown initially (default: 12)</span>
<span class="sd">    :param follow: time interval (in seconds) for real time follow mode or</span>
<span class="sd">        ``None``</span>
<span class="sd">    :param controls: bool, whether to show the main controls (default:</span>
<span class="sd">        ``True``)</span>
<span class="sd">    :param opengl: bool, whether to use opengl (default: ``False``)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="kn">import</span> <span class="n">pile</span><span class="p">,</span> <span class="n">snuffler</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pile</span><span class="o">.</span><span class="n">Pile</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">traces</span><span class="p">:</span>
        <span class="n">trf</span> <span class="o">=</span> <span class="n">pile</span><span class="o">.</span><span class="n">MemTracesFile</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">traces</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add_file</span><span class="p">(</span><span class="n">trf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">snuffler</span><span class="o">.</span><span class="n">snuffle</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="MisalignedTraces"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.MisalignedTraces">[docs]</a><span class="k">class</span> <span class="nc">MisalignedTraces</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This exception is raised by some :py:class:`Trace` operations when tmin,</span>
<span class="sd">    tmax or number of samples do not match.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="NoData"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.NoData">[docs]</a><span class="k">class</span> <span class="nc">NoData</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This exception is raised by some :py:class:`Trace` operations when no or</span>
<span class="sd">    not enough data is available.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="AboveNyquist"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.AboveNyquist">[docs]</a><span class="k">class</span> <span class="nc">AboveNyquist</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This exception is raised by some :py:class:`Trace` operations when given</span>
<span class="sd">    frequencies are above the Nyquist frequency.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="TraceTooShort"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.TraceTooShort">[docs]</a><span class="k">class</span> <span class="nc">TraceTooShort</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This exception is raised by some :py:class:`Trace` operations when the</span>
<span class="sd">    trace is too short.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">pass</span>

</div>
<span class="k">class</span> <span class="nc">ResamplingFailed</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="minmax"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.minmax">[docs]</a><span class="k">def</span> <span class="nf">minmax</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;minmax&#39;</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get data range given traces grouped by selected pattern.</span>

<span class="sd">    :param key: a callable which takes as single argument a trace and returns a</span>
<span class="sd">        key for the grouping of the results. If this is ``None``, the default,</span>
<span class="sd">        ``lambda tr: (tr.network, tr.station, tr.location, tr.channel)`` is</span>
<span class="sd">        used.</span>
<span class="sd">    :param mode: &#39;minmax&#39; or floating point number. If this is &#39;minmax&#39;,</span>
<span class="sd">        minimum and maximum of the traces are used, if it is a number, mean +-</span>
<span class="sd">        standard deviation times *mode* is used.</span>

<span class="sd">    :returns: a dict with the combined data ranges.</span>

<span class="sd">    Examples::</span>

<span class="sd">        ranges = minmax(traces, lambda tr: tr.channel)</span>
<span class="sd">        print ranges[&#39;N&#39;]   # print min &amp; max of all traces with channel == &#39;N&#39;</span>
<span class="sd">        print ranges[&#39;E&#39;]   # print min &amp; max of all traces with channel == &#39;E&#39;</span>

<span class="sd">        ranges = minmax(traces, lambda tr: (tr.network, tr.station))</span>
<span class="sd">        print ranges[&#39;GR&#39;, &#39;HAM3&#39;]  # print min &amp; max of all traces with</span>
<span class="sd">                                    # network == &#39;GR&#39; and station == &#39;HAM3&#39;</span>

<span class="sd">        ranges = minmax(traces, lambda tr: None)</span>
<span class="sd">        print ranges[None]  # prints min &amp; max of all traces</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">_default_key</span>

    <span class="n">ranges</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;minmax&#39;</span><span class="p">:</span>
            <span class="n">mi</span><span class="p">,</span> <span class="n">ma</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">trace</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">mi</span><span class="p">,</span> <span class="n">ma</span> <span class="o">=</span> <span class="n">mean</span><span class="o">-</span><span class="n">std</span><span class="o">*</span><span class="n">mode</span><span class="p">,</span> <span class="n">mean</span><span class="o">+</span><span class="n">std</span><span class="o">*</span><span class="n">mode</span>

        <span class="n">k</span> <span class="o">=</span> <span class="n">key</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
            <span class="n">ranges</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mi</span><span class="p">,</span> <span class="n">ma</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmi</span><span class="p">,</span> <span class="n">tma</span> <span class="o">=</span> <span class="n">ranges</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">ranges</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tmi</span><span class="p">,</span> <span class="n">mi</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">tma</span><span class="p">,</span> <span class="n">ma</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ranges</span>

</div>
<div class="viewcode-block" id="minmaxtime"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.minmaxtime">[docs]</a><span class="k">def</span> <span class="nf">minmaxtime</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get time range given traces grouped by selected pattern.</span>

<span class="sd">    :param key: a callable which takes as single argument a trace and returns a</span>
<span class="sd">        key for the grouping of the results. If this is ``None``, the default,</span>
<span class="sd">        ``lambda tr: (tr.network, tr.station, tr.location, tr.channel)`` is</span>
<span class="sd">        used.</span>

<span class="sd">    :returns: a dict with the combined data ranges.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">_default_key</span>

    <span class="n">ranges</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
        <span class="n">mi</span><span class="p">,</span> <span class="n">ma</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">trace</span><span class="o">.</span><span class="n">tmax</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">key</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
            <span class="n">ranges</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mi</span><span class="p">,</span> <span class="n">ma</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmi</span><span class="p">,</span> <span class="n">tma</span> <span class="o">=</span> <span class="n">ranges</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">ranges</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tmi</span><span class="p">,</span> <span class="n">mi</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">tma</span><span class="p">,</span> <span class="n">ma</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ranges</span>

</div>
<div class="viewcode-block" id="degapper"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.degapper">[docs]</a><span class="k">def</span> <span class="nf">degapper</span><span class="p">(</span>
        <span class="n">traces</span><span class="p">,</span>
        <span class="n">maxgap</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">fillmethod</span><span class="o">=</span><span class="s">&#39;interpolate&#39;</span><span class="p">,</span>
        <span class="n">deoverlap</span><span class="o">=</span><span class="s">&#39;use_second&#39;</span><span class="p">,</span>
        <span class="n">maxlap</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Try to connect traces and remove gaps.</span>

<span class="sd">    This method will combine adjacent traces, which match in their network,</span>
<span class="sd">    station, location and channel attributes. Overlapping parts are handled</span>
<span class="sd">    according to the `deoverlap` argument.</span>

<span class="sd">    :param traces: input traces, must be sorted by their full_id attribute.</span>
<span class="sd">    :param maxgap: maximum number of samples to interpolate.</span>
<span class="sd">    :param fillmethod: what to put into the gaps: &#39;interpolate&#39; or &#39;zeros&#39;.</span>
<span class="sd">    :param deoverlap: how to handle overlaps: &#39;use_second&#39; to use data from</span>
<span class="sd">        second trace (default), &#39;use_first&#39; to use data from first trace,</span>
<span class="sd">        &#39;crossfade_cos&#39; to crossfade with cosine taper, &#39;add&#39; to add amplitude</span>
<span class="sd">        values.</span>
<span class="sd">    :param maxlap:      maximum number of samples of overlap which are removed</span>

<span class="sd">    :returns:           list of traces</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">in_traces</span> <span class="o">=</span> <span class="n">traces</span>
    <span class="n">out_traces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_traces</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">out_traces</span>
    <span class="n">out_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">in_traces</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">in_traces</span><span class="p">:</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">out_traces</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">in_traces</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">avirt</span><span class="p">,</span> <span class="n">bvirt</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ydata</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">ydata</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="n">avirt</span> <span class="o">==</span> <span class="n">bvirt</span><span class="p">,</span> \
            <span class="s">&#39;traces given to degapper() must either all have data or have &#39;</span> \
            <span class="s">&#39;no data.&#39;</span>

        <span class="n">virtual</span> <span class="o">=</span> <span class="n">avirt</span> <span class="ow">and</span> <span class="n">bvirt</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">nslc_id</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">nslc_id</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">deltat</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">deltat</span>
                <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">data_len</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">data_len</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">virtual</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)):</span>

            <span class="n">dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">tmin</span><span class="o">-</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">data_len</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span><span class="o">/</span><span class="n">a</span><span class="o">.</span><span class="n">deltat</span>
            <span class="n">idist</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">dist</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dist</span> <span class="o">-</span> <span class="n">idist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.05</span> <span class="ow">and</span> <span class="n">idist</span> <span class="o">&lt;=</span> <span class="n">maxgap</span><span class="p">:</span>
                <span class="c"># logger.warn(&#39;Cannot degap traces with displaced sampling &#39;</span>
                <span class="c">#             &#39;(%s, %s, %s, %s)&#39; % a.nslc_id)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">idist</span> <span class="o">&lt;=</span> <span class="n">maxgap</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">virtual</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fillmethod</span> <span class="o">==</span> <span class="s">&#39;interpolate&#39;</span><span class="p">:</span>
                            <span class="n">filler</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
                                <span class="p">((</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">idist</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>
                                 <span class="o">/</span> <span class="n">idist</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">fillmethod</span> <span class="o">==</span> <span class="s">&#39;zeros&#39;</span><span class="p">:</span>
                            <span class="n">filler</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">idist</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">ydist</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">filler</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="p">))</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">tmax</span>
                    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">mtime</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">mtime</span><span class="p">:</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">mtime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">mtime</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">mtime</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">elif</span> <span class="n">idist</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">virtual</span><span class="p">:</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="p">))</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">tmax</span>
                    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">mtime</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">mtime</span><span class="p">:</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">mtime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">mtime</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">mtime</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">elif</span> <span class="n">idist</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">maxlap</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="o">-</span><span class="n">maxlap</span> <span class="o">&lt;</span> <span class="n">idist</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">tmax</span> <span class="o">&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">tmax</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">virtual</span><span class="p">:</span>
                            <span class="n">na</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span>
                            <span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="n">idist</span><span class="o">+</span><span class="mi">1</span>
                            <span class="k">if</span> <span class="n">deoverlap</span> <span class="o">==</span> <span class="s">&#39;use_second&#39;</span><span class="p">:</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                                    <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">],</span> <span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="p">))</span>
                            <span class="k">elif</span> <span class="n">deoverlap</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;use_first&#39;</span><span class="p">,</span> <span class="s">&#39;crossfade_cos&#39;</span><span class="p">):</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                                    <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">n</span><span class="p">:]))</span>
                            <span class="k">elif</span> <span class="n">deoverlap</span> <span class="o">==</span> <span class="s">&#39;add&#39;</span><span class="p">:</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                                    <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">n</span><span class="p">:]))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">assert</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;unknown deoverlap method&#39;</span>

                            <span class="k">if</span> <span class="n">deoverlap</span> <span class="o">==</span> <span class="s">&#39;crossfade_cos&#39;</span><span class="p">:</span>
                                <span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="n">idist</span><span class="o">+</span><span class="mi">1</span>
                                <span class="n">taper</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span>
                                    <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">na</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">na</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1.</span><span class="o">-</span><span class="n">taper</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">[</span><span class="n">na</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">na</span><span class="p">]</span> <span class="o">+=</span> <span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="n">taper</span>

                        <span class="n">a</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">tmax</span>
                        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">mtime</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">mtime</span><span class="p">:</span>
                            <span class="n">a</span><span class="o">.</span><span class="n">mtime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">mtime</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">mtime</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># make short second trace vanish</span>
                        <span class="k">continue</span>

        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">data_len</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">out_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">out_traces</span><span class="p">:</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">out_traces</span>

</div>
<div class="viewcode-block" id="rotate"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.rotate">[docs]</a><span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    2D rotation of traces.</span>

<span class="sd">    :param traces: list of input traces</span>
<span class="sd">    :param azimuth: difference of the azimuths of the component directions</span>
<span class="sd">         (azimuth of out_channels[0]) - (azimuth of in_channels[0])</span>
<span class="sd">    :param in_channels: names of the input channels (e.g. &#39;N&#39;, &#39;E&#39;)</span>
<span class="sd">    :param out_channels: names of the output channels (e.g. &#39;R&#39;, &#39;T&#39;)</span>
<span class="sd">    :returns: list of rotated traces</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">phi</span> <span class="o">=</span> <span class="n">azimuth</span><span class="o">/</span><span class="mf">180.</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">cphi</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">sphi</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">rotated</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">in_channels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_channels_to_names</span><span class="p">(</span><span class="n">in_channels</span><span class="p">))</span>
    <span class="n">out_channels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_channels_to_names</span><span class="p">(</span><span class="n">out_channels</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span> <span class="o">==</span> <span class="n">in_channels</span> <span class="ow">and</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span>
                    <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">deltat</span><span class="o">-</span><span class="n">b</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.001</span><span class="p">):</span>
                <span class="n">tmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>
                <span class="n">tmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">tmin</span> <span class="o">&lt;</span> <span class="n">tmax</span><span class="p">:</span>
                    <span class="n">ac</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">bc</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">tmin</span> <span class="o">-</span> <span class="n">bc</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ac</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.01</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="s">&#39;Cannot rotate traces with displaced sampling &#39;</span>
                            <span class="s">&#39;(</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">a</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="n">acydata</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span><span class="o">*</span><span class="n">cphi</span><span class="o">+</span><span class="n">bc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span><span class="o">*</span><span class="n">sphi</span>
                    <span class="n">bcydata</span> <span class="o">=</span> <span class="o">-</span><span class="n">ac</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span><span class="o">*</span><span class="n">sphi</span><span class="o">+</span><span class="n">bc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span><span class="o">*</span><span class="n">cphi</span>
                    <span class="n">ac</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">acydata</span><span class="p">)</span>
                    <span class="n">bc</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">bcydata</span><span class="p">)</span>

                    <span class="n">ac</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">bc</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">rotated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span>
                    <span class="n">rotated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rotated</span>

</div>
<span class="k">def</span> <span class="nf">rotate_to_rt</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="s">&#39;T&#39;</span><span class="p">)):</span>
    <span class="n">azimuth</span> <span class="o">=</span> <span class="n">orthodrome</span><span class="o">.</span><span class="n">azimuth</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span> <span class="o">+</span> <span class="mf">180.</span>
    <span class="n">in_channels</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">channel</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span>
        <span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">],</span> <span class="n">azimuth</span><span class="p">,</span>
        <span class="n">in_channels</span><span class="o">=</span><span class="n">in_channels</span><span class="p">,</span>
        <span class="n">out_channels</span><span class="o">=</span><span class="n">out_channels</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">channel</span> <span class="o">==</span> <span class="s">&#39;R&#39;</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">tr</span>
        <span class="k">elif</span> <span class="n">tr</span><span class="o">.</span><span class="n">channel</span> <span class="o">==</span> <span class="s">&#39;T&#39;</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">tr</span>

    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span>


<span class="k">def</span> <span class="nf">_decompose</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Decompose matrix into independent submatrices.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">depends</span><span class="p">(</span><span class="n">iout</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">iout</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">row</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">provides</span><span class="p">(</span><span class="n">iin</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:,</span> <span class="n">iin</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">col</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">))</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">systems</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">outs</span><span class="p">:</span>
        <span class="n">iout</span> <span class="o">=</span> <span class="n">outs</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="n">gout</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iin</span> <span class="ow">in</span> <span class="n">depends</span><span class="p">(</span><span class="n">iout</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
            <span class="n">gout</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">provides</span><span class="p">(</span><span class="n">iin</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">gout</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">gin</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iout2</span> <span class="ow">in</span> <span class="n">gout</span><span class="p">:</span>
            <span class="n">gin</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">depends</span><span class="p">(</span><span class="n">iout2</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">gin</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">iout2</span> <span class="ow">in</span> <span class="n">gout</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">iout2</span> <span class="ow">in</span> <span class="n">outs</span><span class="p">:</span>
                <span class="n">outs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">iout2</span><span class="p">)</span>

        <span class="n">gin</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gin</span><span class="p">)</span>
        <span class="n">gin</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">gout</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gout</span><span class="p">)</span>
        <span class="n">gout</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">systems</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">gin</span><span class="p">,</span> <span class="n">gout</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">gout</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">gin</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">systems</span>


<span class="k">def</span> <span class="nf">_channels_to_names</span><span class="p">(</span><span class="n">channels</span><span class="p">):</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Channel</span><span class="p">):</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">names</span>


<div class="viewcode-block" id="project"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.project">[docs]</a><span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Affine transform of three-component traces.</span>

<span class="sd">    Compute matrix-vector product of three-component traces, to e.g. rotate</span>
<span class="sd">    traces into a different basis. The traces are distinguished and ordered by</span>
<span class="sd">    their channel attribute. The tranform is applied to overlapping parts of</span>
<span class="sd">    any appropriate combinations of the input traces. This should allow this</span>
<span class="sd">    function to be robust with data gaps. It also tries to apply the</span>
<span class="sd">    tranformation to subsets of the channels, if this is possible, so that, if</span>
<span class="sd">    for example a vertical compontent is missing, horizontal components can</span>
<span class="sd">    still be rotated.</span>

<span class="sd">    :param traces: list of traces in arbitrary order</span>
<span class="sd">    :param matrix: tranformation matrix</span>
<span class="sd">    :param in_channels: input channel names</span>
<span class="sd">    :param out_channels: output channel names</span>
<span class="sd">    :returns: list of transformed traces</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">in_channels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_channels_to_names</span><span class="p">(</span><span class="n">in_channels</span><span class="p">))</span>
    <span class="n">out_channels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_channels_to_names</span><span class="p">(</span><span class="n">out_channels</span><span class="p">))</span>
    <span class="n">systems</span> <span class="o">=</span> <span class="n">_decompose</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>

    <span class="c"># fallback to full matrix if some are not quadratic</span>
    <span class="k">for</span> <span class="n">iins</span><span class="p">,</span> <span class="n">iouts</span><span class="p">,</span> <span class="n">submatrix</span> <span class="ow">in</span> <span class="n">systems</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">submatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">submatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">_project3</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">)</span>

    <span class="n">projected</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iins</span><span class="p">,</span> <span class="n">iouts</span><span class="p">,</span> <span class="n">submatrix</span> <span class="ow">in</span> <span class="n">systems</span><span class="p">:</span>
        <span class="n">in_cha</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">in_channels</span><span class="p">[</span><span class="n">iin</span><span class="p">]</span> <span class="k">for</span> <span class="n">iin</span> <span class="ow">in</span> <span class="n">iins</span><span class="p">])</span>
        <span class="n">out_cha</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">out_channels</span><span class="p">[</span><span class="n">iout</span><span class="p">]</span> <span class="k">for</span> <span class="n">iout</span> <span class="ow">in</span> <span class="n">iouts</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">submatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">projected</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_project1</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">submatrix</span><span class="p">,</span> <span class="n">in_cha</span><span class="p">,</span> <span class="n">out_cha</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">submatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">projected</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_project2</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">submatrix</span><span class="p">,</span> <span class="n">in_cha</span><span class="p">,</span> <span class="n">out_cha</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">projected</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_project3</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">submatrix</span><span class="p">,</span> <span class="n">in_cha</span><span class="p">,</span> <span class="n">out_cha</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">projected</span>

</div>
<div class="viewcode-block" id="project_dependencies"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.project_dependencies">[docs]</a><span class="k">def</span> <span class="nf">project_dependencies</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Figure out what dependencies project() would produce.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">in_channels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_channels_to_names</span><span class="p">(</span><span class="n">in_channels</span><span class="p">))</span>
    <span class="n">out_channels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_channels_to_names</span><span class="p">(</span><span class="n">out_channels</span><span class="p">))</span>
    <span class="n">systems</span> <span class="o">=</span> <span class="n">_decompose</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>

    <span class="n">subpro</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iins</span><span class="p">,</span> <span class="n">iouts</span><span class="p">,</span> <span class="n">submatrix</span> <span class="ow">in</span> <span class="n">systems</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">submatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">submatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">subpro</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">matrix</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">subpro</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">iins</span><span class="p">,</span> <span class="n">iouts</span><span class="p">,</span> <span class="n">submatrix</span> <span class="ow">in</span> <span class="n">systems</span><span class="p">:</span>
            <span class="n">in_cha</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">in_channels</span><span class="p">[</span><span class="n">iin</span><span class="p">]</span> <span class="k">for</span> <span class="n">iin</span> <span class="ow">in</span> <span class="n">iins</span><span class="p">])</span>
            <span class="n">out_cha</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">out_channels</span><span class="p">[</span><span class="n">iout</span><span class="p">]</span> <span class="k">for</span> <span class="n">iout</span> <span class="ow">in</span> <span class="n">iouts</span><span class="p">])</span>
            <span class="n">subpro</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">submatrix</span><span class="p">,</span> <span class="n">in_cha</span><span class="p">,</span> <span class="n">out_cha</span><span class="p">))</span>

    <span class="n">deps</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">mat</span><span class="p">,</span> <span class="n">in_cha</span><span class="p">,</span> <span class="n">out_cha</span> <span class="ow">in</span> <span class="n">subpro</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">oc</span> <span class="ow">in</span> <span class="n">out_cha</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">oc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">deps</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">in_cha</span><span class="p">:</span>
                <span class="n">deps</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">deps</span>

</div>
<span class="k">def</span> <span class="nf">_project1</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">projected</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">channel</span><span class="p">,)</span> <span class="o">==</span> <span class="n">in_channels</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">ac</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">())</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">projected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">projected</span>


<span class="k">def</span> <span class="nf">_project2</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">projected</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span> <span class="o">==</span> <span class="n">in_channels</span> <span class="ow">and</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span>
                    <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">deltat</span><span class="o">-</span><span class="n">b</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.001</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">tmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>
            <span class="n">tmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">tmin</span> <span class="o">&gt;</span> <span class="n">tmax</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">ac</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">bc</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">tmin</span> <span class="o">-</span> <span class="n">bc</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ac</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.01</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s">&#39;Cannot project traces with displaced sampling &#39;</span>
                    <span class="s">&#39;(</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">a</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">acydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span> <span class="n">bc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>
            <span class="n">bcydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span> <span class="n">bc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>

            <span class="n">ac</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">acydata</span><span class="p">)</span>
            <span class="n">bc</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">bcydata</span><span class="p">)</span>

            <span class="n">ac</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">bc</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">projected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span>
            <span class="n">projected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">projected</span>


<span class="k">def</span> <span class="nf">_project3</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">projected</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span> <span class="o">==</span> <span class="n">in_channels</span>
                        <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
                        <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
                        <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">deltat</span><span class="o">-</span><span class="n">b</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.001</span>
                        <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">deltat</span><span class="o">-</span><span class="n">c</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.001</span><span class="p">):</span>

                    <span class="k">continue</span>

                <span class="n">tmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>
                <span class="n">tmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">tmin</span> <span class="o">&gt;=</span> <span class="n">tmax</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">ac</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">bc</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">tmin</span> <span class="o">-</span> <span class="n">bc</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ac</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.01</span>
                        <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bc</span><span class="o">.</span><span class="n">tmin</span> <span class="o">-</span> <span class="n">cc</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bc</span><span class="o">.</span><span class="n">deltat</span><span class="o">*</span><span class="mf">0.01</span><span class="p">):</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s">&#39;Cannot project traces with displaced sampling &#39;</span>
                        <span class="s">&#39;(</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">a</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">acydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                    <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span> <span class="n">bc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span> <span class="n">cc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>
                <span class="n">bcydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                    <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span> <span class="n">bc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span> <span class="n">cc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>
                <span class="n">ccydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                    <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span> <span class="n">bc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span> <span class="n">cc</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()))</span>

                <span class="n">ac</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">acydata</span><span class="p">)</span>
                <span class="n">bc</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">bcydata</span><span class="p">)</span>
                <span class="n">cc</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">ccydata</span><span class="p">)</span>

                <span class="n">ac</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">bc</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">cc</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">out_channels</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

                <span class="n">projected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span>
                <span class="n">projected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span>
                <span class="n">projected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">projected</span>


<div class="viewcode-block" id="correlate"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.correlate">[docs]</a><span class="k">def</span> <span class="nf">correlate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;valid&#39;</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_fft</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Cross correlation of two traces.</span>

<span class="sd">    :param a,b: input traces</span>
<span class="sd">    :param mode: ``&#39;valid&#39;``, ``&#39;full&#39;``, or ``&#39;same&#39;``</span>
<span class="sd">    :param normalization: ``&#39;normal&#39;``, ``&#39;gliding&#39;``, or ``None``</span>
<span class="sd">    :param use_fft: bool, whether to do cross correlation in spectral domain</span>

<span class="sd">    :returns: trace containing cross correlation coefficients</span>

<span class="sd">    This function computes the cross correlation between two traces. It</span>
<span class="sd">    evaluates the discrete equivalent of</span>

<span class="sd">    .. math::</span>

<span class="sd">       c(t) = \\int_{-\\infty}^{\\infty} a^{\\ast}(\\tau) b(t+\\tau) d\\tau</span>

<span class="sd">    where the star denotes complex conjugate. Note, that the arguments here are</span>
<span class="sd">    swapped when compared with the :py:func:`numpy.correlate` function,</span>
<span class="sd">    which is internally called. This function should be safe even with older</span>
<span class="sd">    versions of NumPy, where the correlate function has some problems.</span>

<span class="sd">    A trace containing the cross correlation coefficients is returned. The time</span>
<span class="sd">    information of the output trace is set so that the returned cross</span>
<span class="sd">    correlation can be viewed directly as a function of time lag.</span>

<span class="sd">    Example::</span>

<span class="sd">        # align two traces a and b containing a time shifted similar signal:</span>
<span class="sd">        c = pyrocko.trace.correlate(a,b)</span>
<span class="sd">        t, coef = c.max()  # get time and value of maximum</span>
<span class="sd">        b.shift(-t)        # align b with a</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">assert_same_sampling_rate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="n">ya</span><span class="p">,</span> <span class="n">yb</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">ydata</span>

    <span class="c"># need reversed order here:</span>
    <span class="n">yc</span> <span class="o">=</span> <span class="n">numpy_correlate_fixed</span><span class="p">(</span><span class="n">yb</span><span class="p">,</span> <span class="n">ya</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">use_fft</span><span class="o">=</span><span class="n">use_fft</span><span class="p">)</span>
    <span class="n">kmin</span><span class="p">,</span> <span class="n">kmax</span> <span class="o">=</span> <span class="n">numpy_correlate_lag_range</span><span class="p">(</span><span class="n">yb</span><span class="p">,</span> <span class="n">ya</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">use_fft</span><span class="o">=</span><span class="n">use_fft</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">normalization</span> <span class="o">==</span> <span class="s">&#39;normal&#39;</span><span class="p">:</span>
        <span class="n">normfac</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ya</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yb</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">yc</span> <span class="o">=</span> <span class="n">yc</span><span class="o">/</span><span class="n">normfac</span>

    <span class="k">elif</span> <span class="n">normalization</span> <span class="o">==</span> <span class="s">&#39;gliding&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s">&#39;valid&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;gliding normalization currently only available &#39;</span> \
                <span class="s">&#39;with &quot;valid&quot; mode.&#39;</span>

        <span class="k">if</span> <span class="n">ya</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">yb</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">yshort</span><span class="p">,</span> <span class="n">ylong</span> <span class="o">=</span> <span class="n">ya</span><span class="p">,</span> <span class="n">yb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yshort</span><span class="p">,</span> <span class="n">ylong</span> <span class="o">=</span> <span class="n">yb</span><span class="p">,</span> <span class="n">ya</span>

        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">0.00001</span>
        <span class="n">normfac_short</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yshort</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">normfac</span> <span class="o">=</span> <span class="n">normfac_short</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="n">moving_sum</span><span class="p">(</span><span class="n">ylong</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">yshort</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;valid&#39;</span><span class="p">))</span> \
            <span class="o">+</span> <span class="n">normfac_short</span><span class="o">*</span><span class="n">epsilon</span>

        <span class="k">if</span> <span class="n">yb</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">ya</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">normfac</span> <span class="o">=</span> <span class="n">normfac</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">yc</span> <span class="o">/=</span> <span class="n">normfac</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">yc</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="o">*</span><span class="n">merge_codes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s">&#39;~&#39;</span><span class="p">))</span>
    <span class="n">c</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">tmin</span><span class="o">-</span><span class="n">a</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="n">kmin</span> <span class="o">*</span> <span class="n">c</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">c</span>

</div>
<span class="k">def</span> <span class="nf">deconvolve</span><span class="p">(</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">waterlevel</span><span class="p">,</span>
        <span class="n">tshift</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
        <span class="n">pad</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">fd_taper</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">pad_to_pow2</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="n">same_sampling_rate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tmin</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">deltat</span> <span class="o">*</span> <span class="mf">0.001</span>
    <span class="n">deltat</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">deltat</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">data_len</span><span class="p">()</span><span class="o">*</span><span class="n">pad</span> <span class="o">+</span> <span class="n">tshift</span> <span class="o">/</span> <span class="n">deltat</span><span class="p">))</span>

    <span class="n">ndata</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">data_len</span><span class="p">(),</span> <span class="n">b</span><span class="o">.</span><span class="n">data_len</span><span class="p">())</span>
    <span class="n">ndata_pad</span> <span class="o">=</span> <span class="n">ndata</span> <span class="o">+</span> <span class="n">npad</span>

    <span class="k">if</span> <span class="n">pad_to_pow2</span><span class="p">:</span>
        <span class="n">ntrans</span> <span class="o">=</span> <span class="n">nextpow2</span><span class="p">(</span><span class="n">ndata_pad</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ntrans</span> <span class="o">=</span> <span class="n">ndata</span>

    <span class="n">aspec</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">ntrans</span><span class="p">)</span>
    <span class="n">bspec</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">ntrans</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">aspec</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">bspec</span><span class="p">)</span>

    <span class="n">bautocorr</span> <span class="o">=</span> <span class="n">bspec</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">bspec</span><span class="p">)</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">bautocorr</span><span class="p">,</span> <span class="n">waterlevel</span> <span class="o">*</span> <span class="n">bautocorr</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="n">out</span> <span class="o">/=</span> <span class="n">denom</span>
    <span class="n">df</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">ntrans</span><span class="o">*</span><span class="n">deltat</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fd_taper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fd_taper</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

    <span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tshift</span><span class="o">/</span><span class="n">deltat</span><span class="p">)))</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">ydata</span><span class="p">[:</span><span class="n">ndata</span><span class="p">])</span>
    <span class="n">c</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="o">*</span><span class="n">merge_codes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">c</span>


<span class="k">def</span> <span class="nf">assert_same_sampling_rate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">same_sampling_rate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">eps</span><span class="p">),</span> \
        <span class="s">&#39;Sampling rates differ: </span><span class="si">%g</span><span class="s"> != </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>


<div class="viewcode-block" id="same_sampling_rate"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.same_sampling_rate">[docs]</a><span class="k">def</span> <span class="nf">same_sampling_rate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Check if two traces have the same sampling rate.</span>

<span class="sd">    :param a, b: input traces</span>
<span class="sd">    :param eps: relative tolerance</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">deltat</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">deltat</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span><span class="o">*</span><span class="n">eps</span>

</div>
<div class="viewcode-block" id="merge_codes"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.merge_codes">[docs]</a><span class="k">def</span> <span class="nf">merge_codes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Merge network-station-location-channel codes of a pair of traces.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">o</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">xa</span><span class="p">,</span> <span class="n">xb</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">xa</span> <span class="o">==</span> <span class="n">xb</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xa</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">xa</span><span class="p">,</span> <span class="n">xb</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">o</span>

</div>
<div class="viewcode-block" id="Taper"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Taper">[docs]</a><span class="k">class</span> <span class="nc">Taper</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Base class for tapers.</span>

<span class="sd">    Does nothing by default.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
        <span class="k">pass</span>

</div>
<div class="viewcode-block" id="CosTaper"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.CosTaper">[docs]</a><span class="k">class</span> <span class="nc">CosTaper</span><span class="p">(</span><span class="n">Taper</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Cosine Taper.</span>

<span class="sd">    :param a: start of fading in</span>
<span class="sd">    :param b: end of fading in</span>
<span class="sd">    :param c: start of fading out</span>
<span class="sd">    :param d: end of fading out</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">Taper</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
        <span class="n">apply_costaper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">span</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">span_costaper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">time_span</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>

</div>
<div class="viewcode-block" id="CosFader"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.CosFader">[docs]</a><span class="k">class</span> <span class="nc">CosFader</span><span class="p">(</span><span class="n">Taper</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Cosine Fader.</span>

<span class="sd">    :param xfade: fade in and fade out time in seconds (optional)</span>
<span class="sd">    :param xfrac: fade in and fade out as fraction between 0. and 1. (optional)</span>

<span class="sd">    Only one of both arguments can be set. The other is supposed to be</span>
<span class="sd">    ``None``.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">xfade</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">xfrac</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xfade</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">xfrac</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">Taper</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xfade</span><span class="o">=</span><span class="n">xfade</span><span class="p">,</span> <span class="n">xfrac</span><span class="o">=</span><span class="n">xfrac</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">xfade</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">xfrac</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xfade</span> <span class="o">=</span> <span class="n">xfade</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xfrac</span> <span class="o">=</span> <span class="n">xfrac</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>

        <span class="n">xfade</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xfade</span>

        <span class="n">xlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
        <span class="k">if</span> <span class="n">xfade</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">xfade</span> <span class="o">=</span> <span class="n">xlen</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xfrac</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">xfade</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">xlen</span> <span class="o">-</span> <span class="n">xfade</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">xlen</span>

        <span class="n">apply_costaper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">span</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span>

    <span class="k">def</span> <span class="nf">time_span</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

</div>
<span class="k">def</span> <span class="nf">none_min</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">None</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">none_max</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">None</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>


<div class="viewcode-block" id="MultiplyTaper"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.MultiplyTaper">[docs]</a><span class="k">class</span> <span class="nc">MultiplyTaper</span><span class="p">(</span><span class="n">Taper</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Multiplication of several tapers.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">tapers</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">Taper</span><span class="o">.</span><span class="n">T</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tapers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tapers</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tapers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">Taper</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tapers</span><span class="o">=</span><span class="n">tapers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">taper</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tapers</span><span class="p">:</span>
            <span class="n">taper</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">span</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
        <span class="n">spans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">taper</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tapers</span><span class="p">:</span>
            <span class="n">spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">taper</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span>

        <span class="n">mins</span><span class="p">,</span> <span class="n">maxs</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">spans</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">mins</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">time_span</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">spans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">taper</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tapers</span><span class="p">:</span>
            <span class="n">spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">taper</span><span class="o">.</span><span class="n">time_span</span><span class="p">())</span>

        <span class="n">mins</span><span class="p">,</span> <span class="n">maxs</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">spans</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">none_min</span><span class="p">(</span><span class="n">mins</span><span class="p">),</span> <span class="n">none_max</span><span class="p">(</span><span class="n">maxs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GaussTaper"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.GaussTaper">[docs]</a><span class="k">class</span> <span class="nc">GaussTaper</span><span class="p">(</span><span class="n">Taper</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Frequency domain Gaussian filter.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="n">Taper</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span> <span class="o">=</span> <span class="n">alpha</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
        <span class="n">y</span> <span class="o">*=</span> <span class="n">num</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">f</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="FrequencyResponse"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.FrequencyResponse">[docs]</a><span class="k">class</span> <span class="nc">FrequencyResponse</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Evaluates frequency response at given frequencies.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">freqs</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">coefs</span>

</div>
<div class="viewcode-block" id="Evalresp"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Evalresp">[docs]</a><span class="k">class</span> <span class="nc">Evalresp</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calls evalresp and generates values of the instrument response transfer</span>
<span class="sd">    function.</span>

<span class="sd">    :param respfile: response file in evalresp format</span>
<span class="sd">    :param trace: trace for which the response is to be extracted from the file</span>
<span class="sd">    :param target: ``&#39;dis&#39;`` for displacement or ``&#39;vel&#39;`` for velocity</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">respfile</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>
    <span class="n">nslc_id</span> <span class="o">=</span> <span class="n">Tuple</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">())</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">&#39;dis&#39;</span><span class="p">)</span>
    <span class="n">instant</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">respfile</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s">&#39;dis&#39;</span><span class="p">,</span> <span class="n">nslc_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">nslc_id</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">nslc_id</span>
            <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="n">trace</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>

        <span class="n">FrequencyResponse</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">respfile</span><span class="o">=</span><span class="n">respfile</span><span class="p">,</span>
            <span class="n">nslc_id</span><span class="o">=</span><span class="n">nslc_id</span><span class="p">,</span>
            <span class="n">instant</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nslc_id</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">evalresp</span><span class="o">.</span><span class="n">evalresp</span><span class="p">(</span>
            <span class="n">sta_list</span><span class="o">=</span><span class="n">station</span><span class="p">,</span>
            <span class="n">cha_list</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span>
            <span class="n">net_code</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
            <span class="n">locid</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">instant</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instant</span><span class="p">,</span>
            <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
            <span class="nb">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">respfile</span><span class="p">,</span>
            <span class="n">rtype</span><span class="o">=</span><span class="s">&#39;CS&#39;</span><span class="p">)</span>

        <span class="n">transfer</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">transfer</span>

</div>
<div class="viewcode-block" id="InverseEvalresp"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.InverseEvalresp">[docs]</a><span class="k">class</span> <span class="nc">InverseEvalresp</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calls evalresp and generates values of the inverse instrument response for</span>
<span class="sd">    deconvolution of instrument response.</span>

<span class="sd">    :param respfile: response file in evalresp format</span>
<span class="sd">    :param trace: trace for which the response is to be extracted from the file</span>
<span class="sd">    :param target: ``&#39;dis&#39;`` for displacement or ``&#39;vel&#39;`` for velocity</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">respfile</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>
    <span class="n">nslc_id</span> <span class="o">=</span> <span class="n">Tuple</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">())</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">&#39;dis&#39;</span><span class="p">)</span>
    <span class="n">instant</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">respfile</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s">&#39;dis&#39;</span><span class="p">):</span>
        <span class="n">FrequencyResponse</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">respfile</span><span class="o">=</span><span class="n">respfile</span><span class="p">,</span>
            <span class="n">nslc_id</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">,</span>
            <span class="n">instant</span><span class="o">=</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="n">trace</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nslc_id</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">evalresp</span><span class="o">.</span><span class="n">evalresp</span><span class="p">(</span><span class="n">sta_list</span><span class="o">=</span><span class="n">station</span><span class="p">,</span>
                              <span class="n">cha_list</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span>
                              <span class="n">net_code</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
                              <span class="n">locid</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                              <span class="n">instant</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instant</span><span class="p">,</span>
                              <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span>
                              <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                              <span class="nb">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">respfile</span><span class="p">,</span>
                              <span class="n">rtype</span><span class="o">=</span><span class="s">&#39;CS&#39;</span><span class="p">)</span>

        <span class="n">transfer</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="n">transfer</span>

</div>
<div class="viewcode-block" id="PoleZeroResponse"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.PoleZeroResponse">[docs]</a><span class="k">class</span> <span class="nc">PoleZeroResponse</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Evaluates frequency response from pole-zero representation.</span>

<span class="sd">    :param zeros: :py:class:`numpy.array` containing complex positions of zeros</span>
<span class="sd">    :param poles: :py:class:`numpy.array` containing complex positions of poles</span>
<span class="sd">    :param constant: gain as floating point number</span>

<span class="sd">    ::</span>

<span class="sd">                           (j*2*pi*f - zeros[0]) * (j*2*pi*f - zeros[1]) * ...</span>
<span class="sd">         T(f) = constant * ----------------------------------------------------</span>
<span class="sd">                           (j*2*pi*f - poles[0]) * (j*2*pi*f - poles[1]) * ...</span>


<span class="sd">    The poles and zeros should be given as angular frequencies, not in Hz.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">zeros</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">Complex</span><span class="o">.</span><span class="n">T</span><span class="p">())</span>
    <span class="n">poles</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">Complex</span><span class="o">.</span><span class="n">T</span><span class="p">())</span>
    <span class="n">constant</span> <span class="o">=</span> <span class="n">Complex</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="o">+</span><span class="mi">0j</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zeros</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">poles</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">constant</span><span class="o">=</span><span class="mf">1.0</span><span class="o">+</span><span class="mi">0j</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">zeros</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">zeros</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">poles</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">poles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">FrequencyResponse</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">zeros</span><span class="o">=</span><span class="n">zeros</span><span class="p">,</span> <span class="n">poles</span><span class="o">=</span><span class="n">poles</span><span class="p">,</span> <span class="n">constant</span><span class="o">=</span><span class="n">constant</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="n">jomeg</span> <span class="o">=</span> <span class="mf">1.0j</span> <span class="o">*</span> <span class="mf">2.</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freqs</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">freqs</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">constant</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeros</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">*=</span> <span class="n">jomeg</span><span class="o">-</span><span class="n">z</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">poles</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">/=</span> <span class="n">jomeg</span><span class="o">-</span><span class="n">p</span>

        <span class="k">return</span> <span class="n">a</span>

</div>
<div class="viewcode-block" id="ButterworthResponse"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.ButterworthResponse">[docs]</a><span class="k">class</span> <span class="nc">ButterworthResponse</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Butterworth frequency response.</span>

<span class="sd">    :param corner: corner frequency of the response</span>
<span class="sd">    :param order: order of the response</span>
<span class="sd">    :param type: either ``high`` or ``low``</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">corner</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Int</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">StringChoice</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;low&#39;</span><span class="p">,</span> <span class="s">&#39;high&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;low&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corner</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">analog</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">freqs</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">freqs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

</div>
<div class="viewcode-block" id="SampledResponse"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.SampledResponse">[docs]</a><span class="k">class</span> <span class="nc">SampledResponse</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Interpolates frequency response given at a set of sampled frequencies.</span>

<span class="sd">    :param frequencies,values: frequencies and values of the sampled response</span>
<span class="sd">        function.</span>
<span class="sd">    :param left,right: values to return when input is out of range. If set to</span>
<span class="sd">        ``None`` (the default) the endpoints are returned.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">frequencies</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">serialize_as</span><span class="o">=</span><span class="s">&#39;list&#39;</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">complex</span><span class="p">,</span> <span class="n">serialize_as</span><span class="o">=</span><span class="s">&#39;list&#39;</span><span class="p">)</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">Complex</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">Complex</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">FrequencyResponse</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">frequencies</span><span class="o">=</span><span class="n">asarray_1d</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
            <span class="n">values</span><span class="o">=</span><span class="n">asarray_1d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">complex</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="n">ereal</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="n">freqs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
            <span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
        <span class="n">eimag</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="n">freqs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
            <span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
        <span class="n">transfer</span> <span class="o">=</span> <span class="n">ereal</span> <span class="o">+</span> <span class="mf">1.0j</span><span class="o">*</span><span class="n">eimag</span>
        <span class="k">return</span> <span class="n">transfer</span>

<div class="viewcode-block" id="SampledResponse.inverse"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.SampledResponse.inverse">[docs]</a>    <span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get inverse as a new :py:class:`SampledResponse` object.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">inv_or_none</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="n">x</span>

        <span class="k">return</span> <span class="n">SampledResponse</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">left</span><span class="o">=</span><span class="n">inv_or_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">),</span>
            <span class="n">right</span><span class="o">=</span><span class="n">inv_or_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="IntegrationResponse"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.IntegrationResponse">[docs]</a><span class="k">class</span> <span class="nc">IntegrationResponse</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The integration response, optionally multiplied by a constant gain.</span>

<span class="sd">    :param n: exponent (integer)</span>
<span class="sd">    :param gain: gain factor (float)</span>

<span class="sd">    ::</span>

<span class="sd">                    gain</span>
<span class="sd">        T(f) = --------------</span>
<span class="sd">               (j*2*pi * f)^n</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">Int</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">FrequencyResponse</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="n">gain</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="n">nonzero</span> <span class="o">=</span> <span class="n">freqs</span> <span class="o">!=</span> <span class="mf">0.0</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">freqs</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="n">resp</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gain</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0j</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freqs</span><span class="p">[</span><span class="n">nonzero</span><span class="p">])</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span>
        <span class="n">resp</span><span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">nonzero</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">resp</span>

</div>
<div class="viewcode-block" id="DifferentiationResponse"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.DifferentiationResponse">[docs]</a><span class="k">class</span> <span class="nc">DifferentiationResponse</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The differentiation response, optionally multiplied by a constant gain.</span>

<span class="sd">    :param n: exponent (integer)</span>
<span class="sd">    :param gain: gain factor (float)</span>

<span class="sd">    ::</span>

<span class="sd">        T(f) = gain * (j*2*pi * f)^n</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">Int</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">FrequencyResponse</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="n">gain</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gain</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0j</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">freqs</span><span class="p">)</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span>

</div>
<div class="viewcode-block" id="AnalogFilterResponse"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.AnalogFilterResponse">[docs]</a><span class="k">class</span> <span class="nc">AnalogFilterResponse</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Frequency response of an analog filter.</span>

<span class="sd">    (see :py:func:`scipy.signal.freqs`).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">())</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="n">FrequencyResponse</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">signal</span><span class="o">.</span><span class="n">freqs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">freqs</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="MultiplyResponse"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.MultiplyResponse">[docs]</a><span class="k">class</span> <span class="nc">MultiplyResponse</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Multiplication of several :py:class:`FrequencyResponse` objects.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">responses</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">FrequencyResponse</span><span class="o">.</span><span class="n">T</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">responses</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">responses</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">FrequencyResponse</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">responses</span><span class="o">=</span><span class="n">responses</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">freqs</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">resp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">*=</span> <span class="n">resp</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">a</span>

</div>
<span class="k">def</span> <span class="nf">asarray_1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;could not convert to 1D array&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">a</span>

<span class="n">cached_coefficients</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">_get_cached_filter_coefs</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">corners</span><span class="p">,</span> <span class="n">btype</span><span class="p">):</span>
    <span class="n">ck</span> <span class="o">=</span> <span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">corners</span><span class="p">),</span> <span class="n">btype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ck</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cached_coefficients</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corners</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cached_coefficients</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span>
                <span class="n">order</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">btype</span><span class="o">=</span><span class="n">btype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cached_coefficients</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span>
                <span class="n">order</span><span class="p">,</span> <span class="n">corners</span><span class="p">,</span> <span class="n">btype</span><span class="o">=</span><span class="n">btype</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cached_coefficients</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">_globals</span><span class="p">:</span>
    <span class="n">_numpy_has_correlate_flip_bug</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">_default_key</span><span class="p">(</span><span class="n">tr</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>


<div class="viewcode-block" id="numpy_has_correlate_flip_bug"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.numpy_has_correlate_flip_bug">[docs]</a><span class="k">def</span> <span class="nf">numpy_has_correlate_flip_bug</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Check if NumPy&#39;s correlate function reveals old behaviour</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">_globals</span><span class="o">.</span><span class="n">_numpy_has_correlate_flip_bug</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">ab</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">ba</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">_globals</span><span class="o">.</span><span class="n">_numpy_has_correlate_flip_bug</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ab</span> <span class="o">==</span> <span class="n">ba</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_globals</span><span class="o">.</span><span class="n">_numpy_has_correlate_flip_bug</span>

</div>
<div class="viewcode-block" id="numpy_correlate_fixed"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.numpy_correlate_fixed">[docs]</a><span class="k">def</span> <span class="nf">numpy_correlate_fixed</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;valid&#39;</span><span class="p">,</span> <span class="n">use_fft</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Call :py:func:`numpy.correlate` with fixes.</span>

<span class="sd">        c[k] = sum_i a[i+k] * conj(b[i])</span>

<span class="sd">    Note that the result produced by newer numpy.correlate is always flipped</span>
<span class="sd">    with respect to the formula given in its documentation (if ascending k</span>
<span class="sd">    assumed for the output).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">use_fft</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">b</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">buggy</span> <span class="o">=</span> <span class="n">numpy_has_correlate_flip_bug</span><span class="p">()</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">buggy</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">buggy</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span>

</div>
<div class="viewcode-block" id="numpy_correlate_emulate"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.numpy_correlate_emulate">[docs]</a><span class="k">def</span> <span class="nf">numpy_correlate_emulate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;valid&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Slow version of :py:func:`numpy.correlate` for comparison.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">kmin</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">klen</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">kmin</span>
    <span class="n">kmin</span><span class="p">,</span> <span class="n">kmax</span> <span class="o">=</span> <span class="n">numpy_correlate_lag_range</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="n">klen</span> <span class="o">=</span> <span class="n">kmax</span> <span class="o">-</span> <span class="n">kmin</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">klen</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">find_common_type</span><span class="p">((</span><span class="n">b</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="p">()))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">kmin</span><span class="p">,</span> <span class="n">kmin</span><span class="o">+</span><span class="n">klen</span><span class="p">):</span>
        <span class="n">imin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">k</span><span class="p">)</span>
        <span class="n">ilen</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">imin</span>
        <span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="n">kmin</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">a</span><span class="p">[</span><span class="n">imin</span><span class="o">+</span><span class="n">k</span><span class="p">:</span><span class="n">imin</span><span class="o">+</span><span class="n">ilen</span><span class="o">+</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">imin</span><span class="p">:</span><span class="n">imin</span><span class="o">+</span><span class="n">ilen</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">c</span>

</div>
<div class="viewcode-block" id="numpy_correlate_lag_range"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.numpy_correlate_lag_range">[docs]</a><span class="k">def</span> <span class="nf">numpy_correlate_lag_range</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;valid&#39;</span><span class="p">,</span> <span class="n">use_fft</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get range of lags for which :py:func:`numpy.correlate` produces values.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="n">kmin</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;full&#39;</span><span class="p">:</span>
        <span class="n">klen</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">kmin</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;same&#39;</span><span class="p">:</span>
        <span class="n">klen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">kmin</span> <span class="o">+=</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="o">+</span><span class="n">b</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">size</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> \
            <span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="n">use_fft</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;valid&#39;</span><span class="p">:</span>
        <span class="n">klen</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">kmin</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">kmin</span><span class="p">,</span> <span class="n">kmin</span> <span class="o">+</span> <span class="n">klen</span> <span class="o">-</span> <span class="mi">1</span>

</div>
<div class="viewcode-block" id="autocorr"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.autocorr">[docs]</a><span class="k">def</span> <span class="nf">autocorr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nshifts</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compute biased estimate of the first autocorrelation coefficients.</span>

<span class="sd">    :param x: input array</span>
<span class="sd">    :param nshifts: number of coefficients to calculate</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">mean</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span>
    <span class="n">xdm</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">mean</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nshifts</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nshifts</span><span class="p">):</span>
        <span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">((</span><span class="n">n</span><span class="o">-</span><span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">std</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xdm</span><span class="p">[:</span><span class="n">n</span><span class="o">-</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">xdm</span><span class="p">[</span><span class="n">k</span><span class="p">:])</span>

    <span class="k">return</span> <span class="n">r</span>

</div>
<div class="viewcode-block" id="yulewalker"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.yulewalker">[docs]</a><span class="k">def</span> <span class="nf">yulewalker</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compute autoregression coefficients using Yule-Walker method.</span>

<span class="sd">    :param x: input array</span>
<span class="sd">    :param order: number of coefficients to produce</span>

<span class="sd">    A biased estimate of the autocorrelation is used. The Yule-Walker equations</span>
<span class="sd">    are solved by :py:func:`numpy.linalg.inv` instead of Levinson-Durbin</span>
<span class="sd">    recursion which is normally used.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">gamma</span> <span class="o">=</span> <span class="n">autocorr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="n">order</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">order</span><span class="p">,</span> <span class="n">order</span><span class="p">))</span>
    <span class="n">gamma2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">gamma</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">order</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
        <span class="n">ioff</span> <span class="o">=</span> <span class="n">order</span><span class="o">-</span><span class="n">i</span>
        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">gamma2</span><span class="p">[</span><span class="n">ioff</span><span class="p">:</span><span class="n">ioff</span><span class="o">+</span><span class="n">order</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="o">-</span><span class="n">d</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">moving_avg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cx</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">nn</span><span class="o">-</span><span class="n">n</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span><span class="o">-</span><span class="n">cx</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">])</span><span class="o">/</span><span class="n">n</span>
    <span class="n">y</span><span class="p">[:</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">nn</span><span class="o">-</span><span class="n">n</span><span class="p">):]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">nn</span><span class="o">-</span><span class="n">n</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">y</span>


<span class="k">def</span> <span class="nf">moving_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;valid&#39;</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;valid&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nn</span><span class="o">-</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cx</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="o">-</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cx</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nn</span><span class="o">-</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">nn</span><span class="p">]</span><span class="o">-</span><span class="n">cx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nn</span><span class="o">-</span><span class="n">n</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;full&#39;</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="o">+</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cx</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">nn</span><span class="p">:</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">nn</span><span class="p">]</span><span class="o">-</span><span class="n">cx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nn</span><span class="o">-</span><span class="n">n</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">nn</span><span class="p">:</span><span class="n">nn</span><span class="o">+</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cx</span><span class="p">[</span><span class="n">nn</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">nn</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nn</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">nn</span><span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="n">nn</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">nn</span><span class="o">+</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="n">nn</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nn</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;same&#39;</span><span class="p">:</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cx</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">nn</span><span class="p">:</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="n">n1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="n">n1</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="n">n1</span><span class="p">:</span><span class="n">nn</span><span class="o">-</span><span class="n">n1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">nn</span><span class="p">]</span><span class="o">-</span><span class="n">cx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nn</span><span class="o">-</span><span class="n">n</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">nn</span><span class="o">-</span><span class="n">n1</span><span class="p">:</span><span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="n">nn</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cx</span><span class="p">[</span><span class="n">nn</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">nn</span><span class="o">-</span><span class="n">n</span><span class="o">+</span><span class="n">n1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nn</span><span class="o">-</span><span class="n">n1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">nn</span><span class="p">):</span><span class="n">nn</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">nn</span><span class="o">-</span><span class="n">n1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">n1</span><span class="p">,</span> <span class="n">nn</span><span class="p">)]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="n">nn</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">n1</span><span class="p">,</span> <span class="n">nn</span><span class="p">):</span><span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="n">nn</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nn</span><span class="o">-</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">n1</span><span class="p">))]</span>

    <span class="k">return</span> <span class="n">y</span>


<span class="k">def</span> <span class="nf">nextpow2</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">2</span><span class="o">**</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">snapper_w_offset</span><span class="p">(</span><span class="n">nmax</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">snapfun</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">snap</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">snapfun</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">offset</span><span class="p">)</span><span class="o">/</span><span class="n">delta</span><span class="p">)),</span> <span class="n">nmax</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">snap</span>


<span class="k">def</span> <span class="nf">snapper</span><span class="p">(</span><span class="n">nmax</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">snapfun</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">snap</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">snapfun</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">delta</span><span class="p">)),</span> <span class="n">nmax</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">snap</span>


<span class="k">def</span> <span class="nf">apply_costaper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="n">snapper_w_offset</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[:</span><span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">y</span><span class="p">[</span><span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">):</span><span class="n">hi</span><span class="p">(</span><span class="n">b</span><span class="p">)]</span> <span class="o">*=</span> <span class="mf">0.5</span> \
        <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">dx</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">hi</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">-</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">x0</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">hi</span><span class="p">(</span><span class="n">c</span><span class="p">):</span><span class="n">hi</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span> <span class="o">*=</span> <span class="mf">0.5</span> \
        <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">dx</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hi</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">hi</span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="o">-</span><span class="p">(</span><span class="n">c</span><span class="o">-</span><span class="n">x0</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">hi</span><span class="p">(</span><span class="n">d</span><span class="p">):]</span> <span class="o">=</span> <span class="mf">0.</span>


<span class="k">def</span> <span class="nf">span_costaper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="n">snapper_w_offset</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">hi</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">-</span> <span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">costaper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">nfreqs</span><span class="p">,</span> <span class="n">deltaf</span><span class="p">):</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="n">snapper</span><span class="p">(</span><span class="n">nfreqs</span><span class="p">,</span> <span class="n">deltaf</span><span class="p">)</span>
    <span class="n">tap</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nfreqs</span><span class="p">)</span>
    <span class="n">tap</span><span class="p">[</span><span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">):</span><span class="n">hi</span><span class="p">(</span><span class="n">b</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.5</span> \
        <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">deltaf</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hi</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">hi</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">tap</span><span class="p">[</span><span class="n">hi</span><span class="p">(</span><span class="n">b</span><span class="p">):</span><span class="n">hi</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">tap</span><span class="p">[</span><span class="n">hi</span><span class="p">(</span><span class="n">c</span><span class="p">):</span><span class="n">hi</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.5</span> \
        <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">deltaf</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hi</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">hi</span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tap</span>


<span class="k">def</span> <span class="nf">t2ind</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tdelta</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="nb">round</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">snap</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">tdelta</span><span class="p">))</span>


<div class="viewcode-block" id="hilbert"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.hilbert">[docs]</a><span class="k">def</span> <span class="nf">hilbert</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return the hilbert transform of x of length N.</span>

<span class="sd">    (from scipy.signal, but changed to use fft and ifft from numpy.fft)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;N must be positive.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;imaginary part of x ignored.&#39;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">Xf</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">:(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="p">[:,</span> <span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">Xf</span><span class="o">*</span><span class="n">h</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

</div>
<span class="k">def</span> <span class="nf">near</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">eps</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span>


<span class="k">def</span> <span class="nf">coroutine</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">gen</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">gen</span>

    <span class="n">wrapper</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="n">__dict__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__dict__</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__doc__</span>
    <span class="k">return</span> <span class="n">wrapper</span>


<div class="viewcode-block" id="States"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.States">[docs]</a><span class="k">class</span> <span class="nc">States</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Utility to store channel-specific state in coroutines.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_states</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tr</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">nslc_id</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_states</span><span class="p">:</span>
            <span class="n">tmin</span><span class="p">,</span> <span class="n">deltat</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_states</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">near</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="n">deltat</span><span class="o">/</span><span class="mf">100.</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">near</span><span class="p">(</span><span class="n">deltat</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="n">deltat</span><span class="o">/</span><span class="mf">10000.</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">tr</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>

                <span class="k">return</span> <span class="n">value</span>

        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">nslc_id</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_states</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_states</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_states</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_states</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">tmax</span><span class="o">+</span><span class="n">tr</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">pass</span>

</div>
<span class="nd">@coroutine</span>
<span class="k">def</span> <span class="nf">co_list_append</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="nb">list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="k">yield</span><span class="p">))</span>


<span class="nd">@coroutine</span>
<div class="viewcode-block" id="co_lfilter"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.co_lfilter">[docs]</a><span class="k">def</span> <span class="nf">co_lfilter</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Successively filter broken continuous trace data (coroutine).</span>

<span class="sd">    Create coroutine which takes :py:class:`Trace` objects, filters their data</span>
<span class="sd">    through :py:func:`scipy.signal.lfilter` and sends new :py:class:`Trace`</span>
<span class="sd">    objects containing the filtered data to target. This is useful, if one</span>
<span class="sd">    wants to filter a long continuous time series, which is split into many</span>
<span class="sd">    successive traces without producing filter artifacts at trace boundaries.</span>

<span class="sd">    Filter states are kept *per channel*, specifically, for each (network,</span>
<span class="sd">    station, location, channel) combination occuring in the input traces, a</span>
<span class="sd">    separate state is created and maintained. This makes it possible to filter</span>
<span class="sd">    multichannel or multistation data with only one :py:func:`co_lfilter`</span>
<span class="sd">    instance.</span>

<span class="sd">    Filter state is reset, when gaps occur.</span>

<span class="sd">    Use it like this::</span>

<span class="sd">      from pyrocko.trace import co_lfilter, co_list_append</span>

<span class="sd">      filtered_traces = []</span>
<span class="sd">      pipe = co_lfilter(co_list_append(filtered_traces), a, b)</span>
<span class="sd">      for trace in traces:</span>
<span class="sd">           pipe.send(trace)</span>

<span class="sd">      pipe.close()</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">States</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="p">(</span><span class="k">yield</span><span class="p">)</span>

            <span class="n">zi</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">zi</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">zi</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

            <span class="n">output</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">ydata</span><span class="p">,</span> <span class="n">zf</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="nb">input</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span> <span class="n">zi</span><span class="o">=</span><span class="n">zi</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">ydata</span><span class="p">)</span>
            <span class="n">states</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">zf</span><span class="p">)</span>
            <span class="n">target</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
        <span class="n">target</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</div>
<span class="k">def</span> <span class="nf">co_antialias</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s">&#39;fir&#39;</span><span class="p">):</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">decimate_coeffs</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ftype</span><span class="p">)</span>
    <span class="n">anti</span> <span class="o">=</span> <span class="n">co_lfilter</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">anti</span>


<span class="nd">@coroutine</span>
<span class="k">def</span> <span class="nf">co_dropsamples</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">nfir</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">States</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="p">(</span><span class="k">yield</span><span class="p">)</span>
            <span class="n">newdeltat</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">tr</span><span class="o">.</span><span class="n">deltat</span>
            <span class="n">ioffset</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ioffset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># for fir filter, the first nfir samples are pulluted by</span>
                <span class="c"># boundary effects; cut it off.</span>
                <span class="c"># for iir this may be (much) more, we do not correct for that.</span>
                <span class="c"># put sample instances to a time which is a multiple of the</span>
                <span class="c"># new sampling interval.</span>
                <span class="n">newtmin_want</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="p">(</span><span class="n">nfir</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">tr</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span> <span class="o">/</span> <span class="n">newdeltat</span><span class="p">)</span> <span class="o">*</span> <span class="n">newdeltat</span> \
                    <span class="o">-</span> <span class="p">(</span><span class="n">nfir</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">tr</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>
                <span class="n">ioffset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">newtmin_want</span> <span class="o">-</span> <span class="n">tr</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="n">tr</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">ioffset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ioffset</span> <span class="o">=</span> <span class="n">ioffset</span> <span class="o">%</span> <span class="n">q</span>

            <span class="n">newtmin_have</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">tmin</span> <span class="o">+</span> <span class="n">ioffset</span> <span class="o">*</span> <span class="n">tr</span><span class="o">.</span><span class="n">deltat</span>
            <span class="n">newtr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">newtr</span><span class="o">.</span><span class="n">deltat</span> <span class="o">=</span> <span class="n">newdeltat</span>
            <span class="c"># because the fir kernel shifts data by nfir/2 samples:</span>
            <span class="n">newtr</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="n">newtmin_have</span> <span class="o">-</span> <span class="p">(</span><span class="n">nfir</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">tr</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>
            <span class="n">newtr</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()[</span><span class="n">ioffset</span><span class="p">::</span><span class="n">q</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">states</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="p">(</span><span class="n">ioffset</span> <span class="o">%</span> <span class="n">q</span> <span class="o">-</span> <span class="n">tr</span><span class="o">.</span><span class="n">data_len</span><span class="p">()</span> <span class="o">%</span> <span class="n">q</span><span class="p">)</span> <span class="o">%</span> <span class="n">q</span><span class="p">)</span>
            <span class="n">target</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">newtr</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
        <span class="n">target</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<div class="viewcode-block" id="co_downsample"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.co_downsample">[docs]</a><span class="k">def</span> <span class="nf">co_downsample</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s">&#39;fir&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Successively downsample broken continuous trace data (coroutine).</span>

<span class="sd">    Create coroutine which takes :py:class:`Trace` objects, downsamples their</span>
<span class="sd">    data and sends new :py:class:`Trace` objects containing the downsampled</span>
<span class="sd">    data to target.  This is useful, if one wants to downsample a long</span>
<span class="sd">    continuous time series, which is split into many successive traces without</span>
<span class="sd">    producing filter artifacts and gaps at trace boundaries.</span>

<span class="sd">    Filter states are kept *per channel*, specifically, for each (network,</span>
<span class="sd">    station, location, channel) combination occuring in the input traces, a</span>
<span class="sd">    separate state is created and maintained. This makes it possible to filter</span>
<span class="sd">    multichannel or multistation data with only one :py:func:`co_lfilter`</span>
<span class="sd">    instance.</span>

<span class="sd">    Filter state is reset, when gaps occur. The sampling instances are choosen</span>
<span class="sd">    so that they occur at (or as close as possible) to even multiples of the</span>
<span class="sd">    sampling interval of the downsampled trace (based on system time).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">decimate_coeffs</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ftype</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">co_antialias</span><span class="p">(</span><span class="n">co_dropsamples</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ftype</span><span class="p">)</span>

</div>
<span class="nd">@coroutine</span>
<span class="k">def</span> <span class="nf">co_downsample_to</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">deltat</span><span class="p">):</span>

    <span class="n">decimators</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="p">(</span><span class="k">yield</span><span class="p">)</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">deltat</span> <span class="o">/</span> <span class="n">tr</span><span class="o">.</span><span class="n">deltat</span>
            <span class="n">rratio</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rratio</span> <span class="o">-</span> <span class="n">ratio</span><span class="p">)</span><span class="o">/</span><span class="n">ratio</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">util</span><span class="o">.</span><span class="n">UnavailableDecimation</span><span class="p">(</span><span class="s">&#39;ratio = </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">ratio</span><span class="p">)</span>

            <span class="n">deci_seq</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">decitab</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rratio</span><span class="p">))</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">deci_seq</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">decimators</span><span class="p">:</span>
                <span class="n">pipe</span> <span class="o">=</span> <span class="n">target</span>
                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">deci_seq</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">pipe</span> <span class="o">=</span> <span class="n">co_downsample</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>

                <span class="n">decimators</span><span class="p">[</span><span class="n">deci_seq</span><span class="p">]</span> <span class="o">=</span> <span class="n">pipe</span>

            <span class="n">decimators</span><span class="p">[</span><span class="n">deci_seq</span><span class="p">]</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">decimators</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">g</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<div class="viewcode-block" id="DomainChoice"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.DomainChoice">[docs]</a><span class="k">class</span> <span class="nc">DomainChoice</span><span class="p">(</span><span class="n">StringChoice</span><span class="p">):</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&#39;time_domain&#39;</span><span class="p">,</span>
        <span class="s">&#39;frequency_domain&#39;</span><span class="p">,</span>
        <span class="s">&#39;envelope&#39;</span><span class="p">,</span>
        <span class="s">&#39;absolute&#39;</span><span class="p">,</span>
        <span class="s">&#39;cc_max_norm&#39;</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="MisfitSetup"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.MisfitSetup">[docs]</a><span class="k">class</span> <span class="nc">MisfitSetup</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Contains misfit setup to be used in :py:func:`trace.misfit`</span>

<span class="sd">    :param description: Description of the setup</span>
<span class="sd">    :param norm: L-norm classifier</span>
<span class="sd">    :param taper: Object of :py:class:`Taper`</span>
<span class="sd">    :param filter: Object of :py:class:`FrequencyResponse`</span>
<span class="sd">    :param domain: [&#39;time_domain&#39;, &#39;frequency_domain&#39;, &#39;envelope&#39;, &#39;absolute&#39;,</span>
<span class="sd">        &#39;cc_max_norm&#39;]</span>

<span class="sd">    Can be dumped to a yaml file.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">xmltagname</span> <span class="o">=</span> <span class="s">&#39;misfitsetup&#39;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">Int</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">taper</span> <span class="o">=</span> <span class="n">Taper</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nb">filter</span> <span class="o">=</span> <span class="n">FrequencyResponse</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">DomainChoice</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">&#39;time_domain&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="equalize_sampling_rates"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.equalize_sampling_rates">[docs]</a><span class="k">def</span> <span class="nf">equalize_sampling_rates</span><span class="p">(</span><span class="n">trace_1</span><span class="p">,</span> <span class="n">trace_2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Equalize sampling rates of two traces (reduce higher sampling rate to</span>
<span class="sd">    lower).</span>

<span class="sd">    :param trace_1: :py:class:`Trace` object</span>
<span class="sd">    :param trace_2: :py:class:`Trace` object</span>

<span class="sd">    Returns a copy of the resampled trace if resampling is needed.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">same_sampling_rate</span><span class="p">(</span><span class="n">trace_1</span><span class="p">,</span> <span class="n">trace_2</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">trace_1</span><span class="p">,</span> <span class="n">trace_2</span>

    <span class="k">if</span> <span class="n">trace_1</span><span class="o">.</span><span class="n">deltat</span> <span class="o">&lt;</span> <span class="n">trace_2</span><span class="o">.</span><span class="n">deltat</span><span class="p">:</span>
        <span class="n">t1_out</span> <span class="o">=</span> <span class="n">trace_1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">t1_out</span><span class="o">.</span><span class="n">downsample_to</span><span class="p">(</span><span class="n">deltat</span><span class="o">=</span><span class="n">trace_2</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Trace downsampled (return copy of trace): </span><span class="si">%s</span><span class="s">&#39;</span>
                     <span class="o">%</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t1_out</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">t1_out</span><span class="p">,</span> <span class="n">trace_2</span>

    <span class="k">elif</span> <span class="n">trace_1</span><span class="o">.</span><span class="n">deltat</span> <span class="o">&gt;</span> <span class="n">trace_2</span><span class="o">.</span><span class="n">deltat</span><span class="p">:</span>
        <span class="n">t2_out</span> <span class="o">=</span> <span class="n">trace_2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">t2_out</span><span class="o">.</span><span class="n">downsample_to</span><span class="p">(</span><span class="n">deltat</span><span class="o">=</span><span class="n">trace_1</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Trace downsampled (return copy of trace): </span><span class="si">%s</span><span class="s">&#39;</span>
                     <span class="o">%</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t2_out</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">trace_1</span><span class="p">,</span> <span class="n">t2_out</span>

</div>
<div class="viewcode-block" id="Lx_norm"><a class="viewcode-back" href="../../trace.html#pyrocko.trace.Lx_norm">[docs]</a><span class="k">def</span> <span class="nf">Lx_norm</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate the misfit denominator *m* and the normalization devisor *n*</span>
<span class="sd">    according to norm.</span>

<span class="sd">    The normalization divisor *n* is calculated from *v*.</span>

<span class="sd">    :param u: :py:class:`numpy.array`</span>
<span class="sd">    :param v: :py:class:`numpy.array`</span>
<span class="sd">    :param norm: (default = 2)</span>

<span class="sd">    *u* and *v* must be of same size.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">norm</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v</span><span class="o">-</span><span class="n">u</span><span class="p">)),</span>
            <span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>

    <span class="k">elif</span> <span class="n">norm</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">v</span><span class="o">-</span><span class="n">u</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span>
            <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">num</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">u</span><span class="p">,</span> <span class="n">norm</span><span class="p">))),</span> <span class="mf">1.</span><span class="o">/</span><span class="n">norm</span><span class="p">),</span>
            <span class="n">num</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">norm</span><span class="p">))),</span> <span class="mf">1.</span><span class="o">/</span><span class="n">norm</span><span class="p">))</span>

</div>
<span class="k">def</span> <span class="nf">do_downsample</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">deltat</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">deltat</span> <span class="o">-</span> <span class="n">deltat</span><span class="p">)</span> <span class="o">/</span> <span class="n">tr</span><span class="o">.</span><span class="n">deltat</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">downsample_to</span><span class="p">(</span><span class="n">deltat</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">demean</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">tmin</span><span class="o">/</span><span class="n">tr</span><span class="o">.</span><span class="n">deltat</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="ow">or</span> <span class="n">tr</span><span class="o">.</span><span class="n">tmax</span><span class="o">/</span><span class="n">tr</span><span class="o">.</span><span class="n">deltat</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">snap</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">tr</span>


<span class="k">def</span> <span class="nf">do_extend</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">tmin</span> <span class="o">&lt;</span> <span class="n">tr</span><span class="o">.</span><span class="n">tmin</span> <span class="ow">or</span> <span class="n">tmax</span> <span class="o">&gt;</span> <span class="n">tr</span><span class="o">.</span><span class="n">tmax</span><span class="p">:</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tmin</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="n">tmax</span><span class="p">,</span> <span class="n">fillmethod</span><span class="o">=</span><span class="s">&#39;repeat&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tr</span>


<span class="k">def</span> <span class="nf">do_pre_taper</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">taper</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tr</span><span class="o">.</span><span class="n">taper</span><span class="p">(</span><span class="n">taper</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">chop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">do_fft</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">filter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ndata</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span>
        <span class="n">nfft</span> <span class="o">=</span> <span class="n">nextpow2</span><span class="p">(</span><span class="n">ndata</span><span class="p">)</span>
        <span class="n">padded</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nfft</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">padded</span><span class="p">[:</span><span class="n">ndata</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">ydata</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">padded</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">deltat</span> <span class="o">*</span> <span class="n">nfft</span><span class="p">)</span>
        <span class="n">frequencies</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">*</span><span class="n">df</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">tr</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">do_filter</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">filter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">inp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tr</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">,</span> <span class="n">spectrum</span> <span class="o">=</span> <span class="n">inp</span>
        <span class="n">spectrum</span> <span class="o">*=</span> <span class="nb">filter</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">tr</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">do_ifft</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">Trace</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">inp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">spectrum</span> <span class="o">=</span> <span class="n">inp</span>
        <span class="n">ndata</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)[:</span><span class="n">ndata</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">tr</span>


<span class="k">def</span> <span class="nf">check_alignment</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">tmin</span><span class="o">-</span><span class="n">t2</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">t1</span><span class="o">.</span><span class="n">deltat</span> <span class="o">*</span> <span class="mf">1e-4</span> <span class="ow">or</span> \
            <span class="nb">abs</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">tmax</span> <span class="o">-</span> <span class="n">t2</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">t1</span><span class="o">.</span><span class="n">deltat</span> <span class="o">*</span> <span class="mf">1e-4</span> <span class="ow">or</span> \
            <span class="n">t1</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">t2</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MisalignedTraces</span><span class="p">(</span>
                    <span class="s">&#39;Cannot calculate misfit of </span><span class="si">%s</span><span class="s"> and </span><span class="si">%s</span><span class="s"> due to misaligned &#39;</span>
                    <span class="s">&#39;traces.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">),</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t2</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">)))</span>
</pre></div>

          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Pyrocko v0.3 Manual</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2016, The Pyrocko Developers. <img src="http://kinherd.org/pyrocko.png" width="5" height="5">
    </div>
  </body>
</html>