

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyrocko.util &mdash; Pyrocko v0.3 Manual</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Pyrocko v0.3 Manual"
          href="../../_static/opensearch.xml"/>
    <link rel="top" title="Pyrocko v0.3 Manual" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Pyrocko v0.3 Manual</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <h1>Source code for pyrocko.util</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;Utility functions for Pyrocko.&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">calendar</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">fnmatch</span><span class="o">,</span> <span class="nn">errno</span><span class="o">,</span> <span class="nn">fcntl</span><span class="o">,</span> <span class="nn">shlex</span><span class="o">,</span> <span class="nn">optparse</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">pjoin</span>
<span class="kn">import</span> <span class="nn">config</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">num</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;pyrocko.util&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">progressbar</span> <span class="kn">as</span> <span class="nn">progressbar_mod</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">dummy_progressbar</span> <span class="kn">as</span> <span class="nn">progressbar_mod</span>

<div class="viewcode-block" id="progressbar_module"><a class="viewcode-back" href="../../util.html#pyrocko.util.progressbar_module">[docs]</a><span class="k">def</span> <span class="nf">progressbar_module</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">progressbar_mod</span>
</div>
<div class="viewcode-block" id="setup_logging"><a class="viewcode-back" href="../../util.html#pyrocko.util.setup_logging">[docs]</a><span class="k">def</span> <span class="nf">setup_logging</span><span class="p">(</span><span class="n">programname</span><span class="o">=</span><span class="s">&#39;pyrocko&#39;</span><span class="p">,</span> <span class="n">levelname</span><span class="o">=</span><span class="s">&#39;warning&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Initialize logging.</span>
<span class="sd">    </span>
<span class="sd">    :param programname: program name to be written in log</span>
<span class="sd">    :param levelname: string indicating the logging level (&#39;debug&#39;, &#39;info&#39;, </span>
<span class="sd">        &#39;warning&#39;, &#39;error&#39;, &#39;critical&#39;)</span>
<span class="sd">    </span>
<span class="sd">    This function is called at startup by most pyrocko programs to set up a </span>
<span class="sd">    consistent logging format. This is simply a shortcut to a call to</span>
<span class="sd">    :py:func:`logging.basicConfig()`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">levels</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;debug&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
              <span class="s">&#39;info&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
              <span class="s">&#39;warning&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
              <span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
              <span class="s">&#39;critical&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">}</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
        <span class="n">level</span><span class="o">=</span><span class="n">levels</span><span class="p">[</span><span class="n">levelname</span><span class="p">],</span>
        <span class="n">format</span> <span class="o">=</span> <span class="n">programname</span><span class="o">+</span><span class="s">&#39;:</span><span class="si">%(name)-20s</span><span class="s"> - </span><span class="si">%(levelname)-8s</span><span class="s"> - </span><span class="si">%(message)s</span><span class="s">&#39;</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="data_file"><a class="viewcode-back" href="../../util.html#pyrocko.util.data_file">[docs]</a><span class="k">def</span> <span class="nf">data_file</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
</div>
<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="s">&#39;float128&#39;</span><span class="p">):</span>
    <span class="n">hpfloat</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">float128</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">hpfloat</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;NumPy lacks support for float128 data type on this platform.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Stopwatch"><a class="viewcode-back" href="../../util.html#pyrocko.util.Stopwatch">[docs]</a><span class="k">class</span> <span class="nc">Stopwatch</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Simple stopwatch to measure elapsed wall clock time.</span>
<span class="sd">    </span>
<span class="sd">    Usage::</span>

<span class="sd">        s = Stopwatch()</span>
<span class="sd">        time.sleep(1)</span>
<span class="sd">        print s()</span>
<span class="sd">        time.sleep(1)</span>
<span class="sd">        print s()</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
   </div>
<div class="viewcode-block" id="wrap"><a class="viewcode-back" href="../../util.html#pyrocko.util.wrap">[docs]</a><span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">line_length</span><span class="o">=</span><span class="mi">80</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Paragraph and list-aware wrapping of text.&#39;&#39;&#39;</span>
    
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">at_lineend</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39; *\n&#39;</span><span class="p">)</span>
    <span class="n">at_para</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;((^|(\n\s*)?\n)(\s+[*] )|\n\s*\n)&#39;</span><span class="p">)</span>
        
    <span class="n">paragraphs</span> <span class="o">=</span>  <span class="n">at_para</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">text</span><span class="p">)[::</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">listindents</span> <span class="o">=</span> <span class="n">at_para</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">text</span><span class="p">)[</span><span class="mi">4</span><span class="p">::</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">newlist</span> <span class="o">=</span> <span class="n">at_para</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">text</span><span class="p">)[</span><span class="mi">3</span><span class="p">::</span><span class="mi">5</span><span class="p">]</span>
   
    <span class="n">listindents</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
    <span class="n">listindents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">newlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
  
    <span class="n">det_indent</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^ *&#39;</span><span class="p">)</span>
    
    <span class="n">iso_latin_1_enc_failed</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">outlines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="k">if</span> <span class="n">listindents</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">_indent</span> <span class="o">=</span> <span class="n">det_indent</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">findent</span> <span class="o">=</span> <span class="n">_indent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">findent</span> <span class="o">=</span> <span class="n">listindents</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
            <span class="n">_indent</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">findent</span><span class="p">)</span>
        
        <span class="n">ll</span> <span class="o">=</span> <span class="n">line_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">_indent</span><span class="p">)</span>
        <span class="n">llf</span> <span class="o">=</span> <span class="n">ll</span>
        
        <span class="n">oldlines</span> <span class="o">=</span> <span class="p">[</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">at_lineend</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span> <span class="p">]</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">oldlines</span> <span class="p">)</span>
        <span class="n">possible</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(^.{1,</span><span class="si">%i</span><span class="s">}|.{1,</span><span class="si">%i</span><span class="s">})( |$)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">llf</span><span class="p">,</span> <span class="n">ll</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">imatch</span><span class="p">,</span> <span class="n">match</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">possible</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">p1</span><span class="p">)):</span>
            <span class="n">parout</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">imatch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">outlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">findent</span> <span class="o">+</span> <span class="n">parout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_indent</span> <span class="o">+</span> <span class="n">parout</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">ip</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">listindents</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">newlist</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">listindents</span><span class="p">[</span><span class="n">ip</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">outlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">outlines</span>
</div>
<div class="viewcode-block" id="BetterHelpFormatter"><a class="viewcode-back" href="../../util.html#pyrocko.util.BetterHelpFormatter">[docs]</a><span class="k">class</span> <span class="nc">BetterHelpFormatter</span><span class="p">(</span><span class="n">optparse</span><span class="o">.</span><span class="n">IndentedHelpFormatter</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">optparse</span><span class="o">.</span><span class="n">IndentedHelpFormatter</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="BetterHelpFormatter.format_option"><a class="viewcode-back" href="../../util.html#pyrocko.util.BetterHelpFormatter.format_option">[docs]</a>    <span class="k">def</span> <span class="nf">format_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;From IndentedHelpFormatter but using a different wrap method.&#39;&#39;&#39;</span>

        <span class="n">help_text_position</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_indent</span>
        <span class="n">help_text_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">help_text_position</span>
       
        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_strings</span><span class="p">[</span><span class="n">option</span><span class="p">]</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%*s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_indent</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">option</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
            <span class="n">help_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_default</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">help_position</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">help_text</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%-*s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">help_position</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">help_text</span><span class="p">),</span> <span class="s">&#39;&#39;</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">option</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
                <span class="n">help_lines</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span><span class="n">help_text</span><span class="p">,</span> <span class="n">help_text_width</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&quot;</span><span class="si">%*s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">help_text_position</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">help_lines</span><span class="p">])</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BetterHelpFormatter.format_description"><a class="viewcode-back" href="../../util.html#pyrocko.util.BetterHelpFormatter.format_description">[docs]</a>    <span class="k">def</span> <span class="nf">format_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_indent</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">wrap</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_indent</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_indent</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%*s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_indent</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">])</span> 

</div></div>
<div class="viewcode-block" id="progressbar"><a class="viewcode-back" href="../../util.html#pyrocko.util.progressbar">[docs]</a><span class="k">def</span> <span class="nf">progressbar</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">maxval</span><span class="p">):</span>
    <span class="n">widgets</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">,</span>
            <span class="n">progressbar_mod</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">left</span><span class="o">=</span><span class="s">&#39;[&#39;</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="s">&#39;]&#39;</span><span class="p">),</span> <span class="s">&#39; &#39;</span><span class="p">,</span>
            <span class="n">progressbar_mod</span><span class="o">.</span><span class="n">Percentage</span><span class="p">(),</span> <span class="s">&#39; &#39;</span><span class="p">,]</span>
       
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">progressbar_mod</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">widgets</span><span class="o">=</span><span class="n">widgets</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="n">maxval</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pbar</span>
</div>
<div class="viewcode-block" id="progress_beg"><a class="viewcode-back" href="../../util.html#pyrocko.util.progress_beg">[docs]</a><span class="k">def</span> <span class="nf">progress_beg</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Notify user that an operation has started.</span>
<span class="sd">    </span>
<span class="sd">    :param label: name of the operation</span>
<span class="sd">    </span>
<span class="sd">    To be used in conjuction with :py:func:`progress_end`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="progress_end"><a class="viewcode-back" href="../../util.html#pyrocko.util.progress_end">[docs]</a><span class="k">def</span> <span class="nf">progress_end</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Notify user that an operation has ended. </span>
<span class="sd">    </span>
<span class="sd">    :param label: name of the operation</span>
<span class="sd">    </span>
<span class="sd">    To be used in conjuction with :py:func:`progress_beg`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; done. </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        </div>
<div class="viewcode-block" id="polylinefit"><a class="viewcode-back" href="../../util.html#pyrocko.util.polylinefit">[docs]</a><span class="k">def</span> <span class="nf">polylinefit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">n_or_xnodes</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Fit piece-wise linear function to data.</span>
<span class="sd">    </span>
<span class="sd">    :param x,y: arrays with coordinates of data</span>
<span class="sd">    :param n_or_xnodes: int, number of segments or x coordinates of polyline</span>

<span class="sd">    :returns: `(xnodes, ynodes, rms_error)` arrays with coordinates of polyline, root-mean-square error</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_or_xnodes</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n_or_xnodes</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">xnodes</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xnodes</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">n_or_xnodes</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">xnodes</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="n">ndata</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ndata</span><span class="o">+</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">xmin_block</span> <span class="o">=</span> <span class="n">xnodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">xmax_block</span> <span class="o">=</span> <span class="n">xnodes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c"># don&#39;t loose last point</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">xmin_block</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">xmax_block</span><span class="p">)</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">xmin_block</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">xmax_block</span><span class="p">)</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">a</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">a</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">w</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ndata</span><span class="p">)</span><span class="o">*</span><span class="mf">100.</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">a</span><span class="p">[</span><span class="n">ndata</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">xmax_block</span><span class="o">*</span><span class="n">w</span>
            <span class="n">a</span><span class="p">[</span><span class="n">ndata</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">w</span>
            <span class="n">a</span><span class="p">[</span><span class="n">ndata</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">xmax_block</span><span class="o">*</span><span class="n">w</span>
            <span class="n">a</span><span class="p">[</span><span class="n">ndata</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">w</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">y</span><span class="p">,</span><span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">ynodes</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ynodes</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xnodes</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ynodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">model</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xnodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">model</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ynodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">0.5</span>
    
    <span class="n">rms_error</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">num</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xnodes</span><span class="p">,</span> <span class="n">ynodes</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">xnodes</span><span class="p">,</span> <span class="n">ynodes</span><span class="p">,</span> <span class="n">rms_error</span>
</div>
<div class="viewcode-block" id="GlobalVars"><a class="viewcode-back" href="../../util.html#pyrocko.util.GlobalVars">[docs]</a><span class="k">class</span> <span class="nc">GlobalVars</span><span class="p">:</span>
    <span class="n">reuse_store</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">decitab_nmax</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">decitab</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">decimate_fir_coeffs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">decimate_iir_coeffs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">re_frac</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="decimate_coeffs"><a class="viewcode-back" href="../../util.html#pyrocko.util.decimate_coeffs">[docs]</a><span class="k">def</span> <span class="nf">decimate_coeffs</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s">&#39;iir&#39;</span><span class="p">):</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">,</span> <span class="s">&quot;q should be an integer&quot;</span>

    <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s">&#39;fir&#39;</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">8</span>
            
    <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s">&#39;fir&#39;</span><span class="p">:</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">decimate_fir_coeffs</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">q</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">coeffs</span><span class="p">:</span>
            <span class="n">coeffs</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mf">1.</span><span class="o">/</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">firwin</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">q</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s">&#39;hamming&#39;</span><span class="p">)</span>
        
        <span class="n">b</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mf">1.</span><span class="o">/</span><span class="n">q</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">b</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.</span><span class="p">],</span> <span class="n">n</span> 

    <span class="k">else</span><span class="p">:</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">decimate_iir_coeffs</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.8</span><span class="o">/</span><span class="n">q</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">coeffs</span><span class="p">:</span>
            <span class="n">coeffs</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.8</span><span class="o">/</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">cheby1</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.8</span><span class="o">/</span><span class="n">q</span><span class="p">)</span>
           
        <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.8</span><span class="o">/</span><span class="n">q</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">n</span>

</div>
<div class="viewcode-block" id="decimate"><a class="viewcode-back" href="../../util.html#pyrocko.util.decimate">[docs]</a><span class="k">def</span> <span class="nf">decimate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s">&#39;iir&#39;</span><span class="p">,</span> <span class="n">zi</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Downsample the signal x by an integer factor q, using an order n filter</span>
<span class="sd">    </span>
<span class="sd">    By default, an order 8 Chebyshev type I filter is used or a 30 point FIR </span>
<span class="sd">    filter with hamming window if ftype is &#39;fir&#39;.</span>

<span class="sd">    :param x: the signal to be downsampled (1D NumPy array)</span>
<span class="sd">    :param q: the downsampling factor</span>
<span class="sd">    :param n: order of the filter (1 less than the length of the filter for a</span>
<span class="sd">         &#39;fir&#39; filter)</span>
<span class="sd">    :param ftype: type of the filter; can be &#39;iir&#39; or &#39;fir&#39;</span>
<span class="sd">    </span>
<span class="sd">    :returns: the downsampled signal (1D NumPy array)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">decimate_coeffs</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">ftype</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="n">zi</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">zi</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">zi_</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">zi_</span> <span class="o">=</span> <span class="n">zi</span>
    
    <span class="n">y</span><span class="p">,</span> <span class="n">zf</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">zi</span><span class="o">=</span><span class="n">zi_</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">zi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">::</span><span class="n">q</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">zf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">::</span><span class="n">q</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    </div>
<div class="viewcode-block" id="UnavailableDecimation"><a class="viewcode-back" href="../../util.html#pyrocko.util.UnavailableDecimation">[docs]</a><span class="k">class</span> <span class="nc">UnavailableDecimation</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Exception raised by :py:func:`decitab` for unavailable decimation factors.&#39;&#39;&#39;</span>

    <span class="k">pass</span>
    
    
    </div>
<div class="viewcode-block" id="gcd"><a class="viewcode-back" href="../../util.html#pyrocko.util.gcd">[docs]</a><span class="k">def</span> <span class="nf">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Greatest common divisor.&#39;&#39;&#39;</span>
    
    <span class="k">while</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="o">*</span><span class="n">a</span><span class="p">:</span>
       <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span>

    <span class="k">return</span> <span class="n">a</span>
</div>
<div class="viewcode-block" id="lcm"><a class="viewcode-back" href="../../util.html#pyrocko.util.lcm">[docs]</a><span class="k">def</span> <span class="nf">lcm</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Least common multiple.&#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="o">/</span><span class="n">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="mk_decitab"><a class="viewcode-back" href="../../util.html#pyrocko.util.mk_decitab">[docs]</a><span class="k">def</span> <span class="nf">mk_decitab</span><span class="p">(</span><span class="n">nmax</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Make table with decimation sequences.</span>
<span class="sd">    </span>
<span class="sd">    Decimation from one sampling rate to a lower one is achieved by a successive</span>
<span class="sd">    application of :py:func:`decimation` with small integer downsampling </span>
<span class="sd">    factors (because using large downampling factors can make the decimation</span>
<span class="sd">    unstable or slow). This function sets up a table with downsample sequences</span>
<span class="sd">    for factors up to `nmax`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">tab</span> <span class="o">=</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">decitab</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">m</span>
                        <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">nmax</span><span class="p">:</span> <span class="k">break</span>
                        <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tab</span><span class="p">:</span>
                            <span class="n">tab</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">l</span> <span class="o">&gt;</span> <span class="n">nmax</span><span class="p">:</span> <span class="k">break</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="o">*</span><span class="n">k</span> <span class="o">&gt;</span> <span class="n">nmax</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">*</span><span class="n">j</span> <span class="o">&gt;</span> <span class="n">nmax</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">nmax</span><span class="p">:</span> <span class="k">break</span>
        
    <span class="n">GlobalVars</span><span class="o">.</span><span class="n">decitab_nmax</span> <span class="o">=</span> <span class="n">nmax</span>
    </div>
<div class="viewcode-block" id="day_start"><a class="viewcode-back" href="../../util.html#pyrocko.util.day_start">[docs]</a><span class="k">def</span> <span class="nf">day_start</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get beginning of day for any point in time.</span>
<span class="sd">    </span>
<span class="sd">    :param timestamp: time instant as system timestamp (in seconds)</span>

<span class="sd">    :returns: instant of day start as system timestamp</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
    <span class="n">tts</span> <span class="o">=</span> <span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">tt</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">tts</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="month_start"><a class="viewcode-back" href="../../util.html#pyrocko.util.month_start">[docs]</a><span class="k">def</span> <span class="nf">month_start</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get beginning of month for any point in time.</span>
<span class="sd">    </span>
<span class="sd">    :param timestamp: time instant as system timestamp (in seconds)</span>

<span class="sd">    :returns: instant of month start as system timestamp</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
    <span class="n">tts</span> <span class="o">=</span> <span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">tt</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">tts</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="year_start"><a class="viewcode-back" href="../../util.html#pyrocko.util.year_start">[docs]</a><span class="k">def</span> <span class="nf">year_start</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get beginning of year for any point in time.</span>
<span class="sd">    </span>
<span class="sd">    :param timestamp: time instant as system timestamp (in seconds)</span>

<span class="sd">    :returns: instant of year start as system timestamp</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
    <span class="n">tts</span> <span class="o">=</span> <span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">tt</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">tts</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="iter_days"><a class="viewcode-back" href="../../util.html#pyrocko.util.iter_days">[docs]</a><span class="k">def</span> <span class="nf">iter_days</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Yields begin and end of days until given time span is covered.</span>

<span class="sd">    :param tmin,tmax: input time span</span>
<span class="sd">    </span>
<span class="sd">    :yields: tuples with (begin, end) of days as system timestamps</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">day_start</span><span class="p">(</span><span class="n">tmin</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">tmax</span><span class="p">:</span>
        <span class="n">tend</span> <span class="o">=</span> <span class="n">day_start</span><span class="p">(</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">26</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span> <span class="p">)</span>
        <span class="k">yield</span> <span class="n">t</span><span class="p">,</span> <span class="n">tend</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">tend</span>
</div>
<div class="viewcode-block" id="iter_months"><a class="viewcode-back" href="../../util.html#pyrocko.util.iter_months">[docs]</a><span class="k">def</span> <span class="nf">iter_months</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Yields begin and end of months until given time span is covered.</span>

<span class="sd">    :param tmin,tmax: input time span</span>
<span class="sd">    </span>
<span class="sd">    :yields: tuples with (begin, end) of months as system timestamps</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">t</span> <span class="o">=</span> <span class="n">month_start</span><span class="p">(</span><span class="n">tmin</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">tmax</span><span class="p">:</span>
        <span class="n">tend</span> <span class="o">=</span> <span class="n">month_start</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">33</span> <span class="p">)</span>
        <span class="k">yield</span> <span class="n">t</span><span class="p">,</span> <span class="n">tend</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">tend</span>
</div>
<div class="viewcode-block" id="iter_years"><a class="viewcode-back" href="../../util.html#pyrocko.util.iter_years">[docs]</a><span class="k">def</span> <span class="nf">iter_years</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Yields begin and end of years until given time span is covered.</span>

<span class="sd">    :param tmin,tmax: input time span</span>
<span class="sd">    </span>
<span class="sd">    :yields: tuples with (begin, end) of years as system timestamps</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">t</span> <span class="o">=</span> <span class="n">year_start</span><span class="p">(</span><span class="n">tmin</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">tmax</span><span class="p">:</span>
        <span class="n">tend</span> <span class="o">=</span> <span class="n">year_start</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">369</span> <span class="p">)</span>
        <span class="k">yield</span> <span class="n">t</span><span class="p">,</span> <span class="n">tend</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">tend</span>
</div>
<div class="viewcode-block" id="decitab"><a class="viewcode-back" href="../../util.html#pyrocko.util.decitab">[docs]</a><span class="k">def</span> <span class="nf">decitab</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get integer decimation sequence for given downampling factor.</span>
<span class="sd">    </span>
<span class="sd">    :param n: target decimation factor</span>
<span class="sd">    </span>
<span class="sd">    :returns: tuple with downsampling sequence</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">decitab_nmax</span><span class="p">:</span>
        <span class="n">mk_decitab</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">decitab</span><span class="p">:</span> <span class="k">raise</span> <span class="n">UnavailableDecimation</span><span class="p">(</span><span class="s">&#39;ratio = </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">decitab</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="ctimegm"><a class="viewcode-back" href="../../util.html#pyrocko.util.ctimegm">[docs]</a><span class="k">def</span> <span class="nf">ctimegm</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Convert string representing UTC time to system time.</span>
<span class="sd">    </span>
<span class="sd">    :param s: string to be interpreted</span>
<span class="sd">    :param format: format string passed to :py:func:`strptime`</span>
<span class="sd">    </span>
<span class="sd">    :returns: system time stamp</span>
<span class="sd">        </span>
<span class="sd">    Interpretes string with format ``&#39;%Y-%m-%d %H:%M:%S&#39;``, using strptime.</span>
<span class="sd">    </span>
<span class="sd">    .. note::</span>
<span class="sd">       This function is to be replaced by :py:func:`str_to_time`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="gmctime"><a class="viewcode-back" href="../../util.html#pyrocko.util.gmctime">[docs]</a><span class="k">def</span> <span class="nf">gmctime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get string representation from system time, UTC.</span>
<span class="sd">    </span>
<span class="sd">    Produces string with format ``&#39;%Y-%m-%d %H:%M:%S&#39;``, using strftime.</span>
<span class="sd">  </span>
<span class="sd">    .. note::</span>
<span class="sd">       This function is to be repaced by :py:func:`time_to_str`.&#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
    </div>
<div class="viewcode-block" id="gmctime_v"><a class="viewcode-back" href="../../util.html#pyrocko.util.gmctime_v">[docs]</a><span class="k">def</span> <span class="nf">gmctime_v</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;%a, </span><span class="si">%d</span><span class="s"> %b %Y %H:%M:%S&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get string representation from system time, UTC. Same as </span>
<span class="sd">    :py:func:`gmctime` but with a more verbose default format.</span>
<span class="sd">    </span>
<span class="sd">    .. note::</span>
<span class="sd">       This function is to be replaced by :py:func:`time_to_str`.&#39;&#39;&#39;</span>
       
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="gmctime_fn"><a class="viewcode-back" href="../../util.html#pyrocko.util.gmctime_fn">[docs]</a><span class="k">def</span> <span class="nf">gmctime_fn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">_%H-%M-%S&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get string representation from system time, UTC. Same as</span>
<span class="sd">    :py:func:`gmctime` but with a default usable in filenames.</span>
<span class="sd">    </span>
<span class="sd">    .. note::</span>
<span class="sd">       This function is to be replaced by :py:func:`time_to_str`.&#39;&#39;&#39;</span>
       
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="FractionalSecondsMissing"><a class="viewcode-back" href="../../util.html#pyrocko.util.FractionalSecondsMissing">[docs]</a><span class="k">class</span> <span class="nc">FractionalSecondsMissing</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Exception raised by :py:func:`str_to_time` when the given string lacks</span>
<span class="sd">    fractional seconds.&#39;&#39;&#39;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="FractionalSecondsWrongNumberOfDigits"><a class="viewcode-back" href="../../util.html#pyrocko.util.FractionalSecondsWrongNumberOfDigits">[docs]</a><span class="k">class</span> <span class="nc">FractionalSecondsWrongNumberOfDigits</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Exception raised by :py:func:`str_to_time` when the given string has an incorrect number of digits in the fractional seconds part.&#39;&#39;&#39;</span>
    <span class="k">pass</span>
</div>
<span class="k">def</span> <span class="nf">_endswith_n</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">endings</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">endings</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ix</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

<div class="viewcode-block" id="str_to_time"><a class="viewcode-back" href="../../util.html#pyrocko.util.str_to_time">[docs]</a><span class="k">def</span> <span class="nf">str_to_time</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S.OPTFRAC&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Convert string representing UTC time to floating point system time.</span>
<span class="sd">    </span>
<span class="sd">    :param s: string representing UTC time</span>
<span class="sd">    :param format: time string format</span>
<span class="sd">    :returns: system time stamp as floating point value</span>
<span class="sd">    </span>
<span class="sd">    Uses the semantics of :py:func:`time.strptime` but allows for fractional seconds.</span>
<span class="sd">    If the format ends with ``&#39;.FRAC&#39;``, anything after a dot is interpreted as</span>
<span class="sd">    fractional seconds. If the format ends with ``&#39;.OPTFRAC&#39;``, the fractional part,</span>
<span class="sd">    including the dot is made optional. The latter has the consequence, that the time </span>
<span class="sd">    strings and the format may not contain any other dots. If the format ends</span>
<span class="sd">    with ``&#39;.xFRAC&#39;`` where x is 1, 2, or 3, it is ensured, that exactly that</span>
<span class="sd">    number of digits are present in the fractional seconds.</span>
<span class="sd">    &#39;&#39;&#39;</span>
        
    <span class="n">fracsec</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">fixed_endings</span> <span class="o">=</span> <span class="s">&#39;.FRAC&#39;</span><span class="p">,</span> <span class="s">&#39;.1FRAC&#39;</span><span class="p">,</span> <span class="s">&#39;.2FRAC&#39;</span><span class="p">,</span> <span class="s">&#39;.3FRAC&#39;</span>
    
    <span class="n">iend</span> <span class="o">=</span> <span class="n">_endswith_n</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">fixed_endings</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">iend</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">dotpos</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dotpos</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FractionalSecondsMissing</span><span class="p">(</span><span class="s">&#39;string=</span><span class="si">%s</span><span class="s">, format=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">format</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">iend</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">iend</span> <span class="o">!=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-</span><span class="n">dotpos</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">FractionalSecondsWrongNumberOfDigits</span><span class="p">(</span><span class="s">&#39;string=</span><span class="si">%s</span><span class="s">, format=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">format</span><span class="p">))</span>
        
        <span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">fixed_endings</span><span class="p">[</span><span class="n">iend</span><span class="p">])]</span>
        <span class="n">fracsec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">dotpos</span><span class="p">:])</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">dotpos</span><span class="p">]</span>
        
    <span class="k">elif</span> <span class="n">format</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.OPTFRAC&#39;</span><span class="p">):</span>
        <span class="n">dotpos</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="p">[:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dotpos</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">dotpos</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fracsec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">dotpos</span><span class="p">:])</span>
        
        <span class="k">if</span> <span class="n">dotpos</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">dotpos</span><span class="p">]</span>
      
    <span class="k">return</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">format</span><span class="p">))</span> <span class="o">+</span> <span class="n">fracsec</span>

</div>
<div class="viewcode-block" id="time_to_str"><a class="viewcode-back" href="../../util.html#pyrocko.util.time_to_str">[docs]</a><span class="k">def</span> <span class="nf">time_to_str</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S.3FRAC&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get string representation for floating point system time.</span>
<span class="sd">    </span>
<span class="sd">    :param t: floating point system time</span>
<span class="sd">    :param format: time string format</span>
<span class="sd">    :returns: string representing UTC time</span>
<span class="sd">    </span>
<span class="sd">    Uses the semantics of :py:func:`time.strftime` but additionally allows </span>
<span class="sd">    for fractional seconds. If *format* contains ``&#39;.xFRAC&#39;``, where ``x`` is a digit between 1 and 9, </span>
<span class="sd">    this is replaced with the fractional part of *t* with ``x`` digits precision.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">format</span> <span class="o">=</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">format</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;FRAC&#39;</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">re_frac</span><span class="p">:</span>
        <span class="n">GlobalVars</span><span class="o">.</span><span class="n">re_frac</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\.[1-9]FRAC&#39;</span><span class="p">)</span>
        <span class="n">GlobalVars</span><span class="o">.</span><span class="n">frac_formats</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span>  <span class="p">(</span><span class="s">&#39;.</span><span class="si">%s</span><span class="s">FRAC&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span> <span class="s">&#39;%.&#39;</span><span class="o">+</span><span class="n">x</span><span class="o">+</span><span class="s">&#39;f&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s">&#39;123456789&#39;</span> <span class="p">]</span> <span class="p">)</span>
    
    <span class="n">ts</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
    <span class="n">tfrac</span> <span class="o">=</span> <span class="n">t</span><span class="o">-</span><span class="n">ts</span>
    
    <span class="n">m</span> <span class="o">=</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">re_frac</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">format</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">sfrac</span> <span class="o">=</span> <span class="p">(</span><span class="n">GlobalVars</span><span class="o">.</span><span class="n">frac_formats</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">%</span> <span class="n">tfrac</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sfrac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;1&#39;</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">+=</span> <span class="mf">1.</span>
                        
        <span class="n">format</span><span class="p">,</span> <span class="n">nsub</span> <span class="o">=</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">re_frac</span><span class="o">.</span><span class="n">subn</span><span class="p">(</span><span class="n">sfrac</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">format</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
   
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
    </div>
<div class="viewcode-block" id="plural_s"><a class="viewcode-back" href="../../util.html#pyrocko.util.plural_s">[docs]</a><span class="k">def</span> <span class="nf">plural_s</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;s&#39;</span> 
</div>
<div class="viewcode-block" id="ensuredirs"><a class="viewcode-back" href="../../util.html#pyrocko.util.ensuredirs">[docs]</a><span class="k">def</span> <span class="nf">ensuredirs</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create all intermediate path components for a target path.</span>
<span class="sd">    </span>
<span class="sd">    :param dst: target path</span>
<span class="sd">    </span>
<span class="sd">    The leaf part of the target path is not created (use :py:func:`ensuredir` if</span>
<span class="sd">    a the target path is a directory to be created).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">d</span><span class="p">,</span><span class="n">x</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
    <span class="n">dirs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">d</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="n">dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">d</span><span class="p">,</span><span class="n">x</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        
    <span class="n">dirs</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ensuredir"><a class="viewcode-back" href="../../util.html#pyrocko.util.ensuredir">[docs]</a><span class="k">def</span> <span class="nf">ensuredir</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create directory and all intermediate path components to it as needed.</span>
<span class="sd">    </span>
<span class="sd">    :param dst: directory name</span>
<span class="sd">    </span>
<span class="sd">    Nothing is done if the given target already exists.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
        <span class="k">return</span>
        
    <span class="n">ensuredirs</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="reuse"><a class="viewcode-back" href="../../util.html#pyrocko.util.reuse">[docs]</a><span class="k">def</span> <span class="nf">reuse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get unique instance of an object.</span>
<span class="sd">    </span>
<span class="sd">    :param x: hashable object</span>
<span class="sd">    :returns: reference to x or an equivalent object</span>
<span class="sd">    </span>
<span class="sd">    Cache object *x* in a global dict for reuse, or if x already</span>
<span class="sd">    is in that dict, return a reference to it.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">grs</span> <span class="o">=</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">reuse_store</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grs</span><span class="p">:</span>
        <span class="n">grs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">grs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
    
    </div>
<div class="viewcode-block" id="Anon"><a class="viewcode-back" href="../../util.html#pyrocko.util.Anon">[docs]</a><span class="k">class</span> <span class="nc">Anon</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Dict-to-object utility.</span>

<span class="sd">    Any given arguments are stored as attributes.</span>

<span class="sd">    Example::</span>
<span class="sd">    </span>
<span class="sd">        a = Anon(x=1, y=2)</span>
<span class="sd">        print a.x, a.y</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="select_files"><a class="viewcode-back" href="../../util.html#pyrocko.util.select_files">[docs]</a><span class="k">def</span> <span class="nf">select_files</span><span class="p">(</span> <span class="n">paths</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>  <span class="n">regex</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="bp">True</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Recursively select files.</span>
<span class="sd">    </span>
<span class="sd">    :param paths: entry path names</span>
<span class="sd">    :param selector: callback for conditional inclusion</span>
<span class="sd">    :param regex: pattern for conditional inclusion</span>
<span class="sd">    :param show_progress: if True, indicate start and stop of processing</span>
<span class="sd">    :returns: list of path names</span>
<span class="sd">    </span>
<span class="sd">    Recursively finds all files under given entry points *paths*. If</span>
<span class="sd">    parameter *regex* is a regular expression, only files with matching path names</span>
<span class="sd">    are included. If additionally parameter *selector*</span>
<span class="sd">    is given a callback function, only files for which the callback returns </span>
<span class="sd">    ``True`` are included. The callback should take a single argument. The callback</span>
<span class="sd">    is called with a single argument, an object, having as attributes, any named</span>
<span class="sd">    groups given in *regex*.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    </span>
<span class="sd">    To find all files ending in ``&#39;.mseed&#39;`` or ``&#39;.msd&#39;``::</span>
<span class="sd">    </span>
<span class="sd">        select_files(paths,</span>
<span class="sd">            regex=r&#39;\.(mseed|msd)$&#39;)</span>
<span class="sd">        </span>
<span class="sd">    To find all files ending with ``&#39;$Year.$DayOfYear&#39;``, having set 2009 for </span>
<span class="sd">    the year::</span>
<span class="sd">    </span>
<span class="sd">        select_files(paths, </span>
<span class="sd">            regex=r&#39;(?P&lt;year&gt;\d\d\d\d)\.(?P&lt;doy&gt;\d\d\d)$&#39;, </span>
<span class="sd">            selector=(lambda x: int(x.year) == 2009))</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
        <span class="n">progress_beg</span><span class="p">(</span><span class="s">&#39;selecting files...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="n">good</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">regex</span><span class="p">:</span> <span class="n">rselector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">addfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">regex</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;looking at filename: &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span> 
            <span class="n">m</span> <span class="o">=</span> <span class="n">rselector</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">infos</span> <span class="o">=</span> <span class="n">Anon</span><span class="p">(</span><span class="o">**</span><span class="n">m</span><span class="o">.</span><span class="n">groupdict</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;   regex &#39;</span><span class="si">%s</span><span class="s">&#39; matches.&quot;</span> <span class="o">%</span> <span class="n">regex</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;      attribute &#39;</span><span class="si">%s</span><span class="s">&#39; has value &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">selector</span><span class="p">(</span><span class="n">infos</span><span class="p">):</span>
                    <span class="n">good</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;   regex &#39;</span><span class="si">%s</span><span class="s">&#39; does not match.&quot;</span> <span class="o">%</span> <span class="n">regex</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">good</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span> <span class="n">paths</span> <span class="p">]</span>

    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                    <span class="n">addfile</span><span class="p">(</span><span class="n">pjoin</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">addfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
   
    <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>    
        <span class="n">progress_end</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%i</span><span class="s"> file</span><span class="si">%s</span><span class="s"> selected.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span> <span class="n">good</span><span class="p">),</span> <span class="n">plural_s</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="p">))))</span>
    
    <span class="k">return</span> <span class="n">good</span>

    
</div>
<div class="viewcode-block" id="base36encode"><a class="viewcode-back" href="../../util.html#pyrocko.util.base36encode">[docs]</a><span class="k">def</span> <span class="nf">base36encode</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">alphabet</span><span class="o">=</span><span class="s">&#39;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Convert positive integer to a base36 string.&#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;number must be an integer&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">number</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;number must be positive&#39;</span><span class="p">)</span>
 
    <span class="c"># Special case for small numbers</span>
    <span class="k">if</span> <span class="n">number</span> <span class="o">&lt;</span> <span class="mi">36</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">alphabet</span><span class="p">[</span><span class="n">number</span><span class="p">]</span>
 
    <span class="n">base36</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">while</span> <span class="n">number</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">number</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="mi">36</span><span class="p">)</span>
        <span class="n">base36</span> <span class="o">=</span> <span class="n">alphabet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">base36</span>
 
    <span class="k">return</span> <span class="n">base36</span>
 </div>
<div class="viewcode-block" id="base36decode"><a class="viewcode-back" href="../../util.html#pyrocko.util.base36decode">[docs]</a><span class="k">def</span> <span class="nf">base36decode</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Decode base36 endcoded positive integer.&#39;&#39;&#39;</span>
    
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">,</span><span class="mi">36</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="UnpackError"><a class="viewcode-back" href="../../util.html#pyrocko.util.UnpackError">[docs]</a><span class="k">class</span> <span class="nc">UnpackError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Exception raised when :py:func:`unpack_fixed` encounters an error.&#39;&#39;&#39;</span>
    
    <span class="k">pass</span>
</div>
<span class="n">ruler</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="s">&#39;</span><span class="si">%-10i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="p">])</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="s">&#39;0123456789&#39;</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>


<div class="viewcode-block" id="unpack_fixed"><a class="viewcode-back" href="../../util.html#pyrocko.util.unpack_fixed">[docs]</a><span class="k">def</span> <span class="nf">unpack_fixed</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Unpack fixed format string, as produced by many fortran codes.</span>
<span class="sd">    </span>
<span class="sd">    :param format: format specification</span>
<span class="sd">    :param line: string to be processed</span>
<span class="sd">    :param callargs: callbacks for callback fields in the format</span>
<span class="sd">    </span>
<span class="sd">    The format is described by a string of comma-separated fields. Each field</span>
<span class="sd">    is defined by a character for the field type followed by the field width. A </span>
<span class="sd">    questionmark</span>
<span class="sd">    may be appended to the field description to allow the argument to be optional </span>
<span class="sd">    (The data string is then allowed to be filled with blanks and ``None`` is </span>
<span class="sd">    returned in this case).</span>
<span class="sd">    </span>
<span class="sd">    The following field types are available:</span>
<span class="sd">     </span>
<span class="sd">    ====  ================================================================</span>
<span class="sd">    Type  Description</span>
<span class="sd">    ====  ================================================================</span>
<span class="sd">    A     string (full field width is extracted)</span>
<span class="sd">    a     string (whitespace at the beginning and the end is removed)</span>
<span class="sd">    i     integer value</span>
<span class="sd">    f     floating point value</span>
<span class="sd">    @     special type, a callback must be given for the conversion</span>
<span class="sd">    x     special field type to skip parts of the string</span>
<span class="sd">    ====  ================================================================</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">ipos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">icall</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">form</span> <span class="ow">in</span> <span class="n">format</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
        <span class="n">optional</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;?&#39;</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">ipos</span><span class="p">:</span><span class="n">ipos</span><span class="o">+</span><span class="n">l</span><span class="p">]</span>
        <span class="n">cast</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;x&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;A&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s">&#39;i&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s">&#39;@&#39;</span><span class="p">:</span> <span class="s">&#39;extra&#39;</span><span class="p">}[</span><span class="n">typ</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cast</span> <span class="o">==</span> <span class="s">&#39;extra&#39;</span><span class="p">:</span>
            <span class="n">cast</span> <span class="o">=</span> <span class="n">callargs</span><span class="p">[</span><span class="n">icall</span><span class="p">]</span>
            <span class="n">icall</span> <span class="o">+=</span><span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">cast</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">optional</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">mark</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; &#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">80</span> 
                    <span class="n">mark</span><span class="p">[</span><span class="n">ipos</span><span class="p">:</span><span class="n">ipos</span><span class="o">+</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;^&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">l</span>
                    <span class="n">mark</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mark</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">UnpackError</span><span class="p">(</span><span class="s">&#39;Invalid cast to type &quot;</span><span class="si">%s</span><span class="s">&quot; at position [</span><span class="si">%i</span><span class="s">:</span><span class="si">%i</span><span class="s">] of line: </span><span class="se">\n</span><span class="si">%s%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">ipos</span><span class="p">,</span> <span class="n">ipos</span><span class="o">+</span><span class="n">l</span><span class="p">,</span> <span class="n">ruler</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="n">mark</span><span class="p">))</span>
                
        <span class="n">ipos</span> <span class="o">+=</span> <span class="n">l</span>
    
    <span class="k">return</span> <span class="n">values</span>

</div>
<span class="n">_pattern_cache</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">def</span> <span class="nf">_nslc_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_pattern_cache</span><span class="p">:</span>
        <span class="n">rpattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">pattern</span><span class="p">),</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
        <span class="n">_pattern_cache</span><span class="p">[</span><span class="n">pattern</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpattern</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rpattern</span> <span class="o">=</span> <span class="n">_pattern_cache</span><span class="p">[</span><span class="n">pattern</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">rpattern</span>

<div class="viewcode-block" id="match_nslc"><a class="viewcode-back" href="../../util.html#pyrocko.util.match_nslc">[docs]</a><span class="k">def</span> <span class="nf">match_nslc</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="n">nslc</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Match network-station-location-channel code against pattern or list of patterns.</span>
<span class="sd">    </span>
<span class="sd">    :param patterns: pattern or list of patterns</span>
<span class="sd">    :param nslc: tuple with (network, station, location, channel) as strings</span>

<span class="sd">    :returns: ``True`` if the pattern matches or if any of the given patterns match; or ``False``.</span>

<span class="sd">    The patterns may contain shell-style wildcards: \*, ?, [seq], [!seq].</span>

<span class="sd">    Example::</span>

<span class="sd">        match_nslc(&#39;*.HAM3.*.BH?&#39;, (&#39;GR&#39;,&#39;HAM3&#39;,&#39;&#39;,&#39;BHZ&#39;))   # -&gt; True        </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span> <span class="n">patterns</span> <span class="p">]</span>
    
    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nslc</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_nslc_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="match_nslcs"><a class="viewcode-back" href="../../util.html#pyrocko.util.match_nslcs">[docs]</a><span class="k">def</span> <span class="nf">match_nslcs</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="n">nslcs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get network-station-location-channel codes that match given pattern or any of several given patterns.</span>

<span class="sd">    :param patterns: pattern or list of patterns</span>
<span class="sd">    :param nslcs: list of (network, station, location, channel) tuples</span>

<span class="sd">    See also :py:func:`match_nslc`</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">matching</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nslc</span> <span class="ow">in</span> <span class="n">nslcs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">match_nslc</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="n">nslc</span><span class="p">):</span> 
            <span class="n">matching</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nslc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">matching</span>
</div>
<div class="viewcode-block" id="SoleError"><a class="viewcode-back" href="../../util.html#pyrocko.util.SoleError">[docs]</a><span class="k">class</span> <span class="nc">SoleError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Exception raised by objects of type :py:class:`Sole`, when an concurrent instance is running.&#39;&#39;&#39;</span>

    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Sole"><a class="viewcode-back" href="../../util.html#pyrocko.util.Sole">[docs]</a><span class="k">class</span> <span class="nc">Sole</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   
    <span class="sd">&#39;&#39;&#39;Use POSIX advisory file locking to ensure that only a single instance of a program is running.</span>
<span class="sd">    </span>
<span class="sd">    :param pid_path: path to lockfile to be used</span>

<span class="sd">    Usage::</span>

<span class="sd">        from pyrocko.util import Sole, SoleError, setup_logging</span>
<span class="sd">        import os</span>
<span class="sd">        </span>
<span class="sd">        setup_logging(&#39;my_program&#39;)</span>

<span class="sd">        pid_path =  os.path.join(os.environ[&#39;HOME&#39;], &#39;.my_program_lock&#39;)</span>
<span class="sd">        try:</span>
<span class="sd">            sole = Sole(pid_path)</span>

<span class="sd">        except SoleError, e:</span>
<span class="sd">            logger.fatal( str(e) )</span>
<span class="sd">            sys.exit(1)</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pid_path</span> <span class="o">=</span> <span class="n">pid_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_other_running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">ensuredirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SoleError</span><span class="p">(</span><span class="s">&#39;Cannot open lockfile (path = </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid_path</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="o">.</span><span class="n">lockf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_NB</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_other_running</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid_path</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="s">&#39;?&#39;</span>

            <span class="k">raise</span> <span class="n">SoleError</span><span class="p">(</span><span class="s">&#39;Other instance is running (pid = </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">pid</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">ftruncate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%i</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
            <span class="n">os</span><span class="o">.</span><span class="n">fsync</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># the pid is only stored for user information, so this is allowed to fail</span>
            
    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_other_running</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">fcntl</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">fcntl</span><span class="o">.</span><span class="n">lockf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid_path</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

</div>
<span class="n">re_escapequotes</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;([&#39;</span><span class="se">\\</span><span class="s">])&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="escapequotes"><a class="viewcode-back" href="../../util.html#pyrocko.util.escapequotes">[docs]</a><span class="k">def</span> <span class="nf">escapequotes</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">re_escapequotes</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&quot;</span><span class="se">\\</span><span class="s">\1&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TableWriter"><a class="viewcode-back" href="../../util.html#pyrocko.util.TableWriter">[docs]</a><span class="k">class</span> <span class="nc">TableWriter</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Write table of space separated values to a file.</span>

<span class="sd">    :param f: file like object</span>

<span class="sd">    Strings containing spaces are quoted on output.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="n">f</span>

<div class="viewcode-block" id="TableWriter.writerow"><a class="viewcode-back" href="../../util.html#pyrocko.util.TableWriter.writerow">[docs]</a>    <span class="k">def</span> <span class="nf">writerow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">minfieldwidths</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write one row of values to underlying file.</span>
<span class="sd">        </span>
<span class="sd">        :param row: iterable of values</span>
<span class="sd">        :param minfieldwidths: minimum field widths for the values</span>

<span class="sd">        Each value in in `row` is converted to a string and optionally padded with blanks. The resulting</span>
<span class="sd">        strings are output separated with blanks. If any values given are strings and if they contain whitespace,</span>
<span class="sd">        they are quoted with single quotes, and any internal single quotes are backslash-escaped.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">minfieldwidths</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">minfieldwidths</span><span class="p">):</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">minfieldwidths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&quot;\s|&#39;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">escapequotes</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="TableReader"><a class="viewcode-back" href="../../util.html#pyrocko.util.TableReader">[docs]</a><span class="k">class</span> <span class="nc">TableReader</span><span class="p">:</span>
    
    <span class="sd">&#39;&#39;&#39;Read table of space separated values from a file.</span>
<span class="sd">    </span>
<span class="sd">    :param f: file-like object</span>

<span class="sd">    This uses Pythons shlex module to tokenize lines. Should deal correctly with quoted strings.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eof</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="TableReader.readrow"><a class="viewcode-back" href="../../util.html#pyrocko.util.TableReader.readrow">[docs]</a>    <span class="k">def</span> <span class="nf">readrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Read one row from the underlying file, tokenize it with shlex.</span>
<span class="sd">        </span>
<span class="sd">        :returns: tokenized line as a list of strings.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eof</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">shlex</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">posix</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">whitespace_split</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">s</span><span class="o">.</span><span class="n">whitespace</span> <span class="o">=</span> <span class="s">&#39; </span><span class="se">\t\n\r\f\v</span><span class="s">&#39;</span> <span class="c"># compatible with re&#39;s \s</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">row</span>
</div></div>
<div class="viewcode-block" id="gform"><a class="viewcode-back" href="../../util.html#pyrocko.util.gform">[docs]</a><span class="k">def</span> <span class="nf">gform</span><span class="p">(</span> <span class="n">number</span><span class="p">,</span> <span class="n">significant_digits</span><span class="o">=</span><span class="mi">3</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Pretty print floating point numbers.</span>
<span class="sd">    </span>
<span class="sd">    Align floating point numbers at the decimal dot.</span>
<span class="sd">    </span>
<span class="sd">    ::</span>

<span class="sd">      |  -d.dde+xxx|</span>
<span class="sd">      |  -d.dde+xx |</span>
<span class="sd">      |-ddd.       |</span>
<span class="sd">      | -dd.d      |</span>
<span class="sd">      |  -d.dd     |</span>
<span class="sd">      |  -0.ddd    |</span>
<span class="sd">      |  -0.0ddd   |</span>
<span class="sd">      |  -0.00ddd  |</span>
<span class="sd">      |  -d.dde-xx |</span>
<span class="sd">      |  -d.dde-xxx|</span>
<span class="sd">    &#39;&#39;&#39;</span> 
    
    <span class="n">no_exp_range</span> <span class="o">=</span> <span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> 
                    <span class="nb">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span><span class="n">significant_digits</span><span class="p">))</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">significant_digits</span><span class="o">+</span><span class="n">significant_digits</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">5</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">no_exp_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">no_exp_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="n">number</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%#.*g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">significant_digits</span><span class="p">,</span> <span class="n">number</span><span class="p">))</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;0&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%.*E</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">significant_digits</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">significant_digits</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>
</pre></div></div>

          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Pyrocko v0.3 Manual</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2012, Sebastian Heimann. <img src="http://kinherd.org/pyrocko.png" width="5" height="5">
    </div>
  </body>
</html>