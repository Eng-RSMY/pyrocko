
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Programming Examples &#8212; Pyrocko v0.3 Manual</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Pyrocko v0.3 Manual"
          href="_static/opensearch.xml"/>
    <link rel="top" title="Pyrocko v0.3 Manual" href="index.html" />
    <link rel="next" title="Library Reference" href="reference.html" />
    <link rel="prev" title="Fomosto Tutorial" href="fomosto.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="reference.html" title="Library Reference"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="fomosto.html" title="Fomosto Tutorial"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Pyrocko v0.3 Manual</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="programming-examples">
<h1>Programming Examples<a class="headerlink" href="#programming-examples" title="Permalink to this headline">¶</a></h1>
<div class="section" id="load-filter-save">
<h2>Load, filter, save<a class="headerlink" href="#load-filter-save" title="Permalink to this headline">¶</a></h2>
<p>Read a test file <a class="reference external" href="_static/test.mseed">test.mseed</a>, containing a three component seismogram, apply Butterworth lowpass filter to the seismograms and dump the results to a new file.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">io</span>

<span class="n">traces</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;test.mseed&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
    <span class="n">tr</span><span class="o">.</span><span class="n">lowpass</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>   <span class="c1"># 4th order, 0.02 Hz</span>

<span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="s1">&#39;filtered.mseed&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="quickly-look-at-a-trace">
<h2>Quickly look at a trace<a class="headerlink" href="#quickly-look-at-a-trace" title="Permalink to this headline">¶</a></h2>
<p>To visualize a single trace, use the <a class="reference internal" href="trace.html#pyrocko.trace.Trace.snuffle" title="pyrocko.trace.Trace.snuffle"><code class="xref py py-meth docutils literal"><span class="pre">pyrocko.trace.Trace.snuffle()</span></code></a> method. To look at a list of traces, use the <a class="reference internal" href="trace.html#pyrocko.trace.snuffle" title="pyrocko.trace.snuffle"><code class="xref py py-func docutils literal"><span class="pre">pyrocko.trace.snuffle()</span></code></a> function. If you want to see the contents of a pile, the <a class="reference internal" href="pile.html#pyrocko.pile.Pile.snuffle" title="pyrocko.pile.Pile.snuffle"><code class="xref py py-meth docutils literal"><span class="pre">pyrocko.pile.Pile.snuffle()</span></code></a> method is your friend. Alternatively, you could of course save the traces to file and use the standalone Snuffler to look at them.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">io</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">pile</span>

<span class="n">traces</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;test.mseed&#39;</span><span class="p">)</span>
<span class="n">traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">snuffle</span><span class="p">()</span> <span class="c1"># look at a single trace</span>
<span class="n">trace</span><span class="o">.</span><span class="n">snuffle</span><span class="p">(</span><span class="n">traces</span><span class="p">)</span> <span class="c1"># look at a bunch of traces</span>

<span class="c1"># do something with the traces:</span>
<span class="n">new_traces</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">new</span><span class="o">.</span><span class="n">whiten</span><span class="p">()</span>
    <span class="c1"># to allow the viewer to distinguish the traces</span>
    <span class="n">new</span><span class="o">.</span><span class="n">set_location</span><span class="p">(</span><span class="s1">&#39;whitened&#39;</span><span class="p">)</span>
    <span class="n">new_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>

<span class="n">trace</span><span class="o">.</span><span class="n">snuffle</span><span class="p">(</span><span class="n">traces</span> <span class="o">+</span> <span class="n">new_traces</span><span class="p">)</span>

<span class="c1"># it is also possible to &#39;snuffle&#39; a pile:</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">pile</span><span class="o">.</span><span class="n">make_pile</span><span class="p">([</span><span class="s1">&#39;test.mseed&#39;</span><span class="p">])</span>
<span class="n">p</span><span class="o">.</span><span class="n">snuffle</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="create-a-trace-object-from-scratch">
<h2>Create a trace object from scratch<a class="headerlink" href="#create-a-trace-object-from-scratch" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">trace</span><span class="p">,</span> <span class="n">util</span><span class="p">,</span> <span class="n">io</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">num</span>

<span class="n">nsamples</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">tmin</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">str_to_time</span><span class="p">(</span><span class="s1">&#39;2010-02-20 15:15:30.100&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">nsamples</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="s1">&#39;TEST&#39;</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="n">deltat</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="s1">&#39;TEST&#39;</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="n">deltat</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">([</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">],</span> <span class="s1">&#39;my_precious_traces.mseed&#39;</span><span class="p">)</span>            <span class="c1"># all traces in one file</span>
<span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">([</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">],</span> <span class="s1">&#39;my_precious_trace_</span><span class="si">%(channel)s</span><span class="s1">.mseed&#39;</span><span class="p">)</span> <span class="c1"># each file one channel</span>
</pre></div>
</div>
</div>
<div class="section" id="extracting-part-of-a-trace">
<h2>Extracting part of a trace<a class="headerlink" href="#extracting-part-of-a-trace" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">io</span>

<span class="n">traces</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;test.mseed&#39;</span><span class="p">))</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span> <span class="s1">&#39;original:&#39;</span><span class="p">,</span> <span class="n">t</span>

<span class="c1"># extract a copy of a part of t</span>
<span class="n">extracted</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span> <span class="s1">&#39;extracted:&#39;</span><span class="p">,</span> <span class="n">extracted</span>

<span class="c1"># in-place operation modifies t itself</span>
<span class="n">t</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">tmin</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">tmax</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span> <span class="s1">&#39;modified:&#39;</span><span class="p">,</span> <span class="n">t</span>
</pre></div>
</div>
</div>
<div class="section" id="reorganizing-a-dataset-into-hour-files">
<h2>Reorganizing a dataset into hour-files<a class="headerlink" href="#reorganizing-a-dataset-into-hour-files" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">pile</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">calendar</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">pile</span><span class="o">.</span><span class="n">make_pile</span><span class="p">([</span><span class="s1">&#39;test.mseed&#39;</span><span class="p">])</span>  <span class="c1"># could give directories or thousands of filenames here</span>

<span class="c1"># get timestamp for full hour before first data sample in all selected traces</span>
<span class="n">tmin</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">tmin</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span>

<span class="c1"># iterate over the data, with a window length of one hour</span>
<span class="k">for</span> <span class="n">traces</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">chopper</span><span class="p">(</span><span class="n">tmin</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tinc</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">traces</span><span class="p">:</span>    <span class="c1"># the list could be empty due to gaps</span>
        <span class="n">window_start</span> <span class="o">=</span> <span class="n">traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">wmin</span>
        <span class="n">timestring</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="n">window_start</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H&#39;</span><span class="p">)</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="s1">&#39;test_hourfiles/hourfile-</span><span class="si">%s</span><span class="s1">.mseed&#39;</span> <span class="o">%</span> <span class="n">timestring</span>
        <span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>in each iteration we get all data for the current time window as a list of traces</li>
<li>the traces emitted by <a class="reference internal" href="pile.html#pyrocko.pile.Pile.chopper" title="pyrocko.pile.Pile.chopper"><code class="xref py py-meth docutils literal"><span class="pre">pyrocko.pile.Pile.chopper()</span></code></a> &#8216;know&#8217; the time window to which
they belong; it is stored in the attributes <code class="docutils literal"><span class="pre">trace.wmin</span></code> and <code class="docutils literal"><span class="pre">trace.wmax</span></code>.
note: <code class="docutils literal"><span class="pre">trace.tmin</span></code> (its onset) does not have to be identical to <code class="docutils literal"><span class="pre">trace.wmin</span></code></li>
<li>directory parts in the output path will be created as neccessary</li>
<li>when applying this procedure to a dataset consisting of arbitrarily separated files, it will automatically connect adjacent traces as needed!</li>
</ul>
</div>
<div class="section" id="downsampling-a-whole-dataset">
<h2>Downsampling a whole dataset<a class="headerlink" href="#downsampling-a-whole-dataset" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">pile</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">calendar</span>

<span class="c1"># when pile.make_pile() is called without any arguments, the command line</span>
<span class="c1"># parameters given to the script are searched for waveform files and directories</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">pile</span><span class="o">.</span><span class="n">make_pile</span><span class="p">()</span>

<span class="c1"># get timestamp for full hour before first data sample in all selected traces</span>
<span class="n">tmin</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">tmin</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span>

<span class="n">tinc</span> <span class="o">=</span> <span class="mf">3600.</span>
<span class="n">tpad</span> <span class="o">=</span> <span class="mf">10.</span>
<span class="n">target_deltat</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="c1"># iterate over the data, with a window length of one hour and 2x10 seconds of</span>
<span class="c1"># overlap</span>
<span class="k">for</span> <span class="n">traces</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">chopper</span><span class="p">(</span><span class="n">tmin</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tinc</span><span class="o">=</span><span class="n">tinc</span><span class="p">,</span> <span class="n">tpad</span><span class="o">=</span><span class="n">tpad</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">traces</span><span class="p">:</span> <span class="c1"># the list could be empty due to gaps</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">downsample_to</span><span class="p">(</span><span class="n">target_deltat</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">demean</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># remove overlapping</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">wmin</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">wmax</span><span class="p">)</span>

        <span class="n">window_start</span> <span class="o">=</span> <span class="n">traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">wmin</span>
        <span class="n">timestring</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="n">window_start</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H&#39;</span><span class="p">)</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="s1">&#39;downsampled/</span><span class="si">%(station)s</span><span class="s1">_</span><span class="si">%(channel)s</span><span class="s1">_</span><span class="si">%(mytimestring)s</span><span class="s1">.mseed&#39;</span>
        <span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">additional</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;mytimestring&#39;</span><span class="p">:</span> <span class="n">timestring</span><span class="p">})</span>


<span class="c1"># now look at the result with</span>
<span class="c1">#   &gt; snuffler downsampled/</span>
</pre></div>
</div>
</div>
<div class="section" id="convert-sac-to-miniseed">
<h2>Convert SAC to MiniSEED<a class="headerlink" href="#convert-sac-to-miniseed" title="Permalink to this headline">¶</a></h2>
<p>A very basic SAC to MiniSEED converter:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">io</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="n">traces</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;sac&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.sac&#39;</span><span class="p">):</span>
        <span class="n">out_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.mseed&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.mseed&#39;</span>

    <span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="convert-miniseed-to-ascii">
<h2>Convert MiniSEED to ASCII<a class="headerlink" href="#convert-miniseed-to-ascii" title="Permalink to this headline">¶</a></h2>
<p>An inefficient, non-portable, non-header-preserving, but simple, method to convert some MiniSEED traces to ASCII tables:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">io</span>

<span class="n">traces</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;test.mseed&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">traces</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test-</span><span class="si">%i</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="n">it</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">tim</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;</span><span class="si">%20f</span><span class="s1"> </span><span class="si">%20g</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tim</span><span class="p">,</span><span class="n">val</span><span class="p">)</span> <span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="restitute-traces-to-displacement-using-poles-and-zeros">
<h2>Restitute traces to displacement using poles and zeros<a class="headerlink" href="#restitute-traces-to-displacement-using-poles-and-zeros" title="Permalink to this headline">¶</a></h2>
<p>Often we want to deconvolve instrument responses from seismograms. The method
<a class="reference internal" href="trace.html#pyrocko.trace.Trace.transfer" title="pyrocko.trace.Trace.transfer"><code class="xref py py-meth docutils literal"><span class="pre">pyrocko.trace.Trace.transfer()</span></code></a> implements a convolution with a
transfer function in the frequency domain. This method takes as argument a
transfer function object which &#8216;knows&#8217; how to compute values of the transfer
function at given frequencies. The trace module provides a few different
transfer functions, but it is also possible to write a custom transfer
function. For a transfer function given as poles and zeros, we can use
instances of the class <a class="reference internal" href="trace.html#pyrocko.trace.PoleZeroResponse" title="pyrocko.trace.PoleZeroResponse"><code class="xref py py-class docutils literal"><span class="pre">pyrocko.trace.PoleZeroResponse</span></code></a>. There is
also a class <code class="xref py py-class docutils literal"><span class="pre">InverseEvalrespResponse</span></code>, which uses the common <code class="docutils literal"><span class="pre">RESP</span></code> files
through the <code class="docutils literal"><span class="pre">evalresp</span></code> library.</p>
<p>Here is a complete example using a SAC pole-zero file
(<a class="reference external" href="_static/STS2-Generic.polezero.txt">STS2-Generic.polezero.txt</a>) to
deconvolve the transfer function from an example seismogram:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">pz</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">trace</span>

<span class="c1"># read poles and zeros from SAC format pole-zero file</span>
<span class="n">zeros</span><span class="p">,</span> <span class="n">poles</span><span class="p">,</span> <span class="n">constant</span> <span class="o">=</span> <span class="n">pz</span><span class="o">.</span><span class="n">read_sac_zpk</span><span class="p">(</span><span class="s1">&#39;STS2-Generic.polezero.txt&#39;</span><span class="p">)</span>

<span class="n">zeros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="n">j</span><span class="p">)</span>  <span class="c1"># one more for displacement</span>

<span class="c1"># create pole-zero response function object for restitution, so poles and zeros</span>
<span class="c1"># from the response file are swapped here.</span>
<span class="n">rest_sts2</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">PoleZeroResponse</span><span class="p">(</span><span class="n">poles</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">constant</span><span class="p">)</span>

<span class="n">traces</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;test.mseed&#39;</span><span class="p">)</span>
<span class="n">out_traces</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>

    <span class="n">displacement</span> <span class="o">=</span>  <span class="n">trace</span><span class="o">.</span><span class="n">transfer</span><span class="p">(</span>
        <span class="mf">1000.</span><span class="p">,</span>                       <span class="c1"># rise and fall of time domain taper in [s]</span>
        <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">),</span>     <span class="c1"># frequency domain taper in [Hz]</span>
        <span class="n">transfer_function</span><span class="o">=</span><span class="n">rest_sts2</span><span class="p">)</span>

    <span class="c1"># change channel id, so we can distinguish the traces in a trace viewer.</span>
    <span class="n">displacement</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="o">+</span><span class="n">trace</span><span class="o">.</span><span class="n">channel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">out_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">displacement</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_traces</span><span class="p">,</span> <span class="s1">&#39;displacement.mseed&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="distance-between-two-points">
<h2>Distance between two points<a class="headerlink" href="#distance-between-two-points" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">orthodrome</span><span class="p">,</span> <span class="n">model</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mf">20.</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Station</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="mf">15.</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mf">120.</span><span class="p">)</span>

<span class="c1"># one possibility:</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">orthodrome</span><span class="o">.</span><span class="n">distance_accurate50m</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
<span class="nb">print</span> <span class="s1">&#39;Distance between e and s is </span><span class="si">%g</span><span class="s1"> km&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)</span>

<span class="c1"># another possibility:</span>
<span class="n">s</span><span class="o">.</span><span class="n">set_event_relative_data</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="nb">print</span> <span class="s1">&#39;Distance between e and s is </span><span class="si">%g</span><span class="s1"> km&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">dist_m</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="convert-a-dataset-from-mini-seed-to-sac-format">
<h2>Convert a dataset from Mini-SEED to SAC format<a class="headerlink" href="#convert-a-dataset-from-mini-seed-to-sac-format" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">pile</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">util</span><span class="p">,</span> <span class="n">model</span>

<span class="n">dinput</span> <span class="o">=</span> <span class="s1">&#39;data/mseed&#39;</span>
<span class="n">doutput</span> <span class="o">=</span> <span class="s1">&#39;data/sac/</span><span class="si">%(dirhz)s</span><span class="s1">/</span><span class="si">%(station)s</span><span class="s1">/</span><span class="si">%(station)s</span><span class="s1">_</span><span class="si">%(channel)s</span><span class="s1">_</span><span class="si">%(tmin)s</span><span class="s1">.sac&#39;</span>
<span class="n">fn_stations</span> <span class="o">=</span> <span class="s1">&#39;meta/stations.txt&#39;</span>

<span class="n">stations_list</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">load_stations</span><span class="p">(</span><span class="n">fn_stations</span><span class="p">)</span>

<span class="n">stations</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stations_list</span><span class="p">:</span>
    <span class="n">stations</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">location</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
    <span class="n">s</span><span class="o">.</span><span class="n">set_channels_by_name</span><span class="p">(</span><span class="o">*</span><span class="s1">&#39;BHN BHE BHZ BLN BLE BLZ&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">pile</span><span class="o">.</span><span class="n">make_pile</span><span class="p">(</span><span class="n">dinput</span><span class="p">,</span> <span class="n">cachedirname</span><span class="o">=</span><span class="s1">&#39;/tmp/snuffle_cache_u254023&#39;</span><span class="p">)</span>
<span class="n">h</span> <span class="o">=</span> <span class="mf">3600.</span>
<span class="n">tinc</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">h</span>
<span class="n">tmin</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">day_start</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>
<span class="k">for</span> <span class="n">traces</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">chopper_grouped</span><span class="p">(</span><span class="n">tmin</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tinc</span><span class="o">=</span><span class="n">tinc</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tr</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
        <span class="n">dirhz</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">hz&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">tr</span><span class="o">.</span><span class="n">deltat</span><span class="p">))</span>
        <span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">([</span><span class="n">tr</span><span class="p">],</span> <span class="n">doutput</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;sac&#39;</span><span class="p">,</span> <span class="n">additional</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dirhz&#39;</span><span class="p">:</span> <span class="n">dirhz</span><span class="p">},</span> <span class="n">stations</span><span class="o">=</span><span class="n">stations</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="misfit-of-one-trace-against-two-other-traces">
<h2>Misfit of one trace against two other traces<a class="headerlink" href="#misfit-of-one-trace-against-two-other-traces" title="Permalink to this headline">¶</a></h2>
<p>Three traces will be created. One of these traces will be assumed to be the reference trace (rt) that we want to know the misfit of in comparison to two other traces (tt1 and tt2). The traces rt and tt1 will be provided with the same random y-data. Hence, their misfit will be zero, in the end.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">trace</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">sqrt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">num</span>

<span class="c1"># Let&#39;s create three traces: One trace as the reference (rt) and two as test</span>
<span class="c1"># traces (tt1 and tt2):</span>
<span class="n">ydata1</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">ydata2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">rt</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="s1">&#39;REF&#39;</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">ydata1</span><span class="p">)</span>
<span class="n">candidate1</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="s1">&#39;TT1&#39;</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">ydata1</span><span class="p">)</span>
<span class="n">candidate2</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="s1">&#39;TT2&#39;</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">ydata2</span><span class="p">)</span>

<span class="c1"># Define a fader to apply before fft.</span>
<span class="n">taper</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">CosFader</span><span class="p">(</span><span class="n">xfade</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Define a frequency response to apply before performing the inverse fft.</span>
<span class="c1"># This can be basically any funtion, as long as it contains a function called</span>
<span class="c1"># *evaluate*, which evaluates the frequency response function at a given list</span>
<span class="c1"># of frequencies.</span>
<span class="c1"># Please refer to the :py:class:`FrequencyResponse` class or its subclasses for</span>
<span class="c1"># examples.</span>
<span class="c1"># However, we are going to use a butterworth low-pass filter in this example.</span>
<span class="n">bw_filter</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">ButterworthResponse</span><span class="p">(</span><span class="n">corner</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                      <span class="n">order</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                      <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">)</span>

<span class="c1"># Combine all information in one misfit setup:</span>
<span class="n">setup</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">MisfitSetup</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;An Example Setup&#39;</span><span class="p">,</span>
                          <span class="n">norm</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">taper</span><span class="o">=</span><span class="n">taper</span><span class="p">,</span>
                          <span class="nb">filter</span><span class="o">=</span><span class="n">bw_filter</span><span class="p">,</span>
                          <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;time_domain&#39;</span><span class="p">)</span>

<span class="c1"># Calculate misfits of each candidate against the reference trace:</span>
<span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="p">[</span><span class="n">candidate1</span><span class="p">,</span> <span class="n">candidate2</span><span class="p">]:</span>
    <span class="n">misfit</span> <span class="o">=</span> <span class="n">rt</span><span class="o">.</span><span class="n">misfit</span><span class="p">(</span><span class="n">candidate</span><span class="o">=</span><span class="n">candidate</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="n">setup</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s1">&#39;misfit: </span><span class="si">%s</span><span class="s1">, normalization: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">misfit</span>

<span class="c1"># Finally, dump the misfit setup that has been used as a yaml file for later</span>
<span class="c1"># re-use:</span>
<span class="n">setup</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;my_misfit_setup.txt&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If we wanted to reload our misfit setup, guts provides the iload_all() method for
that purpose:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko.guts</span> <span class="k">import</span> <span class="n">load</span>
<span class="kn">from</span> <span class="nn">pyrocko.trace</span> <span class="k">import</span> <span class="n">MisfitSetup</span>

<span class="n">setup</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;my_misfit_setup.txt&#39;</span><span class="p">)</span>

<span class="c1"># now, we can change for example only the domain:</span>
<span class="n">setup</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="s1">&#39;frequency_domain&#39;</span>

<span class="nb">print</span> <span class="n">setup</span>
</pre></div>
</div>
</div>
<div class="section" id="travel-time-table-interpolation">
<h2>Travel time table interpolation<a class="headerlink" href="#travel-time-table-interpolation" title="Permalink to this headline">¶</a></h2>
<p>This example demonstrates how to interpolate and query travel time tables.</p>
<dl class="docutils">
<dt>Classes covered in this example:</dt>
<dd><ul class="first last simple">
<li><code class="xref py py-class docutils literal"><span class="pre">pyrocko.spit.SPTree</span></code> (interpolation of travel time tables)</li>
<li><a class="reference internal" href="gf.html#pyrocko.gf.meta.TPDef" title="pyrocko.gf.meta.TPDef"><code class="xref py py-class docutils literal"><span class="pre">pyrocko.gf.meta.TPDef</span></code></a> (phase definitions)</li>
<li><a class="reference internal" href="gf.html#pyrocko.gf.meta.Timing" title="pyrocko.gf.meta.Timing"><code class="xref py py-class docutils literal"><span class="pre">pyrocko.gf.meta.Timing</span></code></a> (onset definition to query the travel
time tables)</li>
</ul>
</dd>
</dl>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">num</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">spit</span><span class="p">,</span> <span class="n">cake</span>
<span class="kn">from</span> <span class="nn">pyrocko.gf</span> <span class="k">import</span> <span class="n">meta</span>


<span class="c1"># Define a list of phases.</span>
<span class="n">phase_defs</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta</span><span class="o">.</span><span class="n">TPDef</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">definition</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">),</span>
              <span class="n">meta</span><span class="o">.</span><span class="n">TPDef</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">definition</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">)]</span>

<span class="c1"># Load a velocity model. In this example use the default AK135.</span>
<span class="n">mod</span> <span class="o">=</span> <span class="n">cake</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>

<span class="c1"># Time and space tolerance thresholds defining the accuracy of the</span>
<span class="c1"># :py:class:`pyrocko.spit.SPTree`.</span>
<span class="n">t_tolerance</span> <span class="o">=</span> <span class="mf">0.1</span>                           <span class="c1"># in seconds</span>
<span class="n">x_tolerance</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mf">100.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">))</span>       <span class="c1"># in meters</span>

<span class="c1"># Boundaries of the grid.</span>
<span class="n">xmin</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="n">xmax</span> <span class="o">=</span> <span class="mi">20000</span>
<span class="n">zmin</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="n">zmax</span> <span class="o">=</span> <span class="mi">11000</span>
<span class="n">x_bounds</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(((</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">),</span> <span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">)))</span>

<span class="c1"># In this example the receiver is located at the surface.</span>
<span class="n">receiver_depth</span> <span class="o">=</span> <span class="mf">0.</span>

<span class="n">interpolated_tts</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">phase_def</span> <span class="ow">in</span> <span class="n">phase_defs</span><span class="p">:</span>
    <span class="n">v_horizontal</span> <span class="o">=</span> <span class="n">phase_def</span><span class="o">.</span><span class="n">horizontal_velocities</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate arrival using source and receiver location</span>
<span class="sd">        defined by *args*. To be evaluated by the SPTree instance.&#39;&#39;&#39;</span>
        <span class="n">source_depth</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">args</span>

        <span class="n">t</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Calculate arrivals</span>
        <span class="n">rays</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">arrivals</span><span class="p">(</span>
            <span class="n">phases</span><span class="o">=</span><span class="n">phase_def</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
            <span class="n">distances</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">cake</span><span class="o">.</span><span class="n">m2d</span><span class="p">],</span>
            <span class="n">zstart</span><span class="o">=</span><span class="n">source_depth</span><span class="p">,</span>
            <span class="n">zstop</span><span class="o">=</span><span class="n">receiver_depth</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ray</span> <span class="ow">in</span> <span class="n">rays</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">v_horizontal</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="mf">1000.</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Creat a :py:class:`pyrocko.spit.SPTree` interpolator.</span>
    <span class="n">sptree</span> <span class="o">=</span> <span class="n">spit</span><span class="o">.</span><span class="n">SPTree</span><span class="p">(</span>
        <span class="n">f</span><span class="o">=</span><span class="n">evaluate</span><span class="p">,</span>
        <span class="n">ftol</span><span class="o">=</span><span class="n">t_tolerance</span><span class="p">,</span>
        <span class="n">xbounds</span><span class="o">=</span><span class="n">x_bounds</span><span class="p">,</span>
        <span class="n">xtols</span><span class="o">=</span><span class="n">x_tolerance</span><span class="p">)</span>

    <span class="c1"># Store the result in a dictionary which is later used to retrieve an</span>
    <span class="c1"># SPTree (value) for each phase_id (key).</span>
    <span class="n">interpolated_tts</span><span class="p">[</span><span class="n">phase_def</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">sptree</span>

    <span class="c1"># Dump the sptree for later reuse:</span>
    <span class="n">sptree</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;sptree_</span><span class="si">%s</span><span class="s1">.yaml&#39;</span> <span class="o">%</span> <span class="n">phase_def</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="c1"># Define a :py:class:`pyrocko.gf.meta.Timing` instance.</span>
<span class="n">timing</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span><span class="s1">&#39;first(p|P)&#39;</span><span class="p">)</span>


<span class="c1"># If only one interpolated onset is need at a time you can retrieve</span>
<span class="c1"># that value as follows:</span>
<span class="c1"># First argument has to be a function which takes a requested *phase_id*</span>
<span class="c1"># and returns the associated :py:class:`pyrocko.spit.SPTree` instance.</span>
<span class="c1"># Second argument is a tuple of distance and source depth.</span>
<span class="n">z_want</span> <span class="o">=</span> <span class="mf">5000.</span>
<span class="n">x_want</span> <span class="o">=</span> <span class="mf">2000.</span>
<span class="n">one_onset</span> <span class="o">=</span> <span class="n">timing</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">interpolated_tts</span><span class="p">[</span><span class="n">x</span><span class="p">],</span>
                            <span class="p">(</span><span class="n">z_want</span><span class="p">,</span> <span class="n">x_want</span><span class="p">))</span>
<span class="nb">print</span> <span class="s1">&#39;a single arrival: &#39;</span><span class="p">,</span> <span class="n">one_onset</span>


<span class="c1"># But if you have many locations for which you would like to calculate the</span>
<span class="c1"># onset time the following is the preferred way as it is much faster</span>
<span class="c1"># on large coordinate arrays.</span>
<span class="c1"># x_want is now an array of 10000 distances</span>
<span class="n">x_want</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>

<span class="c1"># Coords is set up of distances-depth-pairs</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">x_want</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">z_want</span><span class="p">,</span> <span class="n">x_want</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># *interpolate_many* then interpolates onset times for each of these</span>
<span class="c1"># pairs.</span>
<span class="n">tts</span> <span class="o">=</span> <span class="n">interpolated_tts</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">interpolate_many</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>

<span class="c1"># Plot distance vs. onset time</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_want</span><span class="p">,</span> <span class="n">tts</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="reference.html" title="Library Reference"
             >next</a> |</li>
        <li class="right" >
          <a href="fomosto.html" title="Fomosto Tutorial"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Pyrocko v0.3 Manual</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2016, The Pyrocko Developers. <img src="http://kinherd.org/pyrocko.png" width="5" height="5">
    </div>
  </body>
</html>