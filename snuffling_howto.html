

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Writing a Snuffling &mdash; Pyrocko v0.2 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Pyrocko v0.2 documentation"
          href="_static/opensearch.xml"/>
    <link rel="top" title="Pyrocko v0.2 documentation" href="index.html" />
    <link rel="next" title="Programming Examples" href="examples.html" />
    <link rel="prev" title="Snuffler" href="snuffler.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="examples.html" title="Programming Examples"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="snuffler.html" title="Snuffler"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Pyrocko v0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="writing-a-snuffling">
<h1>Writing a Snuffling<a class="headerlink" href="#writing-a-snuffling" title="Permalink to this headline">¶</a></h1>
<p>Snufflings are small Python scripts which extend the functionality of Snuffler. Snuffler looks into the directory <tt class="docutils literal"><span class="pre">$HOME/.snufflings</span></tt> for snufflings. Snufflings can be reloaded at run-time using the menu entry &#8216;Reload Snufflings&#8217; in the main menu of Snuffler - no need to restart Snuffler when a snuffling is modified or added.</p>
<div class="section" id="an-example-snuffling-to-show-earthquake-catalog-information-within-snuffler">
<h2>An example snuffling to show earthquake catalog information within Snuffler<a class="headerlink" href="#an-example-snuffling-to-show-earthquake-catalog-information-within-snuffler" title="Permalink to this headline">¶</a></h2>
<p>Put the following code into <tt class="docutils literal"><span class="pre">$HOME/.snufflings/geofon.py</span></tt>. It will add four items into the <em>Snufflings</em> sub-menu of Snuffler (<em>Get GEOFON events</em>, <em>Get GEOFON events (&gt; M6)</em>, ...). When one of these is selected by the user, the <a class="reference external" href="http://geofon.gfz-potsdam.de/eqinfo/form.php">GEOFON catalog</a> is queried for earthquake information for the time range visible in Snuffler. For each earthquake found, a marker is shown in the viewer.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pyrocko.snuffling</span> <span class="kn">import</span> <span class="n">Snuffling</span><span class="p">,</span> <span class="n">Param</span>
<span class="kn">from</span> <span class="nn">pyrocko.pile_viewer</span> <span class="kn">import</span> <span class="n">Marker</span><span class="p">,</span> <span class="n">EventMarker</span>
<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="kn">import</span> <span class="n">catalog</span>

<span class="k">class</span> <span class="nc">GeofonEvents</span><span class="p">(</span><span class="n">Snuffling</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get events from GEOFON catalog.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">magmin</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_magmin</span> <span class="o">=</span> <span class="n">magmin</span>
        <span class="n">Snuffling</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Customization of the snuffling.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_magmin</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s">&#39;Get GEOFON Events&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s">&#39;Get GEOFON Events (&gt; M </span><span class="si">%g</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_magmin</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Main work routine of the snuffling.&#39;&#39;&#39;</span>

        <span class="c"># get time range visible in viewer</span>
        <span class="n">viewer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_viewer</span><span class="p">()</span>
        <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">get_time_range</span><span class="p">()</span>

        <span class="c"># download event information from GEOFON web page</span>
        <span class="c"># 1) get list of event names</span>
        <span class="n">geofon</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">Geofon</span><span class="p">()</span>
        <span class="n">event_names</span> <span class="o">=</span> <span class="n">geofon</span><span class="o">.</span><span class="n">get_event_names</span><span class="p">(</span>
            <span class="n">time_range</span><span class="o">=</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span><span class="n">tmax</span><span class="p">),</span>
            <span class="n">magmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_magmin</span><span class="p">)</span>

        <span class="c"># 2) get event information and add a marker in the snuffler window</span>
        <span class="k">for</span> <span class="n">event_name</span> <span class="ow">in</span> <span class="n">event_names</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">geofon</span><span class="o">.</span><span class="n">get_event</span><span class="p">(</span><span class="n">event_name</span><span class="p">)</span>
            <span class="n">marker</span> <span class="o">=</span> <span class="n">EventMarker</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_markers</span><span class="p">([</span><span class="n">marker</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">__snufflings__</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Returns a list of snufflings to be exported by this module.&#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="p">[</span> <span class="n">GeofonEvents</span><span class="p">(),</span>
             <span class="n">GeofonEvents</span><span class="p">(</span><span class="n">magmin</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span>
             <span class="n">GeofonEvents</span><span class="p">(</span><span class="n">magmin</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
             <span class="n">GeofonEvents</span><span class="p">(</span><span class="n">magmin</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="p">]</span>
</pre></div>
</div>
<div class="section" id="how-it-works">
<h3>How it works<a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h3>
<p>Snuffler looks into the directory <tt class="docutils literal"><span class="pre">HOME/.snufflings</span></tt> for python scripts
(<tt class="docutils literal"><span class="pre">*.py</span></tt>). Within each of these it tries to query the function
<tt class="docutils literal"><span class="pre">__snufflings__()</span></tt> which should return a list of snuffling objects, which are
instances of a snuffling class. A custom snuffling class is created by
subclassing <a class="reference internal" href="snuffling.html#pyrocko.snuffling.Snuffling" title="pyrocko.snuffling.Snuffling"><tt class="xref py py-class docutils literal"><span class="pre">pyrocko.snuffling.Snuffling</span></tt></a>. Within the derived class implement
the methods <tt class="docutils literal"><span class="pre">setup()</span></tt> and <tt class="docutils literal"><span class="pre">call()</span></tt>. <tt class="docutils literal"><span class="pre">setup()</span></tt> is called during
initialization of the snuffling object, <tt class="docutils literal"><span class="pre">call()</span></tt> is called when the user
selects the menu entry. You may define several snuffling classes within one
snuffling source file. You may also return several instances of a single
snuffling class from the <tt class="docutils literal"><span class="pre">__snufflings__()</span></tt> function.</p>
<p>The <a class="reference internal" href="snuffling.html#pyrocko.snuffling.Snuffling" title="pyrocko.snuffling.Snuffling"><tt class="xref py py-class docutils literal"><span class="pre">pyrocko.snuffling.Snuffling</span></tt></a> base class documentation can also
be accessed with the command <tt class="docutils literal"><span class="pre">pydoc</span> <span class="pre">pyrocko.snuffling.Snuffling</span></tt> from the
shell. Example snufflings can be found in <a class="reference external" href="http://github.com/emolch/pyrocko/tree/master/pyrocko/snufflings">pyrocko/snufflings/</a>
in the pyrocko source code.</p>
</div>
</div>
<div class="section" id="more-examples">
<h2>More examples<a class="headerlink" href="#more-examples" title="Permalink to this headline">¶</a></h2>
<div class="section" id="print-minimum-maximum-and-peak-to-peak-amplitudes-to-the-terminal">
<h3>Print minimum, maximum, and peak-to-peak amplitudes to the terminal<a class="headerlink" href="#print-minimum-maximum-and-peak-to-peak-amplitudes-to-the-terminal" title="Permalink to this headline">¶</a></h3>
<p>This is a built-in snuffling of Snuffler. It serves here as a demonstration of how selected trace data can be accessed from within the snuffling.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pyrocko.snuffling</span> <span class="kn">import</span> <span class="n">Snuffling</span><span class="p">,</span> <span class="n">Param</span>
<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="kn">import</span> <span class="n">trace</span>

<span class="k">class</span> <span class="nc">MinMaxSnuffling</span><span class="p">(</span><span class="n">Snuffling</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Reports minimum, maximum, and peak-to-peak values of selected data.</span>
<span class="sd">To use it, use the picker tool to mark a region or select existing regions</span>
<span class="sd">and call this snuffling. The values are printed via standard output to the</span>
<span class="sd">termimal.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Customization of the snuffling.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s">&#39;Minimum Maximum Peak-To-Peak&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tinc</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Main work routine of the snuffling.&#39;&#39;&#39;</span>

        <span class="c"># to select a reasonable increment for the chopping, the smallest</span>
        <span class="c"># sampling interval in the pile is looked at. this is only done,</span>
        <span class="c"># the first time the snuffling is called.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tinc</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tinc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pile</span><span class="p">()</span><span class="o">.</span><span class="n">get_deltats</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">10000.</span>

        <span class="c"># the chopper yields lists of traces but for minmax() below, an iterator</span>
        <span class="c"># yielding single traces is needed; using a converter:</span>
        <span class="k">def</span> <span class="nf">iter_single_traces</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">traces</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chopper_selected_traces</span><span class="p">(</span><span class="n">tinc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tinc</span><span class="p">,</span> <span class="n">degap</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">tr</span>

        <span class="c"># the function minmax() in the trace module can get minima and maxima</span>
        <span class="c"># grouped by (network,station,location,channel):</span>
        <span class="n">mima</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">minmax</span><span class="p">(</span><span class="n">iter_single_traces</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">nslc</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mima</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">p2p</span> <span class="o">=</span> <span class="n">mima</span><span class="p">[</span><span class="n">nslc</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mima</span><span class="p">[</span><span class="n">nslc</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">: </span><span class="si">%12.5g</span><span class="s"> </span><span class="si">%12.5g</span><span class="s"> </span><span class="si">%12.5g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nslc</span> <span class="o">+</span> <span class="n">mima</span><span class="p">[</span><span class="n">nslc</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">p2p</span><span class="p">,))</span>

<span class="k">def</span> <span class="nf">__snufflings__</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Returns a list of snufflings to be exported by this module.&#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="p">[</span> <span class="n">MinMaxSnuffling</span><span class="p">()</span> <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="examples.html" title="Programming Examples"
             >next</a> |</li>
        <li class="right" >
          <a href="snuffler.html" title="Snuffler"
             >previous</a> |</li>
        <li><a href="index.html">Pyrocko v0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Sebastian Heimann.
    </div>
  </body>
</html>